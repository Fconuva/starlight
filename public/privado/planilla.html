<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilla de Evaluacion</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 15px; }
        .top-bar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 6px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .top-bar h1 { font-size: 22px; }
        .top-bar-right { display: flex; gap: 10px; }
        .btn-top { padding: 8px 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.3s; }
        .btn-top:hover { background: rgba(255,255,255,0.3); }
        .container { display: flex; gap: 15px; }
        .main { flex: 1; }
        .sidebar { width: 180px; }
        .card { background: white; border-radius: 6px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .card h3 { font-size: 13px; margin-bottom: 10px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 8px; }
        .card-btn { width: 100%; padding: 10px; margin-bottom: 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.3s; }
        .card-btn:hover { background: #764ba2; }
        .controls { background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px; display: flex; gap: 12px; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .controls label { font-weight: 600; font-size: 13px; }
        .controls select { padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .controls span { font-size: 11px; color: #666; }
        .table-wrapper { background: white; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); overflow: auto; max-height: 70vh; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #d0d0d0; padding: 8px; text-align: center; font-size: 12px; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        tbody tr:nth-child(even) { background: #fafafa; }
        tbody tr:hover { background: #e8f4fd; }
        .col-num { width: 40px; position: sticky; left: 0; background: #fff; z-index: 5; border-right: 2px solid #999; font-weight: bold; }
        .col-apellido-p { width: 120px; text-align: left; position: sticky; left: 40px; background: #fff; z-index: 5; }
        .col-apellido-m { width: 120px; text-align: left; position: sticky; left: 160px; background: #fff; z-index: 5; }
        .col-nombre { width: 140px; text-align: left; position: sticky; left: 280px; background: #fff; z-index: 5; border-right: 2px solid #999; }
        thead th.col-num, thead th.col-apellido-p, thead th.col-apellido-m, thead th.col-nombre { z-index: 15; }
        .task-header { min-width: 90px; }
        .task-subtitle { display: block; font-size: 10px; opacity: 0.85; margin-top: 2px; font-weight: normal; }
        input[type="checkbox"] { transform: scale(1.3); cursor: pointer; }
        input[type="text"] { padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; }
        .col-puntos { font-weight: bold; background: #f9f9f9; width: 50px; }
        .col-nota { font-weight: bold; background: #f9f9f9; width: 50px; }
        .col-acciones { width: 60px; }
        .btn-small { padding: 4px 8px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; margin: 0 2px; }
        .btn-small:hover { background: #2980b9; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .empty-state { padding: 40px; text-align: center; color: #999; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; max-width: 500px; width: 90%; }
        .modal-header { font-size: 16px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 12px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .modal-btn-primary { background: #667eea; color: white; }
        .modal-btn-primary:hover { background: #764ba2; }
        .modal-btn-cancel { background: #ddd; color: #333; }
        .modal-btn-cancel:hover { background: #bbb; }
        .close-btn { float: right; background: none; border: none; font-size: 20px; cursor: pointer; color: #999; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div>
            <h1>Planilla de Evaluacion</h1>
            <div id="docenteLabel" style="font-size: 12px; opacity: 0.9;"></div>
        </div>
        <div class="top-bar-right">
            <button class="btn-top" onclick="logout()">Cambiar Docente</button>
        </div>
    </div>

    <div class="container">
        <!-- SIDEBAR: BOTONES DE ACCIONES -->
        <div class="sidebar">
            <div class="card">
                <h3>Reportes</h3>
                <button class="card-btn" onclick="openReportModal('grupal')"><i class="fas fa-chart-bar"></i> Reporte Grupal</button>
                <button class="card-btn" onclick="openReportModal('individual')"><i class="fas fa-user-chart"></i> Reporte Individual</button>
            </div>
            <div class="card">
                <h3>Gestor</h3>
                <button class="card-btn" onclick="openAddStudentModal()"><i class="fas fa-user-plus"></i> Agregar Estudiante</button>
                <button class="card-btn" onclick="openAddTaskModal()"><i class="fas fa-tasks"></i> Agregar Tarea</button>
            </div>
        </div>

        <!-- MAIN: PLANILLA -->
        <div class="main">
            <div class="controls">
                <label>Curso:</label>
                <select id="courseSelect" onchange="loadPlanilla()">
                    <option value="">-- Seleccionar --</option>
                </select>
                <span id="meta" style="margin-left: auto;"></span>
            </div>

            <div class="table-wrapper">
                <table id="planillaTable">
                    <thead>
                        <tr>
                            <th class="col-num">N</th>
                            <th class="col-apellido-p">APELLIDO PATERNO</th>
                            <th class="col-apellido-m">APELLIDO MATERNO</th>
                            <th class="col-nombre">NOMBRE</th>
                            <th class="col-puntos">PUNTOS</th>
                            <th class="col-nota">NOTA</th>
                            <th class="col-acciones">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="planillaBody">
                        <tr><td colspan="7" class="empty-state">Seleccione un curso</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL: AGREGAR ESTUDIANTE -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('studentModal')">&times;</button>
            <div class="modal-header">Agregar Estudiante</div>
            <div class="form-group">
                <label>Apellido Paterno:</label>
                <input type="text" id="studentLastName1" placeholder="Ej: Garcia">
            </div>
            <div class="form-group">
                <label>Apellido Materno:</label>
                <input type="text" id="studentLastName2" placeholder="Ej: Lopez">
            </div>
            <div class="form-group">
                <label>Nombres:</label>
                <input type="text" id="studentFirstNames" placeholder="Ej: Carlos Juan">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="saveStudent()">Guardar</button>
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('studentModal')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: AGREGAR TAREA -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('taskModal')">&times;</button>
            <div class="modal-header">Agregar Tarea</div>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="taskName" placeholder="Ej: Tarea 1">
            </div>
            <div class="form-group">
                <label>Fecha:</label>
                <input type="date" id="taskDate">
            </div>
            <div class="form-group">
                <label>OA:</label>
                <select id="taskOA">
                    <option value="">Sin OA</option>
                    <option value="OA3">OA3</option>
                    <option value="OA5">OA5</option>
                    <option value="OA6">OA6</option>
                    <option value="OA11">OA11</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="saveTask()">Guardar</button>
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('taskModal')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: REPORTE -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('reportModal')">&times;</button>
            <div class="modal-header" id="reportTitle"></div>
            <div id="reportContent" style="max-height: 60vh; overflow-y: auto; font-size: 12px;"></div>
        </div>
    </div>

    <script>
        const DB_NAME = 'EvaluacionDB';
        let db, docenteActual = null, courseActual = null;

        window.addEventListener('load', async () => {
            docenteActual = localStorage.getItem('docenteActual') || sessionStorage.getItem('docenteActual');
            if (!docenteActual || !['1','2','3','4'].includes(docenteActual)) {
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('docenteLabel').textContent = 'Docente ' + docenteActual;
            await initDB();
            await loadCourses();
        });

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME + docenteActual, 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    ['courses', 'students', 'tasks', 'evaluations'].forEach(store => {
                        if (!db.objectStoreNames.contains(store)) db.createObjectStore(store, { keyPath: 'id', autoIncrement: true });
                    });
                };
            });
        }

        async function getAllData(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function addData(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function deleteData(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }

        async function updateData(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }

        async function getEvaluationsMap() {
            const evals = await getAllData('evaluations');
            const map = new Map();
            evals.forEach(ev => map.set(ev.taskId + ':' + ev.studentId, ev));
            return map;
        }

        async function upsertEvaluation(taskId, studentId, value) {
            const evals = await getAllData('evaluations');
            const existing = evals.find(e => e.taskId === taskId && e.studentId === studentId);
            if (existing) {
                existing.value = value;
                await updateData('evaluations', existing);
            } else {
                await addData('evaluations', { taskId, studentId, value });
            }
            loadPlanilla();
        }

        async function loadCourses() {
            const courses = await getAllData('courses');
            const select = document.getElementById('courseSelect');
            select.innerHTML = '<option value="">-- Seleccionar --</option>';
            courses.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name + ' (' + c.letter + '-' + c.type + ')';
                select.appendChild(opt);
            });
        }

        async function loadPlanilla() {
            courseActual = parseInt(document.getElementById('courseSelect').value);
            const tbody = document.getElementById('planillaBody');
            const meta = document.getElementById('meta');
            const tableHead = document.querySelector('#planillaTable thead tr');

            if (!courseActual) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Seleccione un curso</td></tr>';
                meta.textContent = '';
                return;
            }

            const [courses, students, tasks, evalMap] = await Promise.all([
                getAllData('courses'),
                getAllData('students'),
                getAllData('tasks'),
                getEvaluationsMap()
            ]);

            const course = courses.find(c => c.id === courseActual);
            const courseStudents = students.filter(s => s.courseId === courseActual).sort((a,b) => (a.number||0)-(b.number||0));
            const courseTasks = tasks.filter(t => t.courseId === courseActual);

            let headerHTML = '<th class="col-num">N</th><th class="col-apellido-p">APELLIDO PATERNO</th><th class="col-apellido-m">APELLIDO MATERNO</th><th class="col-nombre">NOMBRE</th>';
            courseTasks.forEach(t => {
                headerHTML += '<th class="task-header">' + t.name + '<span class="task-subtitle">' + (t.date||'') + ' ' + (t.oa||'') + '</span></th>';
            });
            headerHTML += '<th class="col-puntos">PUNTOS</th><th class="col-nota">NOTA</th><th class="col-acciones">ACCIONES</th>';
            tableHead.innerHTML = headerHTML;

            let bodyHTML = '';
            courseStudents.forEach(st => {
                const apellidos = (st.lastNames||'').trim().split(/\s+/);
                const paterno = apellidos[0] || '';
                const materno = apellidos.slice(1).join(' ') || '';
                let puntos = 0;

                bodyHTML += '<tr><td class="col-num">' + (st.number||'') + '</td>';
                bodyHTML += '<td class="col-apellido-p">' + paterno + '</td>';
                bodyHTML += '<td class="col-apellido-m">' + materno + '</td>';
                bodyHTML += '<td class="col-nombre">' + st.firstNames + '</td>';

                courseTasks.forEach(t => {
                    const existing = evalMap.get(t.id + ':' + st.id);
                    const checked = existing ? !!existing.value : false;
                    if (checked) puntos++;
                    bodyHTML += '<td><input type="checkbox" ' + (checked?'checked':'') + ' onchange="upsertEvaluation(' + t.id + ', ' + st.id + ', this.checked)"></td>';
                });

                const max = courseTasks.length || 1;
                const nota = max > 0 ? (1 + (puntos/max)*6).toFixed(1) : '1.0';
                bodyHTML += '<td class="col-puntos">' + puntos + '</td>';
                bodyHTML += '<td class="col-nota">' + nota + '</td>';
                bodyHTML += '<td class="col-acciones"><button class="btn-small btn-danger" onclick="deleteStudent(' + st.id + ')">Eliminar</button></td>';
                bodyHTML += '</tr>';
            });

            tbody.innerHTML = bodyHTML;
            meta.textContent = (course?.name||'') + ' - ' + courseStudents.length + ' estudiantes, ' + courseTasks.length + ' tareas';
        }

        function openAddStudentModal() {
            if (!courseActual) { alert('Seleccione un curso primero'); return; }
            document.getElementById('studentModal').classList.add('active');
        }

        async function saveStudent() {
            const lastNames = (document.getElementById('studentLastName1').value + ' ' + document.getElementById('studentLastName2').value).trim();
            const firstNames = document.getElementById('studentFirstNames').value;
            if (!lastNames || !firstNames) { alert('Completa todos los campos'); return; }

            const students = await getAllData('students');
            const courseStudents = students.filter(s => s.courseId === courseActual);
            const nextNumber = courseStudents.length + 1;

            await addData('students', {
                courseId: courseActual,
                number: nextNumber,
                lastNames,
                firstNames
            });

            closeModal('studentModal');
            document.getElementById('studentLastName1').value = '';
            document.getElementById('studentLastName2').value = '';
            document.getElementById('studentFirstNames').value = '';
            loadPlanilla();
        }

        async function deleteStudent(id) {
            if (confirm('Eliminar este estudiante?')) {
                await deleteData('students', id);
                loadPlanilla();
            }
        }

        function openAddTaskModal() {
            if (!courseActual) { alert('Seleccione un curso primero'); return; }
            document.getElementById('taskModal').classList.add('active');
        }

        async function saveTask() {
            const name = document.getElementById('taskName').value;
            const date = document.getElementById('taskDate').value;
            const oa = document.getElementById('taskOA').value;
            if (!name) { alert('Ingresa un nombre'); return; }

            await addData('tasks', {
                courseId: courseActual,
                name,
                date: date || '',
                oa: oa || '',
                gradeType: 'binary'
            });

            closeModal('taskModal');
            document.getElementById('taskName').value = '';
            document.getElementById('taskDate').value = '';
            document.getElementById('taskOA').value = '';
            loadPlanilla();
        }

        function openReportModal(type) {
            if (!courseActual) { alert('Seleccione un curso primero'); return; }
            document.getElementById('reportTitle').textContent = type === 'grupal' ? 'Reporte Grupal' : 'Reporte Individual';
            document.getElementById('reportModal').classList.add('active');
            loadReport(type);
        }

        async function loadReport(type) {
            const [courses, students, tasks, evalMap] = await Promise.all([
                getAllData('courses'),
                getAllData('students'),
                getAllData('tasks'),
                getEvaluationsMap()
            ]);

            const course = courses.find(c => c.id === courseActual);
            const courseStudents = students.filter(s => s.courseId === courseActual);
            const courseTasks = tasks.filter(t => t.courseId === courseActual);

            let html = '<strong>' + (course?.name||'') + '</strong><br><br>';

            if (type === 'grupal') {
                html += '<strong>Resumen del Curso:</strong><br>';
                html += 'Estudiantes: ' + courseStudents.length + '<br>';
                html += 'Tareas: ' + courseTasks.length + '<br><br>';
                html += '<strong>Tareas:</strong><br>';
                courseTasks.forEach(t => {
                    html += '- ' + t.name + ' (' + (t.date||'') + ') ' + (t.oa||'') + '<br>';
                });
            } else {
                html += '<strong>Seleccione un estudiante:</strong><br>';
                courseStudents.forEach(st => {
                    html += '<button class="card-btn" onclick="showStudentDetail(' + st.id + ')" style="margin:5px 0;text-align:left;">' + st.firstNames + ' ' + st.lastNames + '</button>';
                });
            }

            document.getElementById('reportContent').innerHTML = html;
        }

        async function showStudentDetail(studentId) {
            const [students, tasks, evalMap] = await Promise.all([
                getAllData('students'),
                getAllData('tasks'),
                getEvaluationsMap()
            ]);

            const student = students.find(s => s.id === studentId);
            const courseTasks = tasks.filter(t => t.courseId === courseActual);
            let html = '<strong>Estudiante: ' + student.firstNames + ' ' + student.lastNames + '</strong><br><br>';

            let puntos = 0;
            html += '<strong>Tareas:</strong><br>';
            courseTasks.forEach(t => {
                const existing = evalMap.get(t.id + ':' + studentId);
                const checked = existing ? !!existing.value : false;
                if (checked) puntos++;
                html += '- ' + t.name + ': ' + (checked ? 'Completado' : 'Pendiente') + '<br>';
            });

            const max = courseTasks.length || 1;
            const nota = max > 0 ? (1 + (puntos/max)*6).toFixed(1) : '1.0';
            html += '<br><strong>Puntos: ' + puntos + ' / Nota: ' + nota + '</strong>';

            document.getElementById('reportContent').innerHTML = html;
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function logout() {
            sessionStorage.removeItem('docenteActual');
            localStorage.removeItem('docenteActual');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>