<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Evaluación - Lenguaje y Literatura</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <nav>
                    <a onclick="showSection('gradebook')" class="nav-link active" data-section="gradebook"><i class="fas fa-table"></i> Planilla</a>
                    <a onclick="showSection('dashboard')" class="nav-link" data-section="dashboard"><i class="fas fa-chart-line"></i> Dashboard</a>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header h1 { font-size: 28px; margin-bottom: 5px; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 14px; opacity: 0.95; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; text-decoration: none; display: inline-block; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
                <!-- PLANILLA -->
                <div id="gradebook" class="section active">
                    <h2><i class="fas fa-table"></i> Planilla de Tareas</h2>
                    <div class="gradebook-controls">
                        <div class="form-group" style="margin: 0;">
                            <label>Seleccionar Curso:</label>
                            <select id="gradebookCourseSelect" onchange="renderGradebook()">
                                <option value="">-- Seleccionar curso --</option>
                            </select>
                        </div>
                        <span id="gradebookMeta" style="font-size: 12px; color: #555;"></span>
                    </div>
                    <div class="gradebook-wrapper">
                        <table class="gradebook-table" id="gradebookTable"></table>
                    </div>
                </div>
        .btn-success:hover { background: #229954; }
        .btn-danger { background: #e74c3c; color: white; }
                <div id="dashboard" class="section">
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
    .content { display: grid; grid-template-columns: 250px 1fr; gap: 20px; }
        .sidebar { background: white; padding: 20px; border-radius: 8px; height: fit-content; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .sidebar nav a { display: block; padding: 12px 15px; margin: 5px 0; background: #ecf0f1; color: #2c3e50; text-decoration: none; border-radius: 5px; transition: all 0.3s; cursor: pointer; }
        .sidebar nav a:hover, .sidebar nav a.active { background: #667eea; color: white; padding-left: 20px; }
        .main { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        form { background: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #667eea; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.3); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; font-size: 13px; }
        th { background: #f8f9fa; font-weight: 600; color: #2c3e50; }
        tr:hover { background: #f9f9f9; }
        .alert { padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 15px; }
        .modal-header h2 { margin: 0; color: #2c3e50; }
        .close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: #aaa; }
        .close-btn:hover { color: #000; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .badge-primary { background: #667eea; color: white; }
        .badge-success { background: #27ae60; color: white; }
        .badge-danger { background: #e74c3c; color: white; }
        .batch-import { background: #e8f4f8; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        h2 { margin-bottom: 20px; color: #2c3e50; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        h3 { margin-top: 20px; margin-bottom: 15px; color: #2c3e50; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: #f9f9f9; padding: 15px; border-radius: 5px; border-left: 4px solid #667eea; }
        .card h4 { margin-bottom: 10px; color: #2c3e50; }
        .rating-options { display: flex; gap: 10px; flex-wrap: wrap; }
        .rating-btn { padding: 8px 15px; border: 2px solid #ddd; border-radius: 5px; background: white; cursor: pointer; transition: all 0.3s; }
        .rating-btn.active { background: #667eea; color: white; border-color: #667eea; }
    .rating-btn:hover { border-color: #667eea; }

    /* Gradebook (planilla tipo Excel) */
    .gradebook-controls { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; }
    .gradebook-table { width: 100%; border-collapse: collapse; }
    .gradebook-table th, .gradebook-table td { border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-size: 13px; }
    .gradebook-table thead th { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; position: sticky; top: 0; z-index: 2; }
    .gradebook-student { text-align: left; white-space: nowrap; }
    .gradebook-fixed-col { position: sticky; left: 0; background: #fff; z-index: 1; }
    .gradebook-fixed-col-2 { position: sticky; left: 60px; background: #fff; z-index: 1; }
    .gradebook-fixed-col-3 { position: sticky; left: 220px; background: #fff; z-index: 1; }
    .gradebook-fixed-col-4 { position: sticky; left: 430px; background: #fff; z-index: 1; }
    .gradebook-wrapper { overflow: auto; max-width: 100%; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .task-subtitle { display: block; font-size: 11px; opacity: 0.9; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1><i class="fas fa-book"></i> Lenguaje y Literatura - 2° Medio</h1>
                <div class="header-actions">
                    <span id="docenteLabel"></span>
                    <span id="cursoLabel"></span>
                    <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cambiar Docente</button>
                </div>
            </div>
        </header>

        <div class="content">
            <div class="sidebar">
                <nav>
                    <a onclick="showSection('dashboard')" class="nav-link active" data-section="dashboard"><i class="fas fa-chart-line"></i> Dashboard</a>
                    <a onclick="showSection('courses')" class="nav-link" data-section="courses"><i class="fas fa-book"></i> Cursos</a>
                    <a onclick="showSection('students')" class="nav-link" data-section="students"><i class="fas fa-users"></i> Estudiantes</a>
                    <a onclick="showSection('tasks')" class="nav-link" data-section="tasks"><i class="fas fa-tasks"></i> Tareas</a>
                    <a onclick="showSection('evaluation')" class="nav-link" data-section="evaluation"><i class="fas fa-chart-bar"></i> Evaluación</a>
                    <a onclick="showSection('reports')" class="nav-link" data-section="reports"><i class="fas fa-file-pdf"></i> Reportes</a>
                </nav>
            </div>

            <div class="main">
                <!-- DASHBOARD -->
                <div id="dashboard" class="section active">
                    <h2><i class="fas fa-chart-line"></i> Dashboard</h2>
                    <div id="messages"></div>
                    <div class="grid-2">
                        <div class="card">
                            <h4>Cursos Activos</h4>
                            <div style="font-size: 36px; color: #667eea; font-weight: bold;" id="coursesCount">0</div>
                        </div>
                        <div class="card">
                            <h4>Estudiantes Total</h4>
                            <div style="font-size: 36px; color: #27ae60; font-weight: bold;" id="studentsCount">0</div>
                        </div>
                        <div class="card">
                            <h4>Tareas Creadas</h4>
                            <div style="font-size: 36px; color: #3498db; font-weight: bold;" id="tasksCount">0</div>
                        </div>
                        <div class="card">
                            <h4>OAs Disponibles</h4>
                            <div style="font-size: 36px; color: #e74c3c; font-weight: bold;" id="oasCount">4</div>
                        </div>
                    </div>
                </div>

                <!-- CURSOS -->
                <div id="courses" class="section">
                    <h2><i class="fas fa-book"></i> Gestión de Cursos</h2>
                    <button class="btn btn-primary" onclick="openCourseModal()"><i class="fas fa-plus"></i> Crear Curso</button>
                    <table id="coursesTable">
                        <thead>
                            <tr>
                                <th>Curso</th>
                                <th>Letra</th>
                                <th>Tipo</th>
                                <th>Período</th>
                                <th>Estudiantes</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="coursesBody"></tbody>
                    </table>
                </div>

                <!-- ESTUDIANTES -->
                <div id="students" class="section">
                    <h2><i class="fas fa-users"></i> Gestión de Estudiantes</h2>
                    <div class="form-group">
                        <label>Seleccionar Curso:</label>
                        <select id="studentCourseSelect" onchange="loadStudentsForCourse()">
                            <option value="">-- Seleccionar curso --</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openStudentModal()"><i class="fas fa-plus"></i> Agregar Estudiante</button>
                    <div class="batch-import">
                        <h4><i class="fas fa-upload"></i> Importación Masiva</h4>
                        <p style="font-size: 13px; margin-bottom: 10px;">Pega los nombres de estudiantes (uno por línea):</p>
                        <textarea id="batchStudentsText" placeholder="APELLIDO1 APELLIDO2 NOMBRE1 NOMBRE2&#10;APELLIDO1 APELLIDO2 NOMBRE1 NOMBRE2" style="height: 150px; font-family: monospace;"></textarea>
                        <button class="btn btn-success" onclick="batchImportStudents()"><i class="fas fa-check"></i> Importar</button>
                    </div>
                    <table id="studentsTable">
                        <thead>
                            <tr>
                                <th>Nº</th>
                                <th>Nombres</th>
                                <th>Apellidos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="studentsBody"></tbody>
                    </table>
                </div>

                <!-- TAREAS -->
                <div id="tasks" class="section">
                    <h2><i class="fas fa-tasks"></i> Gestión de Tareas</h2>
                    <div class="form-group">
                        <label>Seleccionar Curso:</label>
                        <select id="taskCourseSelect" onchange="loadTasksForCourse()">
                            <option value="">-- Seleccionar curso --</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openTaskModal()"><i class="fas fa-plus"></i> Crear Tarea</button>
                    <table id="tasksTable">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Fecha</th>
                                <th>OA</th>
                                <th>Tipo Calificación</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tasksBody"></tbody>
                    </table>
                </div>

                <!-- EVALUACIÓN -->
                <div id="evaluation" class="section">
                    <h2><i class="fas fa-chart-bar"></i> Registro de Evaluación</h2>
                    <div class="form-group">
                        <label>Seleccionar Tarea:</label>
                        <select id="evaluationTaskSelect" onchange="loadEvaluationForm()">
                            <option value="">-- Seleccionar tarea --</option>
                        </select>
                    </div>
                    <div id="evaluationForm"></div>
                </div>

                <!-- REPORTES -->
                <div id="reports" class="section">
                    <h2><i class="fas fa-file-pdf"></i> Reportes</h2>
                    <div class="grid-2">
                        <div class="card">
                            <h4>Por Curso</h4>
                            <select id="reportCourseSelect" onchange="loadCourseReports()">
                                <option value="">-- Seleccionar --</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateCourseReport()" style="margin-top: 10px; width: 100%;"><i class="fas fa-download"></i> Generar</button>
                        </div>
                        <div class="card">
                            <h4>Por Estudiante</h4>
                            <select id="reportStudentSelect" onchange="loadStudentReports()">
                                <option value="">-- Seleccionar --</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateStudentReport()" style="margin-top: 10px; width: 100%;"><i class="fas fa-download"></i> Generar</button>
                        </div>
                    </div>
                    <div id="reportsContent" style="margin-top: 30px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CREAR CURSO -->
    <div id="courseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crear Curso</h2>
                <button class="close-btn" onclick="closeModal('courseModal')">&times;</button>
            </div>
            <form onsubmit="saveCourse(event)">
                <div class="form-group">
                    <label>Nombre del Curso:</label>
                    <input type="text" id="courseName" placeholder="Ej: Segundo Medio" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Letra:</label>
                        <select id="courseLetter" required>
                            <option value="">Seleccionar</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                            <option value="E">E</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo:</label>
                        <select id="courseType" required>
                            <option value="">Seleccionar</option>
                            <option value="HC">HC (Humanista Científico)</option>
                            <option value="TP">TP (Técnico Profesional)</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Guardar</button>
            </form>
        </div>
    </div>

    <!-- MODAL: AGREGAR ESTUDIANTE -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Estudiante</h2>
                <button class="close-btn" onclick="closeModal('studentModal')">&times;</button>
            </div>
            <form onsubmit="saveStudent(event)">
                <div class="form-group">
                    <label>Apellidos:</label>
                    <input type="text" id="studentLastNames" required>
                </div>
                <div class="form-group">
                    <label>Nombres:</label>
                    <input type="text" id="studentFirstNames" required>
                </div>
                <button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Guardar</button>
            </form>
        </div>
    </div>

    <!-- MODAL: CREAR TAREA -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crear Tarea</h2>
                <button class="close-btn" onclick="closeModal('taskModal')">&times;</button>
            </div>
            <form onsubmit="saveTask(event)">
                <div class="form-group">
                    <label>Nombre de la Tarea:</label>
                    <input type="text" id="taskName" required>
                </div>
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="date" id="taskDate" required>
                </div>
                <div class="form-group">
                    <label>Objetivo de Aprendizaje (OA):</label>
                    <select id="taskOA" required onchange="showOADescription()">
                        <option value="">Seleccionar OA</option>
                        <option value="OA3">OA3: Analizar las narraciones leídas</option>
                        <option value="OA5">OA5: Analizar los textos dramáticos</option>
                        <option value="OA6">OA6: Comprender obras del Siglo de Oro</option>
                        <option value="OA11">OA11: Leer y comprender textos no literarios</option>
                    </select>
                    <div id="oaDescription" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 13px; display: none;"></div>
                </div>
                <div class="form-group">
                    <label>Indicadores (separados por comas):</label>
                    <textarea id="taskIndicators" placeholder="Indicador 1, Indicador 2, Indicador 3"></textarea>
                </div>
                <div class="form-group">
                    <label>Tipo de Calificación:</label>
                    <select id="taskGradeType" required>
                        <option value="">Seleccionar</option>
                        <option value="binary">Sistema Binario (Ticket/X)</option>
                        <option value="direct">Nota Directa (1-7)</option>
                        <option value="level">Nivel de Logro</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Crear Tarea</button>
            </form>
        </div>
    </div>

    <script>
        // ============ CONFIGURACIÓN GLOBAL ============
        const DB_NAME = 'EvaluacionDB';
        const DB_VERSION = 1;
        let db;
        let docenteActual = null;
        let cursoActual = null;

        // OAs de Unidad 4: Poder y Ambición (datos reales del programa)
        const OAS_UNIT4 = {
            OA3: {
                nombre: 'Analizar las narraciones leídas',
                descripcion: 'Analizar las narraciones leídas para enriquecer su comprensión',
                indicadores: [
                    'Analizan el planteamiento de los personajes de las narraciones leídas, considerando sus características, relaciones entre ellos, sus diálogos, mundo personal y social, y sus conflictos y motivaciones',
                    'Relacionan las creencias, prejuicios y estereotipos presentes en las narraciones leídas con la visión de mundo de su contexto de producción, el contexto actual y sus experiencias de lectura',
                    'Interpretan el sentido de los recursos narrativos y las relaciones de intertextualidad dadas en las narraciones leídas'
                ]
            },
            OA5: {
                nombre: 'Analizar los textos dramáticos',
                descripcion: 'Analizar los textos dramáticos leídos o vistos, para enriquecer su comprensión',
                indicadores: [
                    'Analizan el planteamiento y el desarrollo del conflicto dramático a lo largo de las acciones que componen las obras dramáticas',
                    'Infieren las características de los personajes de las obras dramáticas a partir de sus relaciones, motivaciones, conflictos, diálogos, y mundo personal y social',
                    'Interpretan el sentido de los elementos de la estructura externa, de la puesta en escena y de las relaciones intertextuales establecidas en las obras dramáticas leídas o vistas'
                ]
            },
            OA6: {
                nombre: 'Comprender obras del Siglo de Oro',
                descripcion: 'Comprender la relevancia de las obras del Siglo de Oro, considerando sus características y el contexto en el que se enmarcan',
                indicadores: [
                    'Interpretan obras del Siglo de Oro, considerando sus tópicos, características, y contexto de producción y recepción',
                    'Reflexionan críticamente en torno a la relevancia de las obras del Siglo de Oro, a partir del contexto de producción y la relación con su contexto de recepción y el mundo actual'
                ]
            },
            OA11: {
                nombre: 'Leer y comprender textos no literarios',
                descripcion: 'Leer y comprender textos no literarios para contextualizar y complementar las lecturas literarias realizadas en clases',
                indicadores: [
                    'Relacionan información de los textos leídos con las obras literarias revisadas',
                    'Fundamentan una opinión sobre las obras literarias leídas, a partir de las ideas de los textos no literarios'
                ]
            }
        };

        function getStorePrefix() { return `docente${docenteActual}_`; }
        function getStoreName(store) { return getStorePrefix() + store; }

        // ============ INICIALIZACIÓN ============
        window.addEventListener('load', async () => {
            try {
                docenteActual = localStorage.getItem('docenteActual') || sessionStorage.getItem('docenteActual');
                if (!docenteActual || !['1', '2', '3', '4'].includes(docenteActual)) {
                    window.location.href = 'index.html';
                    return;
                }
                document.getElementById('docenteLabel').textContent = `Docente ${docenteActual}`;
                await initDB();
                // Cargar opciones iniciales para la planilla (vista por defecto)
                await loadCourses();
                await loadGradebookCourses();
                showSection('gradebook');
                console.log(`✓ Sistema listo para Docente ${docenteActual}`);
            } catch (error) {
                showMessage('❌ Error al inicializar', 'danger');
                console.error(error);
            }
        });

        // ============ BASE DE DATOS ============
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME + docenteActual, 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    ['courses', 'students', 'tasks', 'evaluations'].forEach(store => {
                        if (!db.objectStoreNames.contains(store)) {
                            db.createObjectStore(store, { keyPath: 'id', autoIncrement: true });
                        }
                    });
                };
            });
        }

        async function addData(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function getAllData(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function deleteData(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }

        async function updateData(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        // ============ EVALUACIONES (HELPERS) ============
        async function getEvaluationsMap() {
            const evals = await getAllData('evaluations');
            const map = new Map();
            for (const ev of evals) {
                map.set(`${ev.taskId}:${ev.studentId}`, ev);
            }
            return map;
        }

        async function upsertEvaluation(taskId, studentId, value) {
            const evals = await getAllData('evaluations');
            const existing = evals.find(e => e.taskId === taskId && e.studentId === studentId);
            if (existing) {
                existing.value = value;
                await updateData('evaluations', existing);
            } else {
                await addData('evaluations', { taskId, studentId, value });
            }
        }

        // ============ UI ============
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelector(`[data-section="${id}"]`).classList.add('active');
            
            if (id === 'dashboard') updateDashboard();
            else if (id === 'courses') loadCourses();
            else if (id === 'students') loadStudentCourses();
            else if (id === 'tasks') loadTaskCourses();
            else if (id === 'evaluation') loadEvaluationTasks();
            else if (id === 'reports') loadReportOptions();
            else if (id === 'gradebook') { loadGradebookCourses(); renderGradebook(); }
        }

        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `alert alert-${type}`;
            messageEl.textContent = message;
            messagesDiv.appendChild(messageEl);
            setTimeout(() => messageEl.remove(), 4000);
        }

        function openCourseModal() { document.getElementById('courseModal').classList.add('active'); }
        function openStudentModal() { document.getElementById('studentModal').classList.add('active'); }
        function openTaskModal() { document.getElementById('taskModal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // ============ DASHBOARD ============
        async function updateDashboard() {
            const courses = await getAllData('courses');
            const students = await getAllData('students');
            const tasks = await getAllData('tasks');
            document.getElementById('coursesCount').textContent = courses.length;
            document.getElementById('studentsCount').textContent = students.length;
            document.getElementById('tasksCount').textContent = tasks.length;
        }

        // ============ CURSOS ============
        async function saveCourse(e) {
            e.preventDefault();
            const course = {
                name: document.getElementById('courseName').value,
                letter: document.getElementById('courseLetter').value,
                type: document.getElementById('courseType').value,
                year: 2025,
                semester: 2,
                createdAt: new Date().toISOString()
            };
            await addData('courses', course);
            closeModal('courseModal');
            document.getElementById('courseForm').reset();
            loadCourses();
            showMessage('✓ Curso creado', 'success');
        }

        async function loadCourses() {
            const courses = await getAllData('courses');
            const tbody = document.getElementById('coursesBody');
            tbody.innerHTML = '';
            for (const course of courses) {
                const students = await getAllData('students');
                const count = students.filter(s => s.courseId === course.id).length;
                tbody.innerHTML += `<tr>
                    <td><strong>${course.name}</strong></td>
                    <td><span class="badge badge-primary">${course.letter}</span></td>
                    <td>${course.type}</td>
                    <td>2°-S2-2025</td>
                    <td>${count}</td>
                    <td><button class="btn btn-danger btn-small" onclick="deleteCourse(${course.id})"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            }
            // Actualizar selects
            const courseSelects = ['studentCourseSelect', 'taskCourseSelect', 'reportCourseSelect'];
            for (const selectId of courseSelects) {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Seleccionar --</option>';
                for (const course of courses) {
                    const opt = document.createElement('option');
                    opt.value = course.id;
                    opt.textContent = `${course.name} (${course.letter}-${course.type})`;
                    select.appendChild(opt);
                }
                select.value = currentValue;
            }
        }

        async function deleteCourse(id) {
            if (confirm('¿Eliminar este curso?')) {
                await deleteData('courses', id);
                loadCourses();
                showMessage('✓ Curso eliminado', 'success');
            }
        }

        // ============ ESTUDIANTES ============
        async function loadStudentCourses() {
            const courses = await getAllData('courses');
            const select = document.getElementById('studentCourseSelect');
            select.innerHTML = '<option value="">-- Seleccionar --</option>';
            for (const course of courses) {
                const opt = document.createElement('option');
                opt.value = course.id;
                opt.textContent = `${course.name} (${course.letter})`;
                select.appendChild(opt);
            }
        }

        async function loadStudentsForCourse() {
            const courseId = parseInt(document.getElementById('studentCourseSelect').value);
            if (!courseId) return;
            cursoActual = courseId;
            const students = await getAllData('students');
            const filtered = students.filter(s => s.courseId === courseId).sort((a, b) => (a.number || 0) - (b.number || 0));
            const tbody = document.getElementById('studentsBody');
            tbody.innerHTML = '';
            for (const student of filtered) {
                tbody.innerHTML += `<tr>
                    <td>${student.number || '-'}</td>
                    <td>${student.firstNames}</td>
                    <td>${student.lastNames}</td>
                    <td><button class="btn btn-danger btn-small" onclick="deleteStudent(${student.id})"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            }
        }

        async function saveStudent(e) {
            e.preventDefault();
            if (!cursoActual) {
                showMessage('❌ Selecciona un curso', 'danger');
                return;
            }
            const students = await getAllData('students');
            const courseStudents = students.filter(s => s.courseId === cursoActual);
            const nextNumber = courseStudents.length + 1;
            const student = {
                courseId: cursoActual,
                number: nextNumber,
                lastNames: document.getElementById('studentLastNames').value,
                firstNames: document.getElementById('studentFirstNames').value,
                createdAt: new Date().toISOString()
            };
            await addData('students', student);
            closeModal('studentModal');
            document.getElementById('studentForm').reset();
            loadStudentsForCourse();
            showMessage('✓ Estudiante agregado', 'success');
        }

        async function batchImportStudents() {
            if (!cursoActual) {
                showMessage('❌ Selecciona un curso', 'danger');
                return;
            }
            const text = document.getElementById('batchStudentsText').value;
            const lines = text.split('\n').filter(l => l.trim());
            const students = await getAllData('students');
            const courseStudents = students.filter(s => s.courseId === cursoActual);
            let startNumber = courseStudents.length + 1;
            for (const line of lines) {
                const parts = line.trim().split(/\s+/);
                if (parts.length < 2) continue;
                const lastNames = parts.slice(0, -1).join(' ');
                const firstNames = parts[parts.length - 1];
                await addData('students', {
                    courseId: cursoActual,
                    number: startNumber++,
                    lastNames,
                    firstNames,
                    createdAt: new Date().toISOString()
                });
            }
            document.getElementById('batchStudentsText').value = '';
            loadStudentsForCourse();
            showMessage(`✓ ${lines.length} estudiantes importados`, 'success');
        }

        async function deleteStudent(id) {
            if (confirm('¿Eliminar?')) {
                await deleteData('students', id);
                loadStudentsForCourse();
                showMessage('✓ Eliminado', 'success');
            }
        }

        // ============ TAREAS ============
        async function loadTaskCourses() {
            const courses = await getAllData('courses');
            const select = document.getElementById('taskCourseSelect');
            select.innerHTML = '<option value="">-- Seleccionar --</option>';
            for (const course of courses) {
                const opt = document.createElement('option');
                opt.value = course.id;
                opt.textContent = `${course.name} (${course.letter})`;
                select.appendChild(opt);
            }
        }

        async function loadTasksForCourse() {
            const courseId = parseInt(document.getElementById('taskCourseSelect').value);
            if (!courseId) return;
            const tasks = await getAllData('tasks');
            const filtered = tasks.filter(t => t.courseId === courseId);
            const tbody = document.getElementById('tasksBody');
            tbody.innerHTML = '';
            for (const task of filtered) {
                tbody.innerHTML += `<tr>
                    <td><strong>${task.name}</strong></td>
                    <td>${task.date}</td>
                    <td><span class="badge badge-primary">${task.oa}</span></td>
                    <td>${task.gradeType}</td>
                    <td><button class="btn btn-danger btn-small" onclick="deleteTask(${task.id})"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            }
        }

        async function saveTask(e) {
            e.preventDefault();
            const taskCourseSelect = document.getElementById('taskCourseSelect').value;
            if (!taskCourseSelect) {
                showMessage('❌ Selecciona un curso', 'danger');
                return;
            }
            const selectedOA = document.getElementById('taskOA').value;
            const oaData = OAS_UNIT4[selectedOA];
            const task = {
                courseId: parseInt(taskCourseSelect),
                name: document.getElementById('taskName').value,
                date: document.getElementById('taskDate').value,
                oa: selectedOA,
                oaName: oaData.nombre,
                oaDescription: oaData.descripcion,
                indicators: oaData.indicadores,
                customIndicators: document.getElementById('taskIndicators').value.split(',').map(i => i.trim()).filter(i => i.length > 0),
                gradeType: document.getElementById('taskGradeType').value,
                createdAt: new Date().toISOString()
            };
            await addData('tasks', task);
            closeModal('taskModal');
            loadTasksForCourse();
            showMessage('✓ Tarea creada', 'success');
        }

        function showOADescription() {
            const selectedOA = document.getElementById('taskOA').value;
            const descDiv = document.getElementById('oaDescription');
            if (!selectedOA || !OAS_UNIT4[selectedOA]) {
                descDiv.style.display = 'none';
                return;
            }
            const oa = OAS_UNIT4[selectedOA];
            let html = `<strong>${oa.nombre}</strong><br><em>${oa.descripcion}</em><br><strong style="margin-top: 8px; display: block;">Indicadores:</strong><ul style="margin: 5px 0 0 20px;">`;
            for (const ind of oa.indicadores) {
                html += `<li style="font-size: 12px; margin: 3px 0;">${ind}</li>`;
            }
            html += '</ul>';
            descDiv.innerHTML = html;
            descDiv.style.display = 'block';
        }

        async function deleteTask(id) {
            if (confirm('¿Eliminar?')) {
                await deleteData('tasks', id);
                loadTasksForCourse();
                showMessage('✓ Eliminado', 'success');
            }
        }

        // ============ EVALUACIÓN ============
        async function loadEvaluationTasks() {
            const tasks = await getAllData('tasks');
            const select = document.getElementById('evaluationTaskSelect');
            select.innerHTML = '<option value="">-- Seleccionar tarea --</option>';
            for (const task of tasks) {
                const opt = document.createElement('option');
                opt.value = task.id;
                opt.textContent = `${task.name} (${task.oa})`;
                select.appendChild(opt);
            }
        }

        async function loadEvaluationForm() {
            const taskId = parseInt(document.getElementById('evaluationTaskSelect').value);
            if (!taskId) return;
            const tasks = await getAllData('tasks');
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            const students = await getAllData('students');
            const courseStudents = students.filter(s => s.courseId === task.courseId).sort((a, b) => (a.number || 0) - (b.number || 0));
            let html = `<h3>${task.name}</h3><table><thead><tr><th>Estudiante</th>`;
            
            if (task.gradeType === 'binary') {
                html += '<th>Ticket</th><th>X</th></tr></thead><tbody>';
                for (const student of courseStudents) {
                    html += `<tr><td>${student.number} - ${student.firstNames} ${student.lastNames}</td>
                        <td><input type="radio" name="eval_${student.id}" value="ticket"></td>
                        <td><input type="radio" name="eval_${student.id}" value="x"></td></tr>`;
                }
            } else if (task.gradeType === 'direct') {
                html += '<th>Nota (1-7)</th></tr></thead><tbody>';
                for (const student of courseStudents) {
                    html += `<tr><td>${student.number} - ${student.firstNames} ${student.lastNames}</td>
                        <td><input type="number" min="1" max="7" step="0.1" id="grade_${student.id}" style="width: 60px;"></td></tr>`;
                }
            } else if (task.gradeType === 'level') {
                html += '<th>Nivel</th></tr></thead><tbody>';
                for (const student of courseStudents) {
                    html += `<tr><td>${student.number} - ${student.firstNames} ${student.lastNames}</td>
                        <td><select id="grade_${student.id}">
                            <option value="">-</option>
                            <option value="L">Logrado</option>
                            <option value="ML">Medianamente Logrado</option>
                            <option value="PL">Por Lograr</option>
                        </select></td></tr>`;
                }
            }
            html += '</tbody></table><button class="btn btn-success" onclick="saveEvaluation(' + taskId + ')"><i class="fas fa-save"></i> Guardar</button>';
            document.getElementById('evaluationForm').innerHTML = html;
        }

        async function saveEvaluation(taskId) {
            showMessage('✓ Evaluaciones guardadas', 'success');
        }

        // ============ PLANILLA (GRADEBOOK) ============
        async function loadGradebookCourses() {
            const courses = await getAllData('courses');
            const select = document.getElementById('gradebookCourseSelect');
            if (!select) return;
            const current = select.value;
            select.innerHTML = '<option value="">-- Seleccionar curso --</option>';
            for (const course of courses) {
                const opt = document.createElement('option');
                opt.value = course.id;
                opt.textContent = `${course.name} (${course.letter}-${course.type})`;
                select.appendChild(opt);
            }
            if (current) select.value = current;
        }

        async function renderGradebook() {
            const table = document.getElementById('gradebookTable');
            const meta = document.getElementById('gradebookMeta');
            if (!table) return;
            const courseId = parseInt(document.getElementById('gradebookCourseSelect').value);
            if (!courseId) { table.innerHTML = '<thead><tr><th>Seleccione un curso</th></tr></thead>'; return; }

            const [courses, students, tasks, evalMap] = await Promise.all([
                getAllData('courses'),
                getAllData('students'),
                getAllData('tasks'),
                getEvaluationsMap()
            ]);
            const course = courses.find(c => c.id === courseId);
            const courseStudents = students.filter(s => s.courseId === courseId).sort((a,b) => (a.number||0)-(b.number||0));
            const courseTasks = tasks.filter(t => t.courseId === courseId);
            // Header
            let thead = '<thead><tr>'+
                '<th class="gradebook-fixed-col">N°</th>'+
                '<th class="gradebook-fixed-col-2">Apellido Paterno</th>'+
                '<th class="gradebook-fixed-col-3">Apellido Materno</th>'+
                '<th class="gradebook-fixed-col-4">Nombre</th>';
            for (const t of courseTasks) {
                thead += `<th>${t.name}<span class="task-subtitle">${t.date || ''} ${t.oa ? '('+t.oa+')':''}</span></th>`;
            }
            thead += '<th>PUNTOS</th><th>NOTA</th><th>Acciones</th></tr></thead>';

            // Body
            let tbody = '<tbody>';
            for (const st of courseStudents) {
                const apellidos = (st.lastNames||'').trim().split(/\s+/);
                const paterno = apellidos[0] || '';
                const materno = apellidos.slice(1).join(' ') || '';
                let puntos = 0, total = 0;
                tbody += `<tr>`+
                    `<td class="gradebook-fixed-col">${st.number || ''}</td>`+
                    `<td class="gradebook-fixed-col-2">${paterno}</td>`+
                    `<td class="gradebook-fixed-col-3">${materno}</td>`+
                    `<td class="gradebook-fixed-col-4 gradebook-student">${st.firstNames}</td>`;

                for (const t of courseTasks) {
                    let cell = '';
                    if (t.gradeType === 'direct') {
                        const existing = evalMap.get(`${t.id}:${st.id}`);
                        const val = existing ? (existing.value ?? '') : '';
                        total += 1;
                        puntos += (val && !isNaN(val)) ? Number(val) : 0; // para promedio si fuese necesario
                        cell = `<input type="number" min="1" max="7" step="0.1" value="${val}" onchange="upsertEvaluation(${t.id}, ${st.id}, this.value)">`;
                    } else if (t.gradeType === 'level') {
                        const existing = evalMap.get(`${t.id}:${st.id}`);
                        const val = existing ? (existing.value || '') : '';
                        total += 1;
                        cell = `<select onchange="upsertEvaluation(${t.id}, ${st.id}, this.value)">`+
                            `<option value="" ${val===''?'selected':''}>-</option>`+
                            `<option value="L" ${val==='L'?'selected':''}>L</option>`+
                            `<option value="ML" ${val==='ML'?'selected':''}>ML</option>`+
                            `<option value="PL" ${val==='PL'?'selected':''}>PL</option>`+
                            `</select>`;
                    } else { // binary por defecto
                        const existing = evalMap.get(`${t.id}:${st.id}`);
                        const checked = existing ? !!existing.value : false;
                        total += 1;
                        if (checked) puntos += 1;
                        cell = `<input type="checkbox" ${checked?'checked':''} onchange="upsertEvaluation(${t.id}, ${st.id}, this.checked)">`;
                    }
                    tbody += `<td>${cell}</td>`;
                }
                // Nota estimada para binario: escala 1-7
                const max = courseTasks.length || 1;
                const nota = (max>0) ? (1 + (puntos/max)*6) : 1;
                tbody += `<td>${puntos}</td><td>${nota.toFixed(1)}</td>`+
                         `<td><button class="btn btn-secondary btn-small" onclick="/* futuro: acciones */void(0)"><i class="fas fa-edit"></i></button></td>`+
                         `</tr>`;
            }
            tbody += '</tbody>';

            table.innerHTML = thead + tbody;
            meta.textContent = `${course?.name || ''} ${course?.letter ? '('+course.letter+')':''} — ${courseStudents.length} estudiantes, ${courseTasks.length} tareas`;
        }

        // ============ REPORTES ============
        async function loadReportOptions() {
            const courses = await getAllData('courses');
            const students = await getAllData('students');
            
            const courseSelect = document.getElementById('reportCourseSelect');
            courseSelect.innerHTML = '<option value="">-- Seleccionar --</option>';
            for (const course of courses) {
                const opt = document.createElement('option');
                opt.value = course.id;
                opt.textContent = `${course.name}`;
                courseSelect.appendChild(opt);
            }

            const studentSelect = document.getElementById('reportStudentSelect');
            studentSelect.innerHTML = '<option value="">-- Seleccionar --</option>';
            for (const student of students) {
                const opt = document.createElement('option');
                opt.value = student.id;
                opt.textContent = `${student.number} - ${student.firstNames} ${student.lastNames}`;
                studentSelect.appendChild(opt);
            }
        }

        async function loadCourseReports() {
            await generateCourseReport();
        }

        async function loadStudentReports() {
            await generateStudentReport();
        }

        async function generateCourseReport() {
            const courseId = parseInt(document.getElementById('reportCourseSelect').value);
            if (!courseId) return;
            const courses = await getAllData('courses');
            const course = courses.find(c => c.id === courseId);
            const students = await getAllData('students');
            const courseStudents = students.filter(s => s.courseId === courseId).sort((a, b) => (a.number || 0) - (b.number || 0));
            const tasks = await getAllData('tasks');
            const courseTasks = tasks.filter(t => t.courseId === courseId);
            
            let html = `<h3>📊 Reporte del Curso: ${course.name} (${course.letter}-${course.type})</h3>`;
            html += `<div class="card" style="margin-bottom: 20px;">`;
            html += `<strong>Información General:</strong><br>`;
            html += `Período: 2025 - Segundo Semestre<br>`;
            html += `Estudiantes: ${courseStudents.length}<br>`;
            html += `Tareas creadas: ${courseTasks.length}<br>`;
            
            const oasUsed = new Set();
            courseTasks.forEach(t => oasUsed.add(t.oa));
            html += `OAs trabajados: ${Array.from(oasUsed).join(', ') || 'Ninguno aún'}<br>`;
            html += `</div>`;
            
            if (courseTasks.length > 0) {
                html += `<h4>📖 Tareas por OA:</h4>`;
                const oaGroups = {};
                courseTasks.forEach(task => {
                    if (!oaGroups[task.oa]) oaGroups[task.oa] = [];
                    oaGroups[task.oa].push(task);
                });
                for (const [oa, oaTasks] of Object.entries(oaGroups)) {
                    const oaData = OAs.find(o => o.id === oa);
                    if (oaData) {
                        html += `<div class="card"><strong>${oa}: ${oaData.name}</strong><br>`;
                        html += `<em style="font-size: 12px; color: #666;">Descripción: ${oaData.desc}</em><br>`;
                        html += `<strong>Tareas:</strong><ul style="margin: 5px 0 0 20px; font-size: 13px;">`;
                        for (const task of oaTasks) {
                            html += `<li>${task.name} (${task.date}) - Tipo: ${task.gradeType}</li>`;
                        }
                        html += `</ul></div>`;
                    }
                }
            }
            
            html += `<h4>👥 Estudiantes (${courseStudents.length}):</h4><ul style="font-size: 13px;">`;
            for (const student of courseStudents) {
                html += `<li>${String(student.number).padStart(2, '0')}. ${student.firstNames} ${student.lastNames}</li>`;
            }
            html += `</ul>`;
            
            document.getElementById('reportsContent').innerHTML = html;
        }

        async function generateStudentReport() {
            const studentId = parseInt(document.getElementById('reportStudentSelect').value);
            if (!studentId) return;
            const students = await getAllData('students');
            const student = students.find(s => s.id === studentId);
            const tasks = await getAllData('tasks');
            const studentTasks = tasks.filter(t => t.courseId === student.courseId);
            const courses = await getAllData('courses');
            const course = courses.find(c => c.id === student.courseId);
            
            let html = `<h3>📋 Reporte Individual: ${student.firstNames} ${student.lastNames}</h3>`;
            html += `<div class="card" style="margin-bottom: 20px;">`;
            html += `<strong>Información del Estudiante:</strong><br>`;
            html += `Número de lista: ${String(student.number).padStart(2, '0')}<br>`;
            html += `Curso: ${course.name} (${course.letter}-${course.type})<br>`;
            html += `Período: 2025 - Segundo Semestre<br>`;
            html += `</div>`;
            
            if (studentTasks.length > 0) {
                html += `<h4>📚 OAs en el Curso (${studentTasks.length} tareas):</h4>`;
                const oaGroups = {};
                studentTasks.forEach(task => {
                    if (!oaGroups[task.oa]) oaGroups[task.oa] = [];
                    oaGroups[task.oa].push(task);
                });
                
                for (const [oa, oaTasks] of Object.entries(oaGroups)) {
                    const oaData = OAs.find(o => o.id === oa);
                    if (oaData) {
                        html += `<div class="card">`;
                        html += `<strong>${oa}: ${oaData.name}</strong><br>`;
                        html += `<em style="font-size: 12px; color: #666;">${oaData.desc}</em><br>`;
                        html += `<strong>Indicadores esperados:</strong><ul style="margin: 5px 0 0 20px; font-size: 13px;">`;
                        for (const ind of oaData.indicators) {
                            html += `<li>${ind}</li>`;
                        }
                        html += `</ul><strong style="margin-top: 10px; display: block;">Tareas asignadas:</strong><ul style="margin: 5px 0 0 20px; font-size: 13px;">`;
                        for (const task of oaTasks) {
                            html += `<li>${task.name} (${task.date})</li>`;
                        }
                        html += `</ul></div>`;
                    }
                }
            } else {
                html += `<div class="alert alert-info">No hay tareas aún en este curso.</div>`;
            }
            
            document.getElementById('reportsContent').innerHTML = html;
        }

        // ============ UTILITY ============
        function logout() {
            sessionStorage.removeItem('docenteActual');
            localStorage.removeItem('docenteActual');
            window.location.href = 'index.html';
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = (event) => {
            ['courseModal', 'studentModal', 'taskModal'].forEach(id => {
                const modal = document.getElementById(id);
                if (event.target === modal) modal.classList.remove('active');
            });
        };
    </script>
</body>
</html>
