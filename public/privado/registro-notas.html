<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4F46E5">
    <title>Registro de Notas - Sistema de Evaluación</title>
    <script>
        // Configuración de Tailwind para producción
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Librerías para generación de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
        .student-row:hover {
            background-color: #f3f4f6;
        }
        .student-row.retired {
            background-color: #f9fafb !important;
            opacity: 0.6;
        }
        .student-row.retired td {
            color: #9ca3af !important;
            text-decoration: line-through;
        }
        .editable {
            cursor: pointer;
            transition: all 0.2s;
        }
        .editable:hover {
            background-color: #dbeafe;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            
            /* Estilos de impresión para informes profesionales */
            body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
                background: white !important;
            }
            
            /* Preservar gradientes y colores */
            .bg-gradient-to-r, .bg-gradient-to-br, .bg-gradient-to-br.from-green-50,
            .bg-gradient-to-br.from-orange-50, .bg-gradient-to-br.from-blue-50,
            .bg-gradient-to-r.from-green-100 {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            
            /* Optimizar gráficos */
            canvas {
                max-height: 300px !important;
                page-break-inside: avoid;
            }
            
            /* Mejorar bordes y sombras */
            .shadow-lg, .shadow-md, .shadow-sm {
                box-shadow: none !important;
                border: 1px solid #d1d5db !important;
            }
            
            /* Control de saltos de página */
            h3, h4, h5 {
                page-break-after: avoid;
                page-break-inside: avoid;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            /* Secciones completas */
            .print\\:break-inside-avoid {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            /* Espaciado optimizado */
            .space-y-6 > * {
                margin-bottom: 0.75rem !important;
            }
            
            /* Textarea en modo lectura para PDF - SIN SCROLL, ALTURA AUTOMÃTICA */
            textarea {
                border: 1px solid #e5e7eb !important;
                resize: none !important;
                height: auto !important;
                min-height: 0 !important;
                max-height: none !important;
                overflow: visible !important;
                overflow-y: visible !important;
                background: white !important;
                padding: 1rem !important;
                font-size: 10pt !important;
                line-height: 1.7 !important;
                font-family: 'Georgia', 'Times New Roman', serif !important;
                white-space: pre-wrap !important;
                word-wrap: break-word !important;
                display: block !important;
                page-break-inside: avoid !important;
                orphans: 3 !important;
                widows: 3 !important;
            }
            
            /* Contenedor de retroalimentación - EVITAR CORTES */
            .bg-gradient-to-br.from-blue-50 {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin-bottom: 1rem !important;
            }
            
            /* Forzar que el contenido del textarea sea visible completo */
            textarea[id^="studentNotes_"] {
                page-break-inside: auto !important;
                break-inside: auto !important;
                min-height: fit-content !important;
            }
            
            /* Botones y elementos interactivos ocultos */
            button, .cursor-pointer {
                display: none !important;
            }
            
            /* Tarjetas de tareas */
            .grid.grid-cols-1 {
                display: block !important;
            }
            
            .grid.grid-cols-1 > * {
                margin-bottom: 0.5rem !important;
                page-break-inside: avoid;
            }
            
            /* Mejorar legibilidad */
            body, p, li, span, div {
                font-size: 11pt !important;
                line-height: 1.5 !important;
            }
            
            h3 {
                font-size: 18pt !important;
            }
            
            h4 {
                font-size: 14pt !important;
            }
            
            /* Encabezados con colores */
            .text-green-800, .text-green-700 {
                color: #15803d !important;
            }
            
            .text-orange-800, .text-orange-700 {
                color: #c2410c !important;
            }
            
            .text-blue-900, .text-blue-800 {
                color: #1e40af !important;
            }
            
            /* Fondos de tarjetas */
            .bg-green-500 {
                background-color: #22c55e !important;
            }
            
            .bg-orange-500 {
                background-color: #f97316 !important;
            }
            
            /* Bordes de colores */
            .border-green-500, .border-green-200, .border-green-300 {
                border-color: #22c55e !important;
            }
            
            .border-orange-500, .border-orange-200 {
                border-color: #f97316 !important;
            }
            
            .border-blue-200 {
                border-color: #93c5fd !important;
            }
            
            /* Márgenes de página */
            @page {
                margin: 1.5cm;
                size: letter;
            }
        }
        
        /* Estilos adicionales para tablas responsivas */
        .sticky {
            position: sticky;
            z-index: 10;
        }
        
        /* Animaciones para carga */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .space-y-6 > * {
            animation: fadeIn 0.5s ease-out;
        }
        /* Estilos para modales */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* ============================================
           OPTIMIZACIONES PARA MÃ“VIL (Android/iOS)
           ============================================ */
        
        /* Mejoras generales de touch */
        * {
            -webkit-tap-highlight-color: rgba(79, 70, 229, 0.2);
            -webkit-touch-callout: none;
        }
        
        button, a, input, select, textarea {
            -webkit-tap-highlight-color: rgba(79, 70, 229, 0.3);
        }
        
        /* Scroll suave para iOS */
        body {
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
        }
        
        /* Prevenir zoom en inputs en iOS */
        input, select, textarea {
            font-size: 16px !important;
        }
        
        /* Optimización de tabla para móvil */
        @media (max-width: 768px) {
            /* Contenedor principal más ajustado */
            .container {
                padding: 0.5rem !important;
            }
            
            /* Navegación más compacta */
            nav {
                padding: 0.75rem !important;
            }
            
            nav h1 {
                font-size: 1rem !important;
            }
            
            nav button, nav a {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.875rem !important;
            }
            
            nav i {
                font-size: 0.875rem !important;
            }
            
            /* Botones de acción más grandes para touch */
            button {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Tabs más compactas */
            .tab-button {
                padding: 0.5rem 1rem !important;
                font-size: 0.875rem !important;
            }
            
            /* Tabla responsiva con scroll horizontal */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                position: relative;
            }
            
            table {
                min-width: 800px;
            }
            
            /* Hacer primera columna sticky en móvil */
            table thead th:first-child,
            table tbody td:first-child {
                position: sticky;
                left: 0;
                z-index: 5;
                background-color: #4F46E5;
            }
            
            table tbody td:first-child {
                background-color: white;
                font-weight: 600;
            }
            
            /* Checkboxes más grandes */
            input[type="checkbox"] {
                width: 1.25rem !important;
                height: 1.25rem !important;
                min-width: 1.25rem;
                min-height: 1.25rem;
            }
            
            /* Modales optimizados para móvil */
            .modal-content {
                width: 95% !important;
                max-width: 95% !important;
                margin: 2% auto !important;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Campos de formulario más grandes */
            input[type="text"],
            input[type="date"],
            input[type="number"],
            select,
            textarea {
                padding: 0.75rem !important;
                font-size: 16px !important;
            }
            
            /* Selector de curso más grande */
            #courseSelector {
                font-size: 1rem !important;
                padding: 0.75rem !important;
            }
            
            /* Estadísticas en columnas */
            .grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
            }
            
            /* Gráficos más pequeños */
            canvas {
                max-height: 250px !important;
            }
            
            /* Cards más compactas */
            .space-y-6 > * {
                margin-bottom: 1rem !important;
            }
            
            /* Textos más pequeños pero legibles */
            .text-sm {
                font-size: 0.875rem !important;
            }
            
            .text-xs {
                font-size: 0.75rem !important;
            }
            
            /* Padding reducido en cards */
            .p-6 {
                padding: 1rem !important;
            }
            
            .p-4 {
                padding: 0.75rem !important;
            }
            
            /* Mensajes flotantes más visibles */
            #temporaryMessage {
                bottom: 20px !important;
                left: 10px !important;
                right: 10px !important;
                width: auto !important;
                transform: none !important;
                font-size: 0.875rem !important;
            }
            
            /* Indicador de sincronización más pequeño */
            #syncIndicator {
                font-size: 0.75rem !important;
                padding: 0.5rem 0.75rem !important;
            }
            
            /* Botones de acción en fila cuando sea necesario */
            .flex.gap-3 {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .flex.gap-3 button {
                width: 100% !important;
            }
            
            /* Informes individuales optimizados */
            #individualReports {
                padding: 0.5rem !important;
            }
            
            /* Ocultar elementos menos importantes en móvil */
            .hidden-mobile {
                display: none !important;
            }
        }
        
        /* Optimizaciones específicas para tablets */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                padding: 1rem !important;
            }
            
            table {
                font-size: 0.875rem;
            }
            
            .grid-cols-3 {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
        }
        
        /* Mejoras para Safari iOS */
        @supports (-webkit-touch-callout: none) {
            /* Fix para el safe area en iPhone con notch */
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
            
            /* Prevenir el bounce effect en iOS */
            body {
                position: fixed;
                overflow: hidden;
                width: 100%;
                height: 100%;
            }
            
            #app-container {
                overflow-y: auto;
                height: 100vh;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Optimización para landscape en móvil */
        @media (max-width: 768px) and (orientation: landscape) {
            nav {
                padding: 0.5rem !important;
            }
            
            nav h1 {
                font-size: 0.875rem !important;
            }
            
            .modal-content {
                max-height: 85vh !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app-container">
    <!-- Auth Guard -->
    <script>
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>

    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-indigo-600 to-purple-600 shadow-lg no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="dashboard.html" class="text-white hover:text-gray-200">
                        <i class="fas fa-arrow-left mr-2"></i>Volver
                    </a>
                    <span class="text-2xl font-bold text-white">
                        <i class="fas fa-clipboard-list mr-2"></i>Registro de Notas - <span id="docenteNombre"></span>
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Indicador de modo colaborativo -->
                    <div class="text-white text-sm flex items-center bg-green-500 bg-opacity-90 px-3 py-1 rounded-full animate-pulse">
                        <i class="fas fa-users mr-2"></i>
                        <span class="hidden sm:inline">Modo Colaborativo</span>
                    </div>
                    <!-- Indicador de sincronización -->
                    <div id="syncIndicator" class="hidden text-white text-sm flex items-center bg-white bg-opacity-20 px-3 py-1 rounded-full">
                        <i class="fas fa-sync-alt fa-spin mr-2"></i>
                        <span>Sincronizando...</span>
                    </div>
                    <button id="logout-btn" class="text-white hover:text-gray-200 flex items-center gap-2 px-3 py-2 rounded-lg transition-colors hover:bg-white hover:bg-opacity-20">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="hidden sm:inline">Cerrar Sesión</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        
        <!-- Selector de Curso -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6 no-print">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4 flex-1">
                    <label class="text-sm font-medium text-gray-700">Curso Activo:</label>
                    <select id="courseSelector" onchange="switchCourse()" class="flex-1 max-w-md px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        <!-- Generado dinámicamente -->
                    </select>
                </div>
                <div class="flex gap-2">
                    <button onclick="showNewCourseModal()" class="btn-action bg-green-500 hover:bg-green-600">
                        <i class="fas fa-plus mr-2"></i>Nuevo Curso
                    </button>
                    <button onclick="deleteCourse()" class="btn-action bg-red-500 hover:bg-red-600">
                        <i class="fas fa-trash mr-2"></i>Eliminar Curso
                    </button>
                    <!-- Botón de sincronización manual -->
                    <button onclick="manualSync()" class="btn-action bg-blue-500 hover:bg-blue-600" title="Sincronizar ahora (trabajo colaborativo)">
                        <i class="fas fa-sync-alt mr-2"></i><span class="hidden md:inline">Sincronizar</span>
                    </button>
                    <!-- Indicador de sincronización -->
                    <span id="syncIndicator" class="hidden items-center px-3 py-2 text-sm text-gray-600">
                        <i class="fas fa-cloud-upload-alt mr-2 text-blue-500"></i>
                        <span class="hidden md:inline">Sincronizando...</span>
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="mb-6 no-print">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="showTab('curso')" id="tab-curso" class="tab-button border-b-2 border-indigo-500 text-indigo-600 py-4 px-1 text-sm font-medium">
                        <i class="fas fa-users mr-2"></i>Gestión del Curso
                    </button>
                    <button onclick="showTab('informes')" id="tab-informes" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                        <i class="fas fa-chart-bar mr-2"></i>Informes y Estadísticas
                    </button>
                    <button onclick="showTab('gestion')" id="tab-gestion" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                        <i class="fas fa-tools mr-2"></i>Gestión Avanzada
                    </button>
                    <button onclick="showTab('individual')" id="tab-individual" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                        <i class="fas fa-user-graduate mr-2"></i>Informes Individuales
                    </button>
                    <button onclick="showTab('config')" id="tab-config" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                        <i class="fas fa-cog mr-2"></i>Configuración
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab: Gestión del Curso -->
        <div id="content-curso" class="tab-content">
            <!-- Info del Curso -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Curso</label>
                        <input type="text" id="courseName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="IV° Año A - 2025" onchange="saveCourseInfo()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asignatura</label>
                        <input type="text" id="subject" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="Lenguaje y Comunicación" onchange="saveCourseInfo()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Período</label>
                        <input type="text" id="period" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="Segundo Semestre 2025" onchange="saveCourseInfo()">
                    </div>
                </div>
            </div>

            <!-- Botón de Guardar -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6 no-print">
                <div class="flex justify-center">
                    <button onclick="saveAllCourses(); showTemporaryMessage('✅ Datos guardados correctamente', 'success');" class="btn-action bg-indigo-500 hover:bg-indigo-600 text-lg px-8 py-3">
                        <i class="fas fa-save mr-2"></i>Guardar Cambios
                    </button>
                </div>
            </div>

            <!-- ðŸ†• Barra de Herramientas Rápidas -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-md p-4 mb-4 no-print border-l-4 border-blue-500">
                <div class="flex flex-wrap gap-2 justify-center items-center">
                    <!-- Agregar Tarea -->
                    <button onclick="addTask()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-all shadow hover:shadow-lg flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i>Nueva Tarea
                    </button>
                    
                    <!-- Agregar Estudiante -->
                    <button onclick="addStudent()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-all shadow hover:shadow-lg flex items-center">
                        <i class="fas fa-user-plus mr-2"></i>Nuevo Estudiante
                    </button>
                    
                    <!-- Marcar Todas -->
                    <button onclick="fillAllGrades(true)" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg font-medium transition-all shadow hover:shadow-lg flex items-center">
                        <i class="fas fa-check-double mr-2"></i>Marcar Todo
                    </button>
                    
                    <!-- Desmarcar Todas -->
                    <button onclick="fillAllGrades(false)" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all shadow hover:shadow-lg flex items-center">
                        <i class="fas fa-times-circle mr-2"></i>Desmarcar Todo
                    </button>
                    
                    <!-- Marcar 1 Tarea -->
                    <button onclick="quickMarkTask(true)" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg font-medium transition-all shadow hover:shadow-lg flex items-center">
                        <i class="fas fa-check mr-2"></i>Marcar 1 Tarea
                    </button>
                    
                    <!-- Desmarcar 1 Tarea -->
                    <button onclick="quickMarkTask(false)" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition-all shadow hover:shadow-lg flex items-center">
                        <i class="fas fa-times mr-2"></i>Desmarcar 1 Tarea
                    </button>
                    
                    <!-- Importar CSV -->
                    <button onclick="document.getElementById('importCSV').click()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-all shadow hover:shadow-lg flex items-center">
                        <i class="fas fa-file-import mr-2"></i>Importar CSV
                    </button>
                </div>
            </div>

            <!-- Tabla de Notas -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="gradesTable">
                        <thead class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium uppercase">N°</th>
                                <th class="px-4 py-3 text-left text-xs font-medium uppercase">Apellido Paterno</th>
                                <th class="px-4 py-3 text-left text-xs font-medium uppercase">Apellido Materno</th>
                                <th class="px-4 py-3 text-left text-xs font-medium uppercase">Nombre</th>
                                <th class="px-4 py-3 text-center text-xs font-medium uppercase no-print">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Generado dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Gestión Avanzada -->
        <div id="content-gestion" class="tab-content hidden">
            <div class="space-y-6">
                
                <!-- Sección: Gestión de Estudiantes -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg shadow-lg p-6 border-l-4 border-green-500">
                    <h3 class="text-xl font-bold text-green-800 mb-4 flex items-center">
                        <i class="fas fa-users-cog mr-3"></i>Gestión de Estudiantes
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Administra los estudiantes del curso: agregar, importar, editar o eliminar.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <button onclick="addStudent()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-user-plus mr-2"></i>Agregar Estudiante
                        </button>
                        <button onclick="showBulkStudentModal()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-users mr-2"></i>Agregar Varios
                        </button>
                        <button onclick="document.getElementById('importCSV').click()" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-file-import mr-2"></i>Importar CSV
                        </button>
                        <button onclick="showEditStudentsList()" class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-edit mr-2"></i>Editar Estudiantes
                        </button>
                    </div>
                    <input type="file" id="importCSV" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
                </div>

                <!-- Sección: Gestión de Tareas -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-lg p-6 border-l-4 border-blue-500">
                    <h3 class="text-xl font-bold text-blue-800 mb-4 flex items-center">
                        <i class="fas fa-tasks mr-3"></i>Gestión de Tareas
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Administra las tareas y evaluaciones del curso.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <button onclick="addTask()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-plus mr-2"></i>Agregar Tarea
                        </button>
                        <button onclick="addMultipleTasks()" class="bg-sky-500 hover:bg-sky-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-plus-square mr-2"></i>Agregar Varias
                        </button>
                        <button onclick="showEditTasksModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-edit mr-2"></i>Editar Tareas
                        </button>
                        <button onclick="deleteMultipleTasks()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-trash-alt mr-2"></i>Eliminar MÃºltiples
                        </button>
                    </div>
                </div>

                <!-- Sección: Gestión de Notas -->
                <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg shadow-lg p-6 border-l-4 border-orange-500">
                    <h3 class="text-xl font-bold text-orange-800 mb-4 flex items-center">
                        <i class="fas fa-clipboard-check mr-3"></i>Gestión de Notas
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Herramientas para manipular las calificaciones del curso de forma masiva.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <button onclick="fillAllGrades(true)" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-check-double mr-2"></i>Marcar Todo
                        </button>
                        <button onclick="fillAllGrades(false)" class="bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-times-circle mr-2"></i>Desmarcar Todo
                        </button>
                        <button onclick="quickMarkTask(true)" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-check mr-2"></i>Marcar 1 Tarea
                        </button>
                        <button onclick="quickMarkTask(false)" class="bg-rose-500 hover:bg-rose-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-times mr-2"></i>Desmarcar 1 Tarea
                        </button>
                        <button onclick="fillTaskColumn()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-fill mr-2"></i>Llenar Columna
                        </button>
                    </div>
                </div>

                <!-- Sección: Gestión del Curso -->
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg shadow-lg p-6 border-l-4 border-purple-500">
                    <h3 class="text-xl font-bold text-purple-800 mb-4 flex items-center">
                        <i class="fas fa-graduation-cap mr-3"></i>Gestión del Curso
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Administra la información general y configuración del curso.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <button onclick="editCourseInfo()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-info-circle mr-2"></i>Editar Info del Curso
                        </button>
                        <button onclick="duplicateCourse()" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-copy mr-2"></i>Duplicar Curso
                        </button>
                        <button onclick="exportCourseData()" class="bg-fuchsia-500 hover:bg-fuchsia-600 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-download mr-2"></i>Exportar Datos
                        </button>
                    </div>
                </div>

                <!-- Sección: Importar/Exportar -->
                <div class="bg-gradient-to-r from-cyan-50 to-sky-50 rounded-lg shadow-lg p-6 border-l-4 border-cyan-500">
                    <h3 class="text-xl font-bold text-cyan-800 mb-4 flex items-center">
                        <i class="fas fa-exchange-alt mr-3"></i>Importar/Exportar
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Importa o exporta datos del curso en diferentes formatos.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-file-excel mr-2"></i>Exportar Excel
                        </button>
                        <button onclick="exportToJSON()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-file-code mr-2"></i>Exportar JSON
                        </button>
                        <button onclick="document.getElementById('importJSON').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-file-upload mr-2"></i>Importar JSON
                        </button>
                        <button onclick="printCourse()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                            <i class="fas fa-print mr-2"></i>Imprimir Curso
                        </button>
                    </div>
                    <input type="file" id="importJSON" accept=".json" style="display: none;" onchange="importFromJSON(event)">
                </div>

            </div>
        </div>

        <!-- Tab: Informes y Estadísticas -->
        <div id="content-informes" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Estadísticas Generales -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-pie mr-2 text-indigo-500"></i>Estadísticas Generales
                    </h3>
                    <div id="generalStats" class="space-y-3">
                        <!-- Generado dinámicamente -->
                    </div>
                </div>

                <!-- Distribución de Notas -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-bar mr-2 text-indigo-500"></i>Distribución de Notas
                    </h3>
                    <canvas id="gradeDistributionChart"></canvas>
                </div>

                <!-- Progreso por Tarea -->
                <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-2">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-tasks mr-2 text-indigo-500"></i>Progreso por Tarea
                    </h3>
                    <canvas id="taskProgressChart"></canvas>
                </div>

                <!-- Informe Completo del Curso -->
                <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-file-alt mr-2 text-indigo-500"></i>Informe Completo del Curso
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="generateCourseReport()" class="btn-action bg-indigo-500 hover:bg-indigo-600">
                                <i class="fas fa-sync-alt mr-2"></i>Generar Informe
                            </button>
                            <button id="downloadCourseReportBtn" onclick="downloadCourseReportPDF()" class="btn-action bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold shadow-lg transform hover:scale-105 transition-all" style="display:none;">
                                <i class="fas fa-file-pdf mr-2"></i>Descargar PDF
                            </button>
                        </div>
                    </div>
                    <div id="courseReportContent" class="text-gray-700">
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-chart-bar text-6xl mb-4"></i>
                            <p class="text-lg">Haga clic en "Generar Informe" para crear el reporte profesional del curso</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Informes Individuales -->
        <div id="content-individual" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-user-graduate mr-2 text-indigo-500"></i>Seleccionar Estudiante
                </h3>
                <select id="studentSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="generateIndividualReport()">
                    <option value="">-- Seleccione un estudiante --</option>
                </select>
            </div>

            <div id="individualReportContent" class="bg-white rounded-lg shadow-md p-6 hidden">
                <!-- Generado dinámicamente -->
            </div>
        </div>

        <!-- Tab: Configuración -->
        <div id="content-config" class="tab-content hidden">
            <!-- Información de Modo Colaborativo -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-md p-5 mb-6 border-l-4 border-blue-500">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-users text-3xl text-blue-500"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-bold text-blue-900 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>Modo Colaborativo Activado
                        </h3>
                        <p class="text-sm text-blue-800 mb-2">
                            <strong>Todos los usuarios comparten la misma base de datos.</strong>
                        </p>
                        <ul class="text-sm text-blue-700 space-y-1 list-disc list-inside">
                            <li>Los cambios realizados por cualquier usuario son visibles para todos</li>
                            <li>Alicia, Joselin, Pia y tÃº trabajan en los mismos cursos</li>
                            <li>La sincronización se realiza automáticamente cada 30 segundos</li>
                            <li>No es necesario compartir cursos manualmente</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-cog mr-2 text-indigo-500"></i>Configuración del Sistema
                </h3>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Escala de Notas</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-600">Nota Mínima</label>
                                <input type="number" id="minGrade" value="1.0" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">Nota Máxima</label>
                                <input type="number" id="maxGrade" value="7.0" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Porcentaje de Exigencia</label>
                        <div class="flex items-center gap-4">
                            <input type="number" id="passingPercentage" value="60" min="0" max="100" step="1" class="w-32 px-3 py-2 border border-gray-300 rounded-lg">
                            <span class="text-sm text-gray-600">% (Por defecto: 60%)</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Este porcentaje determina la nota de aprobación (4.0)</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nota de Aprobación</label>
                        <input type="number" id="passingGrade" value="4.0" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>

                    <div class="flex gap-3">
                        <button onclick="saveConfig()" class="btn-action bg-green-500 hover:bg-green-600">
                            <i class="fas fa-save mr-2"></i>Guardar Configuración
                        </button>
                        <button id="resetDataBtn" onclick="resetData()" class="btn-action bg-red-500 hover:bg-red-600">
                            <i class="fas fa-trash mr-2"></i>Borrar Todos los Datos
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Sección de Diagnóstico de Base de Datos -->
            <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-database mr-2 text-blue-500"></i>Diagnóstico de Base de Datos
                </h3>
                
                <div class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <p class="text-sm text-gray-700 mb-2">
                            <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                            Esta herramienta verifica el estado de la conexión con la base de datos Neon y la sincronización entre dispositivos.
                        </p>
                    </div>
                    
                    <div id="diagnosticResults" class="hidden space-y-3">
                        <!-- Los resultados se mostrarán aquí -->
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="runDatabaseDiagnostic()" class="btn-action bg-blue-500 hover:bg-blue-600">
                            <i class="fas fa-stethoscope mr-2"></i>Ejecutar Diagnóstico
                        </button>
                        <button onclick="manualSync()" class="btn-action bg-purple-500 hover:bg-purple-600">
                            <i class="fas fa-sync-alt mr-2"></i>Sincronización Manual
                        </button>
                        <button onclick="testDatabaseConnection()" class="btn-action bg-cyan-500 hover:bg-cyan-600">
                            <i class="fas fa-plug mr-2"></i>Probar Conexión
                        </button>
                        <button onclick="cleanInvalidCourses()" class="btn-action bg-red-500 hover:bg-red-600">
                            <i class="fas fa-broom mr-2"></i>Limpiar IDs Inválidos
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal: Editar Estudiante -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <div class="bg-indigo-600 text-white px-6 py-4 rounded-t-lg">
                <h3 class="text-lg font-bold">
                    <i class="fas fa-user-edit mr-2"></i>Editar Estudiante
                </h3>
            </div>
            <div class="p-6">
                <input type="hidden" id="editStudentIndex">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NÃºmero de Lista</label>
                        <input type="number" id="editStudentNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Apellido Paterno</label>
                        <input type="text" id="editStudentLastName1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Apellido Materno</label>
                        <input type="text" id="editStudentLastName2" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre</label>
                        <input type="text" id="editStudentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="editStudentRetired" class="w-4 h-4 text-indigo-600 rounded mr-2">
                        <label class="text-sm text-gray-700">Estudiante Retirado (no cuenta en estadísticas)</label>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="saveStudentEdit()" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium">
                        <i class="fas fa-save mr-2"></i>Guardar
                    </button>
                    <button onclick="closeEditStudentModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Agregar Tarea -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg">
                <h3 class="text-lg font-bold">
                    <i class="fas fa-plus mr-2"></i>Agregar Nueva Tarea
                </h3>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Tarea</label>
                        <input type="text" id="taskName" placeholder="Ej: Guía 1, Ensayo, etc." class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Entrega</label>
                        <input type="date" id="taskDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <p class="text-xs text-gray-500 mt-1" id="taskDayOfWeek"></p>
                    </div>

                    <!-- Tipo de Evaluación -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-chart-line mr-1"></i>Tipo de Evaluación
                        </label>
                        <select id="taskEvaluationType" class="w-full px-3 py-2 border border-gray-300 rounded-lg" onchange="handleEvaluationTypeChange()">
                            <option value="binary">âœ“ Binario (Completado/No completado)</option>
                            <option value="logro">ðŸ“Š Niveles de Logro (NL/ML/L/D)</option>
                            <option value="rubrica">ðŸ“ RÃºbrica (Criterios personalizados)</option>
                            <option value="numeric">ðŸ”¢ Nota Numérica (1.0 - 7.0)</option>
                            <option value="percentage">ðŸ“ˆ Porcentaje (0% - 100%)</option>
                            <option value="conceptual">ðŸ“‹ Conceptual (I/S/B/MB)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1" id="evaluationTypeDescription">
                            Evaluación simple: marcado/desmarcado
                        </p>
                    </div>

                    <!-- Configuración de RÃºbrica (solo visible si se selecciona rubrica) -->
                    <div id="rubricaConfigContainer" style="display:none;" class="border border-blue-200 rounded-lg p-4 bg-blue-50">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            <i class="fas fa-list-check mr-1"></i>Criterios de la RÃºbrica
                        </label>
                        <div id="rubricaCriteriaList" class="space-y-2 mb-3">
                            <!-- Los criterios se agregarán dinámicamente -->
                        </div>
                        <button type="button" onclick="addRubricaCriterion()" class="text-sm text-blue-600 hover:text-blue-800">
                            <i class="fas fa-plus mr-1"></i>Agregar criterio
                        </button>
                    </div>
                    
                    <!-- Selector de Nivel -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-graduation-cap mr-1"></i>Nivel (opcional)
                        </label>
                        <select id="taskLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg" onchange="loadUnitsForTask()">
                            <option value="">Sin especificar</option>
                            <option value="2M">2° Medio</option>
                            <option value="3M">3° Medio</option>
                            <option value="4M">4° Medio</option>
                        </select>
                    </div>
                    
                    <!-- Selector de Unidad -->
                    <div id="taskUnitContainer" style="display:none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-book mr-1"></i>Unidad
                        </label>
                        <select id="taskUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg" onchange="loadOAsForTask()">
                            <option value="">Seleccione una unidad</option>
                        </select>
                    </div>
                    
                    <!-- Selector de OAs -->
                    <div id="taskOAsContainer" style="display:none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-bullseye mr-1"></i>Objetivos de Aprendizaje (OAs)
                        </label>
                        <div id="taskOAsList" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50">
                            <!-- OAs se cargarán aquí dinámicamente -->
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Puede seleccionar mÃºltiples OAs</p>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="saveTask()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">
                        <i class="fas fa-save mr-2"></i>Agregar
                    </button>
                    <button onclick="closeAddTaskModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Evaluar con RÃºbrica -->
    <div id="rubricaModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="bg-purple-600 text-white px-6 py-4 rounded-t-lg">
                <h3 class="text-lg font-bold">
                    <i class="fas fa-list-check mr-2"></i>Evaluar con RÃºbrica
                </h3>
                <p class="text-sm mt-1" id="rubricaModalTitle">Tarea - Estudiante</p>
            </div>
            <div class="p-6">
                <div id="rubricaModalCriteria" class="space-y-4 mb-4">
                    <!-- Los criterios se cargarán dinámicamente -->
                </div>
                <div class="bg-gray-100 p-3 rounded-lg mb-4">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">Puntaje Total:</span>
                        <span class="text-2xl font-bold text-purple-600" id="rubricaTotalScore">0 / 0</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="font-medium">Nota Estimada:</span>
                        <span class="text-2xl font-bold" id="rubricaEstimatedGrade">-</span>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="saveRubricaGrade()" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">
                        <i class="fas fa-save mr-2"></i>Guardar
                    </button>
                    <button onclick="closeRubricaModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
        }
        .tab-button {
            border-bottom-width: 2px;
        }
    </style>

    <script>
        // ============================================================
        // SISTEMA MULTI-DOCENTE
        // ============================================================
        
        // Obtener parámetro de docente desde la URL
        const urlParams = new URLSearchParams(window.location.search);
        const docenteParam = urlParams.get('docente') || 'francisco'; // Por defecto 'francisco'
        
        // Configuración de docentes
        const DOCENTES_CONFIG = {
            francisco: {
                nombre: 'Francisco Javier NÃºñez Valenzuela',
                namespace: 'francisco',
                color: 'indigo',
                descripcion: '3° y 4° Medio - Lenguaje y Comunicación'
            },
            javiera: {
                nombre: 'Javiera Poblete',
                namespace: 'javiera',
                color: 'purple',
                descripcion: 'Espacio independiente'
            },
            docente3: {
                nombre: 'Docente 3',
                namespace: 'docente3',
                color: 'teal',
                descripcion: 'Espacio independiente'
            },
            docente4: {
                nombre: 'Docente 4',
                namespace: 'docente4',
                color: 'orange',
                descripcion: 'Espacio independiente'
            },
            profesor2: {
                nombre: 'Otro Docente',
                namespace: 'profesor2',
                color: 'purple',
                descripcion: 'Espacio independiente'
            }
        };
        
        // Cargar configuración personalizada del docente actual si existe
        try {
            const configKey = `${docenteParam}_config`;
            const config = localStorage.getItem(configKey);
            console.log(`ðŸ” Buscando configuración en: ${configKey}`);
            
            if (config) {
                const data = JSON.parse(config);
                console.log('✅ Configuración encontrada:', data);
                
                // Asegurarse de que existe la entrada en DOCENTES_CONFIG
                if (!DOCENTES_CONFIG[docenteParam]) {
                    DOCENTES_CONFIG[docenteParam] = {
                        nombre: docenteParam,
                        namespace: docenteParam,
                        color: 'gray',
                        descripcion: 'Espacio independiente'
                    };
                }
                
                // Actualizar con datos personalizados
                if (data.teacherName) {
                    DOCENTES_CONFIG[docenteParam].nombre = data.teacherName;
                }
                if (data.courses && data.subject) {
                    DOCENTES_CONFIG[docenteParam].descripcion = `${data.courses} - ${data.subject}`;
                } else if (data.courses) {
                    DOCENTES_CONFIG[docenteParam].descripcion = data.courses;
                } else if (data.subject) {
                    DOCENTES_CONFIG[docenteParam].descripcion = data.subject;
                }
            } else {
                console.log(`â„¹ï¸ No hay configuración personalizada para: ${docenteParam}`);
            }
        } catch (e) {
            console.log('Error cargando configuración personalizada:', e);
        }
        
        // Obtener configuración del docente actual
        const DOCENTE_ACTUAL = DOCENTES_CONFIG[docenteParam] || DOCENTES_CONFIG.francisco;
        
        // Namespace para localStorage y DB
        const STORAGE_PREFIX = `${DOCENTE_ACTUAL.namespace}_`;
        const DB_USERNAME = `${sessionStorage.getItem('username') || 'fconuva'}_${DOCENTE_ACTUAL.namespace}`;
        
        console.log(`ðŸ‘¤ Sistema iniciado para: ${DOCENTE_ACTUAL.nombre}`);
        console.log(`ðŸ“¦ Namespace: ${DOCENTE_ACTUAL.namespace}`);
        console.log(`ðŸ’¾ Storage key: ${STORAGE_PREFIX}allCourses`);
        console.log(`ðŸ—„ï¸ DB username: ${DB_USERNAME}`);

        // Helpers para acceso a localStorage con namespace
        // TODAS las claves relacionadas con cursos/datos del docente usan namespace
        function getStorageItem(key) {
            const namespacedKey = `${STORAGE_PREFIX}${key}`;
            return localStorage.getItem(namespacedKey);
        }

        function setStorageItem(key, value) {
            const namespacedKey = `${STORAGE_PREFIX}${key}`;
            localStorage.setItem(namespacedKey, value);
        }

        function removeStorageItem(key) {
            const namespacedKey = `${STORAGE_PREFIX}${key}`;
            localStorage.removeItem(namespacedKey);
        }

        // Obtener username con namespace para DB
        function getNamespacedUsername() {
            // Cada docente tiene su PROPIO username base diferente
            if (DOCENTE_ACTUAL.namespace === 'francisco') {
                return 'francisco_fconuva'; // Username Ãºnico para Francisco
            } else if (DOCENTE_ACTUAL.namespace === 'profesor2') {
                return 'profesor2_profesor2'; // Username Ãºnico para Profesor 2
            } else {
                // Fallback para otros casos
                const baseUsername = sessionStorage.getItem('username') || 'fconuva';
                return `${baseUsername}_${DOCENTE_ACTUAL.namespace}`;
            }
        }

        // Estructura de datos - MULTI-CURSO
        let allCourses = []; // Array de todos los cursos
        let currentCourseId = null; // ID del curso activo
        let courseData = null; // Datos del curso actual (referencia)

        // ============================================================
        // SISTEMA DE EVALUACIÃ“N MULTINIVEL
        // ============================================================
        
        const EVALUATION_TYPES = {
            BINARY: 'binary',           // âœ“/âœ— (Completado/No completado)
            LOGRO: 'logro',            // 4 Niveles de Logro
            RUBRICA: 'rubrica',        // RÃºbrica personalizable
            NUMERIC: 'numeric',        // Nota 1.0-7.0 directa
            PERCENTAGE: 'percentage',  // Porcentaje 0-100%
            CONCEPTUAL: 'conceptual'   // MB/B/S/I
        };

        const LOGRO_LEVELS = {
            NL: { label: 'No Logrado', value: 'NL', icon: 'ðŸ”´', minGrade: 1.0, maxGrade: 3.9 },
            ML: { label: 'Medianamente Logrado', value: 'ML', icon: 'ðŸŸ¡', minGrade: 4.0, maxGrade: 4.9 },
            L: { label: 'Logrado', value: 'L', icon: 'ðŸŸ¢', minGrade: 5.0, maxGrade: 5.9 },
            D: { label: 'Destacado', value: 'D', icon: 'ðŸ”µ', minGrade: 6.0, maxGrade: 7.0 }
        };

        const CONCEPTUAL_LEVELS = {
            I: { label: 'Insuficiente', value: 'I', minGrade: 1.0, maxGrade: 3.9 },
            S: { label: 'Suficiente', value: 'S', minGrade: 4.0, maxGrade: 5.4 },
            B: { label: 'Bueno', value: 'B', minGrade: 5.5, maxGrade: 6.4 },
            MB: { label: 'Muy Bueno', value: 'MB', minGrade: 6.5, maxGrade: 7.0 }
        };

        const DEFAULT_RUBRICA_CRITERIA = [
            { name: 'Comprensión del contenido', weight: 25 },
            { name: 'Aplicación práctica', weight: 25 },
            { name: 'Creatividad y originalidad', weight: 25 },
            { name: 'Presentación y ortografía', weight: 25 }
        ];

        // Convertir cualquier tipo de evaluación a escala comÃºn (1.0-7.0)
        function convertToCommonScale(gradeValue, evaluationType, task) {
            if (!gradeValue || gradeValue.value === null || gradeValue.value === undefined) {
                return null;
            }

            const value = gradeValue.value;

            switch (evaluationType) {
                case EVALUATION_TYPES.BINARY:
                    return value === true ? 7.0 : 1.0;

                case EVALUATION_TYPES.LOGRO:
                    const logro = Object.values(LOGRO_LEVELS).find(l => l.value === value);
                    return logro ? (logro.minGrade + logro.maxGrade) / 2 : null;

                case EVALUATION_TYPES.CONCEPTUAL:
                    const conceptual = Object.values(CONCEPTUAL_LEVELS).find(l => l.value === value);
                    return conceptual ? (conceptual.minGrade + conceptual.maxGrade) / 2 : null;

                case EVALUATION_TYPES.NUMERIC:
                    const num = parseFloat(value);
                    return (num >= 1.0 && num <= 7.0) ? num : null;

                case EVALUATION_TYPES.PERCENTAGE:
                    const pct = parseFloat(value);
                    if (pct >= 0 && pct <= 100) {
                        return 1.0 + (pct / 100) * 6.0;
                    }
                    return null;

                case EVALUATION_TYPES.RUBRICA:
                    if (!gradeValue.rubricaScores || !task.rubricaCriteria) return null;
                    const totalScore = gradeValue.rubricaScores.reduce((a, b) => a + b, 0);
                    const maxScore = task.rubricaCriteria.reduce((a, c) => a + c.maxScore, 0);
                    const percentage = (totalScore / maxScore) * 100;
                    return 1.0 + (percentage / 100) * 6.0;

                default:
                    return null;
            }
        }

        // Obtener color segÃºn nota
        function getGradeColor(grade) {
            if (!grade) return 'text-gray-400';
            if (grade >= 6.0) return 'text-blue-600';
            if (grade >= 5.0) return 'text-green-600';
            if (grade >= 4.0) return 'text-yellow-600';
            return 'text-red-600';
        }

        // Control de permisos por rol
        function initializePermissions() {
            const userRole = sessionStorage.getItem('userRole') || 'teacher';
            
            if (userRole !== 'admin') {
                // Ocultar botón de "Borrar Todos los Datos"
                const resetBtn = document.getElementById('resetDataBtn');
                if (resetBtn) {
                    resetBtn.style.display = 'none';
                }
                
                console.log('ðŸ”’ Permisos de profesora: Botón "Borrar Todo" ocultado');
            }
        }
        
        // Sobrescribir resetData para verificar permisos
        const originalResetData = resetData;
        function resetData() {
            const userRole = sessionStorage.getItem('userRole') || 'teacher';
            
            if (userRole !== 'admin') {
                alert('â›” Acción no permitida\n\nSolo el administrador puede borrar todos los datos del curso.\n\nPor favor, contacta al administrador si necesitas realizar esta acción.');
                return;
            }
            
            originalResetData();
        }
        
        // Optimizaciones para móvil
        function initializeMobileOptimizations() {
            // Detectar si es móvil
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                console.log('ðŸ“± Dispositivo móvil detectado - Aplicando optimizaciones');
                
                // Prevenir zoom doble-tap en iOS
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
                
                // Mejorar scroll en tablas
                const tables = document.querySelectorAll('.overflow-x-auto');
                tables.forEach(table => {
                    table.style.webkitOverflowScrolling = 'touch';
                });
                
                // Ajustar altura de viewport en móviles (especialmente iOS)
                const setVH = () => {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                };
                
                setVH();
                window.addEventListener('resize', setVH);
                window.addEventListener('orientationchange', setVH);
                
                // Mejorar rendimiento de scrolling
                if (CSS.supports('overflow-y', 'overlay')) {
                    document.body.style.overflowY = 'overlay';
                }
                
                // Ocultar elementos no esenciales en móvil
                const hideOnMobile = document.querySelectorAll('.hidden-mobile');
                hideOnMobile.forEach(el => el.style.display = 'none');
                
                // Optimizar modales para móvil
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.addEventListener('touchmove', function(e) {
                        const modalContent = modal.querySelector('.modal-content');
                        if (modalContent && modalContent.scrollHeight > modalContent.clientHeight) {
                            e.stopPropagation();
                        }
                    }, { passive: true });
                });
            }
            
            // Optimizaciones para ambos (móvil y escritorio)
            // Lazy loading de imágenes si las hay
            if ('loading' in HTMLImageElement.prototype) {
                const images = document.querySelectorAll('img[loading="lazy"]');
                images.forEach(img => {
                    img.src = img.dataset.src;
                });
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸš€ Iniciando aplicación...');
            
            // PASO 0: Mostrar nombre del docente en el header
            const docenteNombreElement = document.getElementById('docenteNombre');
            if (docenteNombreElement) {
                docenteNombreElement.textContent = DOCENTE_ACTUAL.nombre;
            }
            
            // PASO 0: Optimizaciones para móvil
            initializeMobileOptimizations();
            
            // PASO 0.1: Aplicar permisos segÃºn rol
            initializePermissions();
            
            // PASO 1: Cargar cursos (con migración automática si es necesario)
            await loadAllCourses();
            
            // PASO 2: Sincronizar cambios pendientes en segundo plano
            setTimeout(() => {
                syncPendingChanges();
            }, 2000);
            
            // PASO 2.5: Iniciar auto-refresh para sincronización en tiempo real
            startAutoRefresh();
            
            // PASO 3: Si no hay cursos, crear uno por defecto
            if (allCourses.length === 0) {
                console.log('ðŸ“ No hay cursos, creando uno por defecto...');
                createDefaultCourse();
            } else {
                console.log(`✅ ${allCourses.length} curso(s) disponible(s)`);
            }
            
            // PASO 4: Asegurar que hay un curso actual
            if (!currentCourseId && allCourses.length > 0) {
                currentCourseId = allCourses[0].id;
            }
            
            // PASO 5: Actualizar interfaz
            updateCourseSelector();
            
            // PASO 6: Cargar el curso actual
            if (currentCourseId) {
                loadCourse(currentCourseId);
            } else {
                // Si no hay curso, inicializar tabla vacía
                renderTable();
                populateStudentSelect();
            }
            
            // PASO 7: Configurar logout
            document.getElementById('logout-btn').addEventListener('click', function() {
                sessionStorage.removeItem('isLoggedIn');
                sessionStorage.removeItem('username');
                window.location.href = 'login.html';
            });
            
            console.log('✅ Aplicación lista');
        });

        // Crear curso por defecto
        function createDefaultCourse() {
            const newCourse = {
                id: Date.now(),
                courseName: "Mi Curso",
                subject: "Asignatura",
                period: new Date().getFullYear(),
                students: [],
                tasks: [],
                config: {
                    minGrade: 1.0,
                    maxGrade: 7.0,
                    passingGrade: 4.0,
                    passingPercentage: 60
                }
            };
            allCourses.push(newCourse);
            currentCourseId = newCourse.id;
            saveAllCourses();
        }

        // ============ SINCRONIZACIÃ“N CON BASE DE DATOS ============
        
        // Obtener username del usuario actual
        function getCurrentUsername() {
            return getNamespacedUsername();
        }
        
        // Cargar cursos desde la base de datos
        async function loadCoursesFromDatabase() {
            try {
                const username = getCurrentUsername();
                console.log('ðŸ”„ Cargando cursos desde la base de datos para:', username);
                
                const response = await fetch(`/api/courses?username=${encodeURIComponent(username)}`);
                const data = await response.json();
                
                if (data.success && data.courses) {
                    // Merge remote with local stored courses using timestamps to prefer newer changes
                    const remote = data.courses;

                    // Ensure local backup exists
                    const saved = getStorageItem('allCourses');
                    let localBackup = [];
                    try { localBackup = saved ? JSON.parse(saved) : []; } catch (e) { localBackup = []; }

                    // Preprocess remote: remove corrupt decimal IDs and ensure shape
                    let needsSync = false;
                    const remoteClean = [];
                    remote.forEach(course => {
                        const isDecimal = typeof course.id === 'number' && course.id % 1 !== 0;
                        if (isDecimal) {
                            console.log(`âŒ ELIMINANDO curso corrupto del remoto "${course.courseName}" ID decimal:`, course.id);
                            needsSync = true;
                            return; // skip
                        }
                        course.tasks = course.tasks || [];
                        course.students = course.students || [];
                        course.config = course.config || { minGrade:1.0,maxGrade:7.0,passingGrade:4.0,passingPercentage:60 };
                        remoteClean.push(course);
                    });

                    // Merge using updatedAt
                    allCourses = mergeCoursesByTimestamp(localBackup, remoteClean);

                    console.log('✅ Cursos combinados local+DB:', allCourses.length, 'cursos');

                    // Save merged to localStorage
                    setStorageItem('allCourses', JSON.stringify(allCourses));

                    // If we removed corrupt remote courses, push corrected state
                    if (needsSync) {
                        console.log('ðŸ”„ Sincronizando correcciones a la BD...');
                        await syncCoursesToDatabase();
                    }

                    return true;
                } else {
                    console.warn('âš ï¸ No se pudieron cargar cursos de la DB, usando localStorage');
                    return false;
                }
            } catch (error) {
                console.error('âŒ Error cargando cursos desde DB:', error);
                return false;
            }
        }
        
        // Sincronizar cursos con la base de datos (silencioso)
        async function syncCoursesToDatabase() {
            try {
                const username = getCurrentUsername();
                
                // Solo sincronizar si hay cursos
                if (!allCourses || allCourses.length === 0) {
                    console.log('â­ï¸ Sin cursos para sincronizar');
                    return true;
                }
                
                console.log('ðŸ”„ Sincronizando', allCourses.length, 'curso(s) a la base de datos compartida...');
                
                const response = await fetch('/api/courses/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        courses: allCourses,
                        username: username // Enviar username con namespace para separación de datos por docente
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ Sincronización exitosa:', data.message);
                    return true;
                } else {
                    console.warn('âš ï¸ Respuesta sin éxito:', data.error);
                    return false;
                }
            } catch (error) {
                // Silencioso: solo log, sin notificaciones molestas
                console.warn('âš ï¸ Sincronización diferida (sin conexión o error):', error.message);
                return false;
            }
        }
        
        // Mostrar notificación de sincronización
        function showSyncNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 animate-fade-in ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-orange-500'
            }`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'exclamation-triangle'} mr-2"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // ============================================
        // FUNCIONES DE DIAGNÃ“STICO
        // ============================================
        
        // Diagnóstico completo de base de datos
        async function runDatabaseDiagnostic() {
            const resultsDiv = document.getElementById('diagnosticResults');
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = `
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded animate-pulse">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        Ejecutando diagnóstico completo...
                    </p>
                </div>
            `;
            
            const results = [];
            let allPassed = true;
            
            // Test 1: Conexión a la base de datos
            try {
                const username = getCurrentUsername();
                const response = await fetch(`/api/courses?username=${encodeURIComponent(username)}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    results.push({
                        test: 'Conexión a Base de Datos',
                        status: 'success',
                        message: `✅ Conectado correctamente a Neon Database`,
                        details: `Usuario: ${username}`
                    });
                } else {
                    results.push({
                        test: 'Conexión a Base de Datos',
                        status: 'error',
                        message: `âŒ Error de conexión`,
                        details: data.error || 'Error desconocido'
                    });
                    allPassed = false;
                }
            } catch (error) {
                results.push({
                    test: 'Conexión a Base de Datos',
                    status: 'error',
                    message: `âŒ No se pudo conectar`,
                    details: error.message
                });
                allPassed = false;
            }
            
            // Test 2: Verificar cursos en localStorage
            const localCourses = getStorageItem('allCourses');
            if (localCourses) {
                try {
                    const parsed = JSON.parse(localCourses);
                    results.push({
                        test: 'LocalStorage',
                        status: 'success',
                        message: `✅ ${parsed.length} curso(s) en almacenamiento local`,
                        details: `Espacio usado: ${(JSON.stringify(parsed).length / 1024).toFixed(2)} KB`
                    });
                } catch (e) {
                    results.push({
                        test: 'LocalStorage',
                        status: 'error',
                        message: `âŒ Error al leer localStorage`,
                        details: e.message
                    });
                    allPassed = false;
                }
            } else {
                results.push({
                    test: 'LocalStorage',
                    status: 'warning',
                    message: `âš ï¸ No hay datos en localStorage`,
                    details: 'Esto es normal si es la primera vez que usas la aplicación'
                });
            }
            
            // Test 3: Sincronización
            try {
                const synced = await syncCoursesToDatabase();
                if (synced) {
                    results.push({
                        test: 'Sincronización',
                        status: 'success',
                        message: `✅ Sincronización funcionando correctamente`,
                        details: `${allCourses.length} curso(s) sincronizado(s)`
                    });
                } else {
                    results.push({
                        test: 'Sincronización',
                        status: 'warning',
                        message: `âš ï¸ Sincronización con advertencias`,
                        details: 'Los datos se guardan localmente, pero puede haber problemas de conexión'
                    });
                }
            } catch (error) {
                results.push({
                    test: 'Sincronización',
                    status: 'error',
                    message: `âŒ Error en sincronización`,
                    details: error.message
                });
                allPassed = false;
            }
            
            // Test 4: Auto-refresh
            const autoRefreshActive = autoRefreshInterval !== null;
            results.push({
                test: 'Auto-Refresh',
                status: autoRefreshActive ? 'success' : 'warning',
                message: autoRefreshActive ? `✅ Auto-refresh activo (cada 30s)` : `âš ï¸ Auto-refresh desactivado`,
                details: autoRefreshActive ? 'Los cambios de otros dispositivos se sincronizarán automáticamente' : 'Necesitas recargar manualmente'
            });
            
            // Test 5: Verificar variables críticas
            const criticalVarsOk = typeof allCourses !== 'undefined' && typeof courseData !== 'undefined';
            results.push({
                test: 'Variables del Sistema',
                status: criticalVarsOk ? 'success' : 'error',
                message: criticalVarsOk ? `✅ Todas las variables críticas están definidas` : `âŒ Faltan variables críticas`,
                details: `allCourses: ${allCourses ? allCourses.length : 'undefined'}, courseData: ${courseData ? 'OK' : 'undefined'}`
            });
            
            // Mostrar resultados
            let html = '';
            
            if (allPassed) {
                html += `
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                        <p class="text-sm font-bold text-green-800">
                            <i class="fas fa-check-circle mr-2"></i>
                            ✅ Todos los tests pasaron correctamente
                        </p>
                    </div>
                `;
            } else {
                html += `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        <p class="text-sm font-bold text-red-800">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            âš ï¸ Se detectaron problemas
                        </p>
                    </div>
                `;
            }
            
            results.forEach(result => {
                const bgColor = result.status === 'success' ? 'bg-green-50 border-green-300' : 
                               result.status === 'warning' ? 'bg-yellow-50 border-yellow-300' : 
                               'bg-red-50 border-red-300';
                const textColor = result.status === 'success' ? 'text-green-800' : 
                                 result.status === 'warning' ? 'text-yellow-800' : 
                                 'text-red-800';
                
                html += `
                    <div class="${bgColor} border-l-4 p-4 rounded">
                        <p class="text-sm font-semibold ${textColor}">${result.test}</p>
                        <p class="text-sm ${textColor} mt-1">${result.message}</p>
                        <p class="text-xs text-gray-600 mt-1">${result.details}</p>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // Probar conexión a la base de datos
        async function testDatabaseConnection() {
            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Probando...';
            
            try {
                const username = getCurrentUsername();
                const response = await fetch(`/api/courses?username=${encodeURIComponent(username)}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showSyncNotification(`✅ Conexión exitosa - ${data.courses.length} curso(s) encontrado(s)`, 'success');
                    console.log('ðŸ“Š Datos de la base de datos:', data);
                } else {
                    showSyncNotification(`âŒ Error: ${data.error || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                showSyncNotification(`âŒ Error de conexión: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }
        
        // ðŸ§¹ LIMPIAR CURSOS CON IDS INVÃLIDOS O PROBLEMÃTICOS
        async function cleanInvalidCourses() {
            if (!confirm('âš ï¸ Esta acción eliminará cursos con IDs inválidos (0, decimales extraños, duplicados).\n\nÂ¿Continuar?')) {
                return;
            }
            
            console.log('ðŸ§¹ Iniciando limpieza de cursos problemáticos...');
            
            let cleaned = 0;
            let fixed = 0;
            const seenIds = new Set();
            const validCourses = [];
            
            // Limpiar localmente primero
            allCourses.forEach((course, index) => {
                const id = course.id;
                
                // Detectar IDs problemáticos
                const isInvalid = !id || id === 0 || id === '0';
                const isDecimal = typeof id === 'number' && id % 1 !== 0;
                const isDuplicate = seenIds.has(id);
                
                if (isInvalid) {
                    console.log(`âŒ Eliminando curso con ID inválido: "${course.courseName}" (ID: ${id})`);
                    cleaned++;
                } else if (isDecimal) {
                    console.log(`ðŸ”§ Corrigiendo ID decimal: "${course.courseName}" (${id} â†’ ${Math.floor(id)})`);
                    course.id = Math.floor(id);
                    seenIds.add(course.id);
                    validCourses.push(course);
                    fixed++;
                } else if (isDuplicate) {
                    console.log(`âš ï¸ ID duplicado detectado: "${course.courseName}" (ID: ${id}) - Generando nuevo ID`);
                    course.id = Date.now() + Math.random() * 10000;
                    seenIds.add(course.id);
                    validCourses.push(course);
                    fixed++;
                } else {
                    seenIds.add(id);
                    validCourses.push(course);
                }
            });
            
            // Actualizar array de cursos
            allCourses = validCourses;
            
            // Guardar localmente
            setStorageItem('allCourses', JSON.stringify(allCourses));
            
            // Sincronizar con la base de datos
            try {
                console.log('â˜ï¸ Sincronizando cursos limpios con la base de datos...');
                await syncCoursesToDatabase();
                
                // Recargar interfaz
                updateCourseSelector();
                if (allCourses.length > 0) {
                    currentCourseId = allCourses[0].id;
                    loadCourse(currentCourseId);
                } else {
                    currentCourseId = null;
                    courseData = null;
                }
                
                const message = `✅ Limpieza completada:\n• ${cleaned} curso(s) eliminado(s)\n• ${fixed} curso(s) corregido(s)\n• ${allCourses.length} curso(s) válido(s) restante(s)`;
                alert(message);
                console.log('✅ Limpieza exitosa');
                
                showSyncNotification('✅ Base de datos limpia', 'success');
            } catch (error) {
                console.error('âŒ Error sincronizando después de limpieza:', error);
                alert('âš ï¸ Cursos limpiados localmente, pero hubo un error al sincronizar con la base de datos.');
            }
        }
        
        // Sincronización manual (botón en interfaz)
        async function manualSync() {
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            
            // Animar icono
            icon.classList.add('fa-spin');
            btn.disabled = true;
            
            try {
                // Primero sincronizar a DB (subir)
                console.log('ðŸ“¤ Subiendo cursos a la nube...');
                const uploaded = await syncCoursesToDatabase();
                
                // Luego cargar desde DB (bajar)
                console.log('ðŸ“¥ Descargando cursos desde la nube...');
                const downloaded = await loadCoursesFromDatabase();
                
                if (uploaded || downloaded) {
                    // Recargar interfaz
                    updateCourseSelector();
                    if (currentCourseId) {
                        loadCourse(currentCourseId);
                    } else if (allCourses.length > 0) {
                        currentCourseId = allCourses[0].id;
                        loadCourse(currentCourseId);
                    }
                    
                    showSyncNotification('✅ Sincronización completa', 'success');
                    console.log('✅ Sincronización bidireccional completada');
                } else {
                    showSyncNotification('âš ï¸ Sin cambios para sincronizar', 'warning');
                }
            } catch (error) {
                console.error('âŒ Error en sincronización manual:', error);
                showSyncNotification('âŒ Error al sincronizar', 'error');
            } finally {
                icon.classList.remove('fa-spin');
                btn.disabled = false;
            }
        }

        // Helper: merge local and remote courses preferring newer updatedAt
        function mergeCoursesByTimestamp(localCourses, remoteCourses) {
            const map = new Map();
            // Index local
            (localCourses || []).forEach(c => {
                map.set(String(c.id), JSON.parse(JSON.stringify(c)));
            });
            // Merge remote con estrategia granular
            (remoteCourses || []).forEach(c => {
                const key = String(c.id);
                const existing = map.get(key);
                if (!existing) {
                    // Curso nuevo en remote
                    map.set(key, JSON.parse(JSON.stringify(c)));
                } else {
                    // Mismo curso existe en local y remote â†’ usar merge granular nota por nota
                    const merged = mergeCoursesGranular(existing, c);
                    map.set(key, merged);
                }
            });
            return Array.from(map.values());
        }

        // Merge granular: fusiona curso nota por nota, estudiante por estudiante
        // Ãštil cuando dos usuarios editan el MISMO curso simultáneamente
        function mergeCoursesGranular(localCourse, remoteCourse) {
            if (!localCourse || !remoteCourse) {
                return localCourse || remoteCourse;
            }

            // Si son cursos diferentes, devolver el más reciente por timestamp general
            if (localCourse.id !== remoteCourse.id) {
                const localTime = localCourse.updatedAt || 0;
                const remoteTime = remoteCourse.updatedAt || 0;
                return remoteTime > localTime ? remoteCourse : localCourse;
            }

            // Mismo curso: hacer merge granular
            console.log(`ðŸ”¬ Merge granular para curso ID ${localCourse.id}`);

            // Empezar con una copia del curso local
            const merged = JSON.parse(JSON.stringify(localCourse));

            // Merge tareas (preferir remote si difieren)
            if (remoteCourse.tasks && remoteCourse.tasks.length > 0) {
                merged.tasks = JSON.parse(JSON.stringify(remoteCourse.tasks));
            }

            // Merge estudiantes: por cada estudiante, merge sus notas una por una
            if (remoteCourse.students && Array.isArray(remoteCourse.students)) {
                remoteCourse.students.forEach((remoteStudent, idx) => {
                    const localStudent = merged.students[idx];
                    
                    if (!localStudent) {
                        // Estudiante nuevo en remote, agregarlo
                        merged.students.push(JSON.parse(JSON.stringify(remoteStudent)));
                        return;
                    }

                    // Merge nota por nota
                    if (remoteStudent.grades && Array.isArray(remoteStudent.grades)) {
                        remoteStudent.grades.forEach((remoteGrade, gradeIdx) => {
                            if (!localStudent.grades[gradeIdx]) {
                                // No existe local, tomar remote
                                localStudent.grades[gradeIdx] = JSON.parse(JSON.stringify(remoteGrade));
                                return;
                            }

                            const localGrade = localStudent.grades[gradeIdx];
                            const localTime = getGradeTimestamp(localGrade) || 0;
                            const remoteTime = getGradeTimestamp(remoteGrade) || 0;

                            // Comparar timestamps y tomar el más reciente
                            if (remoteTime > localTime) {
                                console.log(`  ðŸ“ Nota [${idx}][${gradeIdx}]: Remote más reciente (${remoteTime} > ${localTime})`);
                                localStudent.grades[gradeIdx] = JSON.parse(JSON.stringify(remoteGrade));
                            } else {
                                console.log(`  ✅ Nota [${idx}][${gradeIdx}]: Local más reciente (${localTime} >= ${remoteTime})`);
                            }
                        });
                    }

                    // Merge otras propiedades del estudiante (nombre, nÃºmero, retirado, etc.)
                    // Preferir remote si tiene updatedAt más reciente (a nivel estudiante)
                    const localStudentTime = localStudent.updatedAt || 0;
                    const remoteStudentTime = remoteStudent.updatedAt || 0;
                    if (remoteStudentTime > localStudentTime) {
                        localStudent.number = remoteStudent.number;
                        localStudent.lastName1 = remoteStudent.lastName1;
                        localStudent.lastName2 = remoteStudent.lastName2;
                        localStudent.name = remoteStudent.name;
                        localStudent.retired = remoteStudent.retired;
                        localStudent.notes = remoteStudent.notes;
                        localStudent.updatedAt = remoteStudent.updatedAt;
                    }
                });
            }

            // Actualizar timestamp del curso al más reciente
            const localCourseTime = new Date(localCourse.updatedAt || 0).getTime();
            const remoteCourseTime = new Date(remoteCourse.updatedAt || 0).getTime();
            merged.updatedAt = remoteCourseTime > localCourseTime ? remoteCourse.updatedAt : localCourse.updatedAt;

            console.log(`✅ Merge granular completado para curso ${merged.id}`);
            return merged;
        }
        
        // Cargar todos los cursos con migración automática
        async function loadAllCourses() {
            console.log('ðŸ”„ Iniciando carga de cursos...');
            
            // PASO 1: Cargar desde localStorage primero (respaldo inmediato)
            const saved = getStorageItem('allCourses');
            let localCourses = [];
            if (saved) {
                try {
                    localCourses = JSON.parse(saved);
                    console.log('ðŸ“ Cursos en localStorage:', localCourses.length);
                } catch (e) {
                    console.error('Error parseando localStorage:', e);
                }
            }
            
            // PASO 2: Intentar cargar desde la base de datos
            const loadedFromDB = await loadCoursesFromDatabase();
            
            // PASO 3: Verificar si se hizo un borrado total reciente
            const totalWipeTime = getStorageItem('totalWipeCompleted');
            const recentWipe = totalWipeTime && (Date.now() - parseInt(totalWipeTime)) < 5 * 60 * 1000; // 5 minutos
            
            // PASO 4: Migración automática SOLO si NO hubo borrado total reciente
            if (localCourses.length > 0 && (!allCourses || allCourses.length === 0) && !recentWipe) {
                console.log('ðŸ”„ Detectados', localCourses.length, 'cursos locales sin sincronizar');
                console.log('ðŸ“¤ Iniciando migración automática a la nube...');
                
                // Cargar cursos locales en memoria
                allCourses = localCourses;
                
                // Subir a la base de datos
                try {
                    const synced = await syncCoursesToDatabase();
                    if (synced) {
                        console.log('✅ Migración completada:', localCourses.length, 'cursos sincronizados');
                        showSyncNotification('✅ Cursos migrados a la nube automáticamente', 'success');
                    }
                } catch (error) {
                    console.error('âŒ Error en migración automática:', error);
                    // No pasa nada, seguimos trabajando con localStorage
                }
            } else if (recentWipe) {
                console.log('â­ï¸ Borrado total detectado, omitiendo migración automática');
                allCourses = []; // Forzar array vacío
                localCourses = [];
            }
            
            // PASO 5: Si no hay cursos en ningÃºn lado, usar localStorage como respaldo (si no hubo wipe)
            if (!allCourses || allCourses.length === 0) {
                if (localCourses.length > 0 && !recentWipe) {
                    allCourses = localCourses;
                    console.log('ðŸ“ Usando cursos de localStorage:', allCourses.length);
                } else {
                    allCourses = [];
                    console.log('ðŸ“ No hay cursos disponibles');
                }
            }
            
            // PASO 6: Configurar curso actual
            const savedCurrentId = getStorageItem('currentCourseId');
            if (savedCurrentId) {
                currentCourseId = parseFloat(savedCurrentId);
                console.log('ID de curso actual cargado:', currentCourseId);
            } else if (allCourses.length > 0) {
                currentCourseId = allCourses[0].id;
                console.log('ID de curso establecido al primero:', currentCourseId);
            }
            
            console.log('✅ Carga completada:', allCourses.length, 'curso(s) disponible(s)');
            
            // PASO 7: Migración de estructura de evaluación
            migrateEvaluationStructure();
        }

        // Migrar estructura de evaluación para cursos existentes
        function migrateEvaluationStructure() {
            if (!allCourses || allCourses.length === 0) return;

            let migrated = false;

            allCourses.forEach(course => {
                if (!course.tasks || course.tasks.length === 0) return;

                course.tasks.forEach(task => {
                    // Si la tarea no tiene evaluationType, asignar 'binary' por defecto
                    if (!task.evaluationType) {
                        task.evaluationType = 'binary';
                        migrated = true;
                    }
                });

                // Migrar grades antiguas (boolean directo) a nuevo formato
                if (course.students && course.students.length > 0) {
                    course.students.forEach(student => {
                        if (!student.grades) return;

                        student.grades = student.grades.map((grade, index) => {
                            const task = course.tasks[index];
                            if (!task) return grade;

                            // Si es formato antiguo (boolean/null directo)
                            if (typeof grade !== 'object' || grade === null) {
                                migrated = true;
                                return {
                                    value: grade,
                                    updatedAt: new Date().toISOString(),
                                    evaluationType: task.evaluationType || 'binary'
                                };
                            }

                            // Si es formato nuevo pero le falta evaluationType
                            if (!grade.evaluationType) {
                                grade.evaluationType = task.evaluationType || 'binary';
                                migrated = true;
                            }

                            return grade;
                        });
                    });
                }
            });

            if (migrated) {
                console.log('ðŸ”„ Migración de estructura de evaluación completada');
                setStorageItem('allCourses', JSON.stringify(allCourses));
            }
        }

        // Guardar todos los cursos (localStorage + sincronización automática con DB)
        function saveAllCourses() {
            // Antes de guardar, actualizar timestamp del curso actual para resolver conflictos
            try {
                if (currentCourseId && allCourses && Array.isArray(allCourses)) {
                    const idx = allCourses.findIndex(c => c.id == currentCourseId);
                    if (idx !== -1) {
                        allCourses[idx].updatedAt = Date.now();
                    }
                }
            } catch (e) {
                console.warn('âš ï¸ No se pudo actualizar timestamp del curso:', e.message);
            }

            // Guardar localmente (inmediato y confiable)
            setStorageItem('allCourses', JSON.stringify(allCourses));
            setStorageItem('currentCourseId', currentCourseId);
            
            // Sincronizar con base de datos (asíncrono, silencioso, no bloquea la UI)
            // Si falla, no importa, localStorage ya tiene los datos
            syncCoursesToDatabase().catch(error => {
                console.warn('âš ï¸ Sincronización en segundo plano falló (no afecta el funcionamiento):', error.message);
                // Guardar en cola de sincronización pendiente
                markForLaterSync();
            });
        }
        
        // Marcar para sincronización posterior
        function markForLaterSync() {
            setStorageItem('needsSync', 'true');
        }
        
        // Intentar sincronizar pendientes
        async function syncPendingChanges() {
            if (getStorageItem('needsSync') === 'true') {
                console.log('ðŸ”„ Sincronizando cambios pendientes...');
                const synced = await syncCoursesToDatabase();
                if (synced) {
                    removeStorageItem('needsSync');
                    console.log('✅ Cambios pendientes sincronizados');
                }
            }
        }
        
        // Auto-refresh: Sincronización inteligente en tiempo real
        let autoRefreshInterval = null;
        const AUTO_REFRESH_INTERVAL = 2000; // 2 segundos (más rápido y eficiente)
        let lastSyncTimestamp = null;
        
        function startAutoRefresh() {
            // Limpiar intervalo anterior si existe
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            console.log('ï¿½ Sincronización inteligente activada (cada 2 segundos)');
            
            autoRefreshInterval = setInterval(async () => {
                try {
                    // Paso 1: Subir cambios locales primero (rápido y silencioso)
                    await syncCoursesToDatabase();
                    
                    // Paso 2: Verificar si HAY actualizaciones (muy ligero)
                    const username = getNamespacedUsername();
                    const checkUrl = `/api/courses/check-updates?username=${encodeURIComponent(username)}${lastSyncTimestamp ? `&lastSync=${lastSyncTimestamp}` : ''}`;
                    const checkResponse = await fetch(checkUrl);
                    const checkData = await checkResponse.json();
                    
                    // Solo descargar si hay cambios reales
                    if (!checkData.hasUpdates) {
                        console.log('✅ Sin cambios remotos');
                        return;
                    }
                    
                    console.log('ï¿½ Cambios detectados, descargando...');
                    
                    // Mostrar indicador solo cuando HAY cambios
                    const syncIndicator = document.getElementById('syncIndicator');
                    if (syncIndicator) {
                        syncIndicator.classList.remove('hidden');
                    }
                    
                    // Paso 3: Descargar solo cuando hay cambios
                    const response = await fetch(`/api/courses?username=${encodeURIComponent(username)}`);
                    const data = await response.json();
                    
                    if (data.success && data.courses) {
                        const dbCourses = data.courses;

                        // Merge remote DB with local using timestamps - prefer newer entries
                        const merged = mergeCoursesByTimestamp(allCourses || [], dbCourses || []);
                        const mergedHash = JSON.stringify(merged);
                        const localHash = JSON.stringify(allCourses || []);

                        if (mergedHash !== localHash) {
                            console.log('âš¡ Aplicando cambios remotos...');
                            // Save merged result
                            allCourses = merged;
                            setStorageItem('allCourses', JSON.stringify(allCourses));

                            // Actualizar timestamp de Ãºltima sincronización
                            lastSyncTimestamp = checkData.latestTimestamp || new Date().toISOString();
                            
                            // MEJORA PARA TRABAJO COLABORATIVO: Actualizar vista SIEMPRE que haya cambios
                            const currentId = currentCourseId;
                            if (currentId && courseData) {
                                const updatedCourse = allCourses.find(c => c.id == currentId);
                                if (updatedCourse) {
                                    // Comparar datos completos del curso (incluyendo calificaciones)
                                    const currentCourseHash = JSON.stringify(courseData);
                                    const updatedCourseHash = JSON.stringify(updatedCourse);
                                    
                                    if (currentCourseHash !== updatedCourseHash) {
                                        console.log('✨ Actualizando vista con cambios colaborativos...');
                                        courseData = updatedCourse;
                                        renderTable();
                                        populateStudentSelect();
                                        updateCourseSelector();
                                        
                                        // Mostrar notificación sutil
                                        const syncIndicator = document.getElementById('syncIndicator');
                                        if (syncIndicator) {
                                            syncIndicator.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Sincronizado';
                                            syncIndicator.classList.remove('bg-yellow-500');
                                            syncIndicator.classList.add('bg-green-500');
                                        }
                                        
                                        // Mostrar toast breve
                                        showNotification('ðŸ”„ Cambios de otro usuario aplicados', 'info');
                                    }
                                }
                            } else {
                                updateCourseSelector();
                            }
                        } else {
                            // Actualizar timestamp aunque no haya cambios
                            lastSyncTimestamp = checkData.latestTimestamp || lastSyncTimestamp;
                        }
                    }
                } catch (error) {
                    console.error('âŒ Error en auto-refresh:', error);
                    // No mostrar alerta para no molestar al usuario
                } finally {
                    // Ocultar indicador de sincronización después de 1 segundo
                    setTimeout(() => {
                        const syncIndicator = document.getElementById('syncIndicator');
                        if (syncIndicator) {
                            syncIndicator.classList.add('hidden');
                        }
                    }, 1000);
                }
            }, AUTO_REFRESH_INTERVAL);
        }
        
        // Detener auto-refresh (si es necesario)
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('â¸ï¸ Auto-refresh detenido');
            }
        }

        // Sincronización manual (para trabajo colaborativo)
        async function manualSync() {
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            
            try {
                // Cambiar botón a estado de carga
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-sync-alt fa-spin mr-2"></i><span class="hidden md:inline">Sincronizando...</span>';
                
                console.log('ðŸ”„ Sincronización manual iniciada...');
                
                // Mostrar indicador
                const syncIndicator = document.getElementById('syncIndicator');
                if (syncIndicator) {
                    syncIndicator.classList.remove('hidden');
                }
                
                // 1. Subir cambios locales
                await syncCoursesToDatabase();
                
                // 2. Bajar cambios remotos
                const username = getNamespacedUsername();
                const response = await fetch(`/api/courses?username=${encodeURIComponent(username)}`);
                const data = await response.json();
                
                if (data.success && data.courses) {
                    const merged = mergeCoursesByTimestamp(allCourses || [], data.courses || []);
                    allCourses = merged;
                    setStorageItem('allCourses', JSON.stringify(allCourses));
                    
                    // Actualizar vista del curso actual
                    if (currentCourseId && courseData) {
                        const updatedCourse = allCourses.find(c => c.id == currentCourseId);
                        if (updatedCourse) {
                            courseData = updatedCourse;
                            renderTable();
                            populateStudentSelect();
                            updateCourseSelector();
                        }
                    }
                    
                    showNotification('✅ Sincronización completada', 'success');
                    console.log('✅ Sincronización manual exitosa');
                }
            } catch (error) {
                console.error('âŒ Error en sincronización manual:', error);
                showNotification('âŒ Error al sincronizar', 'error');
            } finally {
                // Restaurar botón
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                
                // Ocultar indicador
                setTimeout(() => {
                    const syncIndicator = document.getElementById('syncIndicator');
                    if (syncIndicator) {
                        syncIndicator.classList.add('hidden');
                    }
                }, 1000);
            }
        }

        // Cargar un curso específico
        function loadCourse(courseId) {
            // Convertir a nÃºmero para comparación consistente
            const numId = typeof courseId === 'string' ? parseFloat(courseId) : courseId;
            const course = allCourses.find(c => c.id == numId); // Usar == para comparación flexible
            
            if (course) {
                courseData = course;
                currentCourseId = course.id; // Usar el ID del curso encontrado
                
                // Asegurar que config existe con valores por defecto
                if (!courseData.config) {
                    courseData.config = {
                        minGrade: 1.0,
                        maxGrade: 7.0,
                        passingGrade: 4.0,
                        passingPercentage: 60
                    };
                }
                if (!courseData.config.passingPercentage) {
                    courseData.config.passingPercentage = 60;
                }
                
                // Actualizar campos del formulario
                document.getElementById('courseName').value = courseData.courseName || '';
                document.getElementById('subject').value = courseData.subject || '';
                document.getElementById('period').value = courseData.period || '';
                
                // Cargar configuración si existe el campo
                if (document.getElementById('passingPercentage')) {
                    document.getElementById('passingPercentage').value = courseData.config.passingPercentage || 60;
                }
                
                // Actualizar selector
                document.getElementById('courseSelector').value = course.id;
                
                renderTable();
                populateStudentSelect();
                saveAllCourses();
                
                console.log('Curso cargado:', courseData.courseName, 'ID:', course.id);
            } else {
                console.error('No se encontró el curso con ID:', courseId, 'IDs disponibles:', allCourses.map(c => c.id));
            }
        }

        // Cambiar de curso
        function switchCourse() {
            // âš ï¸ CRÃTICO: Guardar curso actual ANTES de cambiar
            console.log('ðŸ’¾ Guardando curso actual antes de cambiar...');
            saveAllCourses();
            
            const selector = document.getElementById('courseSelector');
            const newCourseId = parseFloat(selector.value); // Usar parseFloat para soportar decimales
            console.log('ðŸ”„ Cambiando a curso ID:', newCourseId);
            
            // Pequeña pausa para asegurar que se guarde
            setTimeout(() => {
                loadCourse(newCourseId);
                
                // Limpiar y actualizar todas las secciones de informes
                resetInformesSection();
                
                // Mostrar confirmación
                showTemporaryMessage('✅ Curso anterior guardado y nuevo curso cargado', 'success');
            }, 100);
        }
        
        // Resetear sección de informes al cambiar de curso
        function resetInformesSection() {
            // Limpiar informe del curso
            const courseReportContent = document.getElementById('courseReportContent');
            if (courseReportContent) {
                courseReportContent.innerHTML = '<div class="text-center p-8 text-gray-500"><i class="fas fa-info-circle text-4xl mb-3"></i><p>Haga clic en "Generar Informe" para ver el informe completo del curso.</p></div>';
            }
            
            // Ocultar botón de descarga de informe de curso
            const downloadCourseReportBtn = document.getElementById('downloadCourseReportBtn');
            if (downloadCourseReportBtn) {
                downloadCourseReportBtn.style.display = 'none';
            }
            
            // Resetear selector de estudiantes para informe individual
            const studentSelect = document.getElementById('studentSelect');
            if (studentSelect) {
                studentSelect.value = '';
            }
            
            // Limpiar informe individual
            const individualReportContent = document.getElementById('individualReportContent');
            if (individualReportContent) {
                individualReportContent.classList.add('hidden');
            }
        }

        // Actualizar el selector de cursos
        function updateCourseSelector() {
            const selector = document.getElementById('courseSelector');
            
            // Validación: si el elemento no existe, intentar de nuevo después
            if (!selector) {
                console.warn('⚠️ courseSelector no encontrado, reintentando...');
                // Retry después de 100ms
                setTimeout(() => {
                    const retrySelector = document.getElementById('courseSelector');
                    if (retrySelector) {
                        updateCourseSelector();
                    }
                }, 100);
                return;
            }
            
            selector.innerHTML = '';
            
            allCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = `${course.courseName} - ${course.subject}`;
                selector.appendChild(option);
            });
            
            if (currentCourseId) {
                selector.value = currentCourseId;
            }
        }

        // Modal: Nuevo Curso
        function showNewCourseModal() {
            const courseName = prompt('Nombre del curso (ej: IV° Año A - 2025):');
            if (!courseName) return;
            
            const subject = prompt('Asignatura:');
            if (!subject) return;
            
            const period = prompt('Período:');
            if (!period) return;
            
            const newCourse = {
                id: Date.now(),
                courseName: courseName,
                subject: subject,
                period: period,
                students: [],
                tasks: [],
                config: {
                    minGrade: 1.0,
                    maxGrade: 7.0,
                    passingGrade: 4.0,
                    passingPercentage: 60
                }
            };
            
            allCourses.push(newCourse);
            updateCourseSelector();
            saveAllCourses();
            loadCourse(newCourse.id);
            
            alert('Curso creado exitosamente');
        }

        // Eliminar curso actual
        async function deleteCourse() {
            if (!confirm(`Â¿Eliminar el curso "${courseData.courseName}"? Esta acción no se puede deshacer.`)) {
                return;
            }
            
            let courseIdToDelete = currentCourseId;
            
            // ðŸ”§ DETECTAR IDs PROBLEMÃTICOS (0, decimales, inválidos)
            const isInvalidId = !courseIdToDelete || 
                               courseIdToDelete === 0 || 
                               courseIdToDelete === '0' ||
                               (typeof courseIdToDelete === 'number' && courseIdToDelete % 1 !== 0); // Decimal
            
            if (isInvalidId) {
                console.warn('âš ï¸ Curso con ID problemático:', courseIdToDelete, '- Solo eliminación local');
            }
            
            // PASO 1: Eliminar de allCourses
            const index = allCourses.findIndex(c => c.id === currentCourseId);
            if (index !== -1) {
                allCourses.splice(index, 1);
                console.log(`✅ Curso eliminado del array (posición ${index})`);
            }
            
            // PASO 2: Guardar cambios localmente INMEDIATAMENTE
            setStorageItem('allCourses', JSON.stringify(allCourses));
            console.log('ðŸ’¾ Cambios guardados en localStorage');
            
            // PASO 3: Cambiar a otro curso o limpiar interfaz
            if (allCourses.length > 0) {
                currentCourseId = allCourses[0].id;
                loadCourse(currentCourseId);
            } else {
                currentCourseId = null;
                courseData = null;
                document.getElementById('studentsTableBody').innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No hay cursos. Crea uno nuevo para comenzar.</td></tr>';
            }
            
            // PASO 4: Actualizar selector
            updateCourseSelector();
            
            // PASO 5: Si el ID es válido, intentar eliminar de la base de datos
            if (!isInvalidId) {
                try {
                const username = getCurrentUsername(); // Obtener username con namespace
                console.log('Eliminando de DB para username:', username);
                console.log('ðŸ—‘ï¸ Intentando eliminar de DB:', courseIdToDelete);
                
                const response = await fetch('/api/courses/delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        courseId: courseIdToDelete,
                        username: username  // ✅ Enviar username para respetar namespace
                    })
                });                    const result = await response.json();
                    console.log('ðŸ“¡ Respuesta del servidor:', result);
                    
                    if (!response.ok) {
                        console.warn('âš ï¸ Error en BD (pero curso ya eliminado localmente):', result.error);
                        showTemporaryMessage('✅ Curso eliminado (no estaba en base de datos)', 'success');
                    } else {
                        console.log('✅ Curso eliminado de BD también');
                        showTemporaryMessage('✅ Curso eliminado completamente', 'success');
                    }
                    
                    // Sincronizar para asegurar consistencia
                    await syncCoursesToDatabase();
                    
                } catch (error) {
                    console.error('âŒ Error de conexión (pero curso ya eliminado localmente):', error);
                    showTemporaryMessage('✅ Curso eliminado localmente', 'success');
                }
            } else {
                // ID inválido, solo confirmar eliminación local
                showTemporaryMessage('✅ Curso con ID problemático eliminado', 'success');
                
                // Sincronizar para limpiar la BD también
                try {
                    await syncCoursesToDatabase();
                } catch (e) {
                    console.warn('âš ï¸ Error sincronizando:', e);
                }
            }
        }

        // Modal: Agregar varios estudiantes
        function showBulkStudentModal() {
            const input = prompt('Pega la lista de estudiantes (formato: N°\tApellido1\tApellido2\tNombre, una fila por línea):');
            if (!input) return;
            
            const lines = input.trim().split('\n');
            let added = 0;
            
            lines.forEach(line => {
                const parts = line.split('\t');
                if (parts.length >= 4) {
                    const number = parseInt(parts[0]) || (courseData.students.length + 1);
                    const lastName1 = parts[1].trim().toUpperCase();
                    const lastName2 = parts[2].trim().toUpperCase();
                    const name = parts[3].trim().toUpperCase();
                    
                    if (lastName1 && lastName2 && name) {
                        const student = {
                            id: Date.now() + added,
                            number: number,
                            lastName1: lastName1,
                            lastName2: lastName2,
                            name: name,
                            grades: Array(courseData.tasks.length).fill(null).map(() => ({ value: null, updatedAt: new Date().toISOString() })),
                            notes: '',
                            retired: false
                        };
                        courseData.students.push(student);
                        added++;
                    }
                }
            });
            
            if (added > 0) {
                renderTable();
                saveAllCourses();
                alert(`${added} estudiantes agregados exitosamente`);
            } else {
                alert('No se pudo agregar ningÃºn estudiante. Verifica el formato.');
            }
        }

        // Gestión de Tabs
        function showTab(tab) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            // Mostrar el seleccionado
            document.getElementById('content-' + tab).classList.remove('hidden');
            
            // Actualizar estilos de tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-indigo-500', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById('tab-' + tab).classList.add('border-indigo-500', 'text-indigo-600');
            document.getElementById('tab-' + tab).classList.remove('border-transparent', 'text-gray-500');

            // Actualizar contenido si es necesario
            if (tab === 'informes') {
                renderStatistics();
            } else if (tab === 'individual') {
                populateStudentSelect();
            }
        }

        // Guardar/Cargar datos en localStorage
        function saveCourseInfo() {
            courseData.courseName = document.getElementById('courseName').value;
            courseData.subject = document.getElementById('subject').value;
            courseData.period = document.getElementById('period').value;
            saveAllCourses();
            updateCourseSelector();
        }

        // Agregar estudiante
        function addStudent() {
            const name = prompt('Nombre del estudiante:');
            const lastName1 = prompt('Apellido paterno:');
            const lastName2 = prompt('Apellido materno:');
            
            if (name && lastName1 && lastName2) {
                const student = {
                    id: Date.now(),
                    number: courseData.students.length + 1,
                    lastName1: lastName1.toUpperCase(),
                    lastName2: lastName2.toUpperCase(),
                    name: name.toUpperCase(),
                    grades: Array(courseData.tasks.length).fill(null).map(() => ({ value: null, updatedAt: new Date().toISOString() })),
                    notes: '',
                    retired: false
                };
                courseData.students.push(student);
                renderTable();
                saveAllCourses();
            }
        }

        // ============================================================
        // FUNCIONES DE EVALUACIÃ“N MULTINIVEL
        // ============================================================

        // Manejar cambio de tipo de evaluación
        function handleEvaluationTypeChange() {
            const type = document.getElementById('taskEvaluationType').value;
            const descElement = document.getElementById('evaluationTypeDescription');
            const rubricaContainer = document.getElementById('rubricaConfigContainer');

            // Descripciones por tipo
            const descriptions = {
                binary: 'Evaluación simple: marcado/desmarcado (7.0 o 1.0)',
                logro: 'Cuatro niveles: No Logrado, Medianamente Logrado, Logrado, Destacado',
                rubrica: 'Evaluación con criterios personalizados y puntajes por dimensión',
                numeric: 'Nota directa en escala 1.0 a 7.0',
                percentage: 'Porcentaje que se convertirá automáticamente a nota 1-7',
                conceptual: 'Evaluación cualitativa: Insuficiente, Suficiente, Bueno, Muy Bueno'
            };

            descElement.textContent = descriptions[type] || '';

            // Mostrar configuración de rÃºbrica si corresponde
            if (type === 'rubrica') {
                rubricaContainer.style.display = 'block';
                initializeRubricaCriteria();
            } else {
                rubricaContainer.style.display = 'none';
            }
        }

        // Inicializar criterios de rÃºbrica con valores por defecto
        function initializeRubricaCriteria() {
            const container = document.getElementById('rubricaCriteriaList');
            container.innerHTML = '';

            DEFAULT_RUBRICA_CRITERIA.forEach((criterion, index) => {
                addRubricaCriterionRow(criterion.name, criterion.weight, 4); // 4 puntos máx por defecto
            });
        }

        // Agregar un nuevo criterio de rÃºbrica
        function addRubricaCriterion() {
            addRubricaCriterionRow('', 25, 4);
        }

        // Agregar fila de criterio de rÃºbrica
        function addRubricaCriterionRow(name = '', weight = 25, maxScore = 4) {
            const container = document.getElementById('rubricaCriteriaList');
            const index = container.children.length;

            const row = document.createElement('div');
            row.className = 'flex gap-2 items-center bg-white p-2 rounded border border-gray-200';
            row.innerHTML = `
                <input type="text" 
                       class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded" 
                       placeholder="Nombre del criterio"
                       value="${name}"
                       data-criterion-index="${index}"
                       data-criterion-field="name">
                <input type="number" 
                       class="w-16 px-2 py-1 text-sm border border-gray-300 rounded" 
                       placeholder="Max"
                       value="${maxScore}"
                       min="1"
                       max="10"
                       title="Puntaje máximo"
                       data-criterion-index="${index}"
                       data-criterion-field="maxScore">
                <button type="button" 
                        onclick="removeRubricaCriterion(this)" 
                        class="text-red-500 hover:text-red-700 px-2"
                        title="Eliminar criterio">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(row);
        }

        // Eliminar criterio de rÃºbrica
        function removeRubricaCriterion(button) {
            const container = document.getElementById('rubricaCriteriaList');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                alert('âŒ Debe haber al menos un criterio en la rÃºbrica');
            }
        }

        // Obtener criterios configurados de rÃºbrica
        function getRubricaCriteria() {
            const container = document.getElementById('rubricaCriteriaList');
            const criteria = [];

            container.querySelectorAll('[data-criterion-field="name"]').forEach((input, index) => {
                const name = input.value.trim();
                const maxScoreInput = container.querySelector(`[data-criterion-index="${index}"][data-criterion-field="maxScore"]`);
                const maxScore = parseInt(maxScoreInput?.value) || 4;

                if (name) {
                    criteria.push({
                        name: name,
                        maxScore: maxScore
                    });
                }
            });

            return criteria;
        }

        // Variables para el modal de rÃºbrica
        let currentRubricaStudentIndex = null;
        let currentRubricaGradeIndex = null;

        // Abrir modal de rÃºbrica
        function openRubricaModal(studentIndex, gradeIndex) {
            const student = courseData.students[studentIndex];
            const task = courseData.tasks[gradeIndex];
            const currentGrade = student.grades[gradeIndex];

            if (!task.rubricaCriteria || task.rubricaCriteria.length === 0) {
                alert('âš ï¸ Esta tarea no tiene criterios de rÃºbrica definidos');
                return;
            }

            currentRubricaStudentIndex = studentIndex;
            currentRubricaGradeIndex = gradeIndex;

            // Actualizar título
            document.getElementById('rubricaModalTitle').textContent = 
                `${task.name} - ${student.name} ${student.lastName1}`;

            // Renderizar criterios
            const container = document.getElementById('rubricaModalCriteria');
            container.innerHTML = '';

            const existingScores = (currentGrade && currentGrade.rubricaScores) || [];

            task.rubricaCriteria.forEach((criterion, index) => {
                const currentScore = existingScores[index] || 0;
                
                const criterionDiv = document.createElement('div');
                criterionDiv.className = 'border border-gray-200 rounded-lg p-4 bg-white';
                criterionDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium text-sm">${criterion.name}</span>
                        <span class="text-sm text-gray-600">
                            <span class="rubrica-score-display font-bold text-purple-600">${currentScore}</span> / ${criterion.maxScore}
                        </span>
                    </div>
                    <input type="range" 
                           min="0" 
                           max="${criterion.maxScore}" 
                           value="${currentScore}"
                           class="rubrica-slider w-full"
                           data-criterion-index="${index}"
                           oninput="updateRubricaScore()">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        ${generateRubricaLabels(criterion.maxScore)}
                    </div>
                `;
                container.appendChild(criterionDiv);
            });

            updateRubricaScore();
            document.getElementById('rubricaModal').style.display = 'block';
        }

        // Generar labels para los niveles de la rÃºbrica
        function generateRubricaLabels(maxScore) {
            const labels = ['No logrado'];
            if (maxScore >= 3) labels.push('Básico');
            if (maxScore >= 4) labels.push('Competente');
            labels.push('Destacado');
            
            return labels.map(l => `<span>${l}</span>`).join('');
        }

        // Actualizar puntaje total de rÃºbrica
        function updateRubricaScore() {
            const sliders = document.querySelectorAll('.rubrica-slider');
            const displays = document.querySelectorAll('.rubrica-score-display');
            
            let total = 0;
            let maxTotal = 0;

            sliders.forEach((slider, index) => {
                const value = parseInt(slider.value);
                total += value;
                maxTotal += parseInt(slider.max);
                
                if (displays[index]) {
                    displays[index].textContent = value;
                }
            });

            document.getElementById('rubricaTotalScore').textContent = `${total} / ${maxTotal}`;

            // Calcular nota estimada
            const percentage = maxTotal > 0 ? (total / maxTotal) * 100 : 0;
            const estimatedGrade = 1.0 + (percentage / 100) * 6.0;
            const gradeColor = getGradeColor(estimatedGrade);
            
            document.getElementById('rubricaEstimatedGrade').textContent = estimatedGrade.toFixed(1);
            document.getElementById('rubricaEstimatedGrade').className = `text-2xl font-bold ${gradeColor}`;
        }

        // Guardar evaluación de rÃºbrica
        function saveRubricaGrade() {
            const sliders = document.querySelectorAll('.rubrica-slider');
            const scores = Array.from(sliders).map(s => parseInt(s.value));

            const rubricaValue = {
                rubricaScores: scores
            };

            updateGrade(currentRubricaStudentIndex, currentRubricaGradeIndex, rubricaValue);
            closeRubricaModal();
        }

        // Cerrar modal de rÃºbrica
        function closeRubricaModal() {
            document.getElementById('rubricaModal').style.display = 'none';
            currentRubricaStudentIndex = null;
            currentRubricaGradeIndex = null;
        }

        // Agregar tarea - Mostrar modal
        function addTask() {
            document.getElementById('taskName').value = '';
            document.getElementById('taskDate').value = '';
            document.getElementById('taskDayOfWeek').textContent = '';
            document.getElementById('taskEvaluationType').value = 'binary';
            document.getElementById('evaluationTypeDescription').textContent = 'Evaluación simple: marcado/desmarcado (7.0 o 1.0)';
            document.getElementById('rubricaConfigContainer').style.display = 'none';
            document.getElementById('taskLevel').value = '';
            document.getElementById('taskUnitContainer').style.display = 'none';
            document.getElementById('taskOAsContainer').style.display = 'none';
            document.getElementById('addTaskModal').style.display = 'block';
        }

        // Listener para mostrar día de la semana
        document.addEventListener('DOMContentLoaded', function() {
            const taskDateInput = document.getElementById('taskDate');
            if (taskDateInput) {
                taskDateInput.addEventListener('change', function() {
                    const date = new Date(this.value + 'T00:00:00');
                    const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                    const dayName = days[date.getDay()];
                    document.getElementById('taskDayOfWeek').textContent = `Día: ${dayName}`;
                });
            }
        });

        // Guardar tarea desde modal
        function saveTask() {
            const name = document.getElementById('taskName').value.trim();
            const date = document.getElementById('taskDate').value;
            const evaluationType = document.getElementById('taskEvaluationType').value;
            const level = document.getElementById('taskLevel').value;
            const unit = document.getElementById('taskUnit').value;
            
            if (!name) {
                alert('Por favor ingresa el nombre de la tarea');
                return;
            }
            
            // Recopilar OAs seleccionados
            const selectedOAs = [];
            const checkboxes = document.querySelectorAll('input[name="taskOA"]:checked');
            checkboxes.forEach(checkbox => {
                selectedOAs.push({
                    codigo: checkbox.value,
                    nivel: checkbox.dataset.nivel,
                    unidad: checkbox.dataset.unidad
                });
            });
            
            const task = {
                id: Date.now(),
                name: name,
                date: date || '',
                evaluationType: evaluationType, // Nuevo campo
                nivel: level || null,
                unidad: unit || null,
                oas: selectedOAs
            };

            // Si es tipo rÃºbrica, agregar criterios
            if (evaluationType === 'rubrica') {
                const criteria = getRubricaCriteria();
                if (criteria.length === 0) {
                    alert('âš ï¸ Debes definir al menos un criterio para la rÃºbrica');
                    return;
                }
                task.rubricaCriteria = criteria;
            }

            courseData.tasks.push(task);
            
            // Agregar columna de nota a cada estudiante con el tipo de evaluación
            const timestamp = new Date().toISOString();
            courseData.students.forEach(student => {
                student.grades.push({ 
                    value: null, 
                    updatedAt: timestamp,
                    evaluationType: task.evaluationType || 'binary'
                });
            });
            
            console.log(`✅ Tarea "${task.name}" agregada. Total tareas: ${courseData.tasks.length}`);
            console.log(`ðŸ“Š Estudiantes actualizados: ${courseData.students.length} estudiantes tienen ahora ${courseData.students[0]?.grades.length || 0} columnas de notas`);
            
            closeAddTaskModal();
            renderTable();
            saveAllCourses();
            
            // Mostrar confirmación con OAs
            if (selectedOAs.length > 0) {
                const oasList = selectedOAs.map(oa => oa.codigo).join(', ');
                showTemporaryMessage(`✅ Tarea "${name}" creada con OAs: ${oasList}`);
            }
        }

        // Eliminar tarea (solo admin)
        function deleteTask(taskIndex) {
            // Verificar permisos
            const userRole = sessionStorage.getItem('userRole') || 'teacher';
            if (userRole !== 'admin') {
                alert('âš ï¸ Solo el administrador puede eliminar tareas');
                return;
            }
            
            if (!courseData || !courseData.tasks || taskIndex < 0 || taskIndex >= courseData.tasks.length) {
                alert('âŒ Error: Tarea no encontrada');
                return;
            }
            
            const task = courseData.tasks[taskIndex];
            const taskName = task.name || `Tarea ${taskIndex + 1}`;
            
            // Confirmar eliminación
            const confirmDelete = confirm(
                `Â¿Estás seguro de eliminar la tarea "${taskName}"?\n\n` +
                `âš ï¸ Se eliminarán todas las notas de esta tarea para todos los estudiantes.\n` +
                `Esta acción NO se puede deshacer.`
            );
            
            if (!confirmDelete) return;
            
            // Eliminar tarea del array
            courseData.tasks.splice(taskIndex, 1);
            
            // Eliminar la nota correspondiente de todos los estudiantes
            courseData.students.forEach(student => {
                if (student.grades && student.grades.length > taskIndex) {
                    student.grades.splice(taskIndex, 1);
                }
            });
            
            // Guardar cambios y actualizar interfaz
            saveAllCourses();
            renderTable();
            
            // Mostrar confirmación
            showTemporaryMessage(`✅ Tarea "${taskName}" eliminada correctamente`, 'success');
        }

        // Editar tarea (solo admin)
        function editTask(taskIndex) {
            const userRole = sessionStorage.getItem('userRole') || 'teacher';
            if (userRole !== 'admin') {
                alert('âš ï¸ Solo el administrador puede editar tareas');
                return;
            }
            
            if (!courseData || !courseData.tasks || taskIndex < 0 || taskIndex >= courseData.tasks.length) {
                alert('âŒ Error: Tarea no encontrada');
                return;
            }
            
            const task = courseData.tasks[taskIndex];
            
            // Crear modal de edición
            const modal = document.createElement('div');
            modal.id = 'editTaskModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.style.display = 'flex';
            
            const oasList = task.oas && task.oas.length > 0 
                ? task.oas.map(oa => oa.codigo).join(', ') 
                : 'Sin OAs';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-edit text-yellow-500 mr-2"></i>Editar Tarea
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Nombre de la Tarea
                            </label>
                            <input type="text" id="editTaskName" value="${task.name}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Fecha
                            </label>
                            <input type="date" id="editTaskDate" value="${task.date}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                        </div>
                        
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-700">
                                <i class="fas fa-bullseye text-blue-500 mr-2"></i>
                                <strong>OAs actuales:</strong> ${oasList}
                            </p>
                            <p class="text-xs text-gray-500 mt-1">
                                Para cambiar OAs, deberás eliminar y crear una nueva tarea.
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="closeEditTaskModal()" 
                                class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg font-medium transition-colors">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                        <button onclick="saveTaskEdit(${taskIndex})" 
                                class="flex-1 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-medium transition-colors">
                            <i class="fas fa-save mr-2"></i>Guardar Cambios
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeEditTaskModal() {
            const modal = document.getElementById('editTaskModal');
            if (modal) modal.remove();
        }
        
        function saveTaskEdit(taskIndex) {
            const newName = document.getElementById('editTaskName').value.trim();
            const newDate = document.getElementById('editTaskDate').value;
            
            if (!newName) {
                alert('âš ï¸ El nombre de la tarea no puede estar vacío');
                return;
            }
            
            const oldName = courseData.tasks[taskIndex].name;
            courseData.tasks[taskIndex].name = newName;
            courseData.tasks[taskIndex].date = newDate;
            
            closeEditTaskModal();
            saveAllCourses();
            renderTable();
            
            showTemporaryMessage(`✅ Tarea actualizada: "${oldName}" â†’ "${newName}"`, 'success');
        }

        // Mover tarea hacia arriba (solo admin)
        function moveTaskUp(taskIndex) {
            const userRole = sessionStorage.getItem('userRole') || 'teacher';
            if (userRole !== 'admin') {
                alert('âš ï¸ Solo el administrador puede reordenar tareas');
                return;
            }
            
            if (taskIndex <= 0 || taskIndex >= courseData.tasks.length) {
                return;
            }
            
            // Intercambiar tareas
            const temp = courseData.tasks[taskIndex];
            courseData.tasks[taskIndex] = courseData.tasks[taskIndex - 1];
            courseData.tasks[taskIndex - 1] = temp;
            
            // Intercambiar notas de todos los estudiantes
            courseData.students.forEach(student => {
                const tempGrade = student.grades[taskIndex];
                student.grades[taskIndex] = student.grades[taskIndex - 1];
                student.grades[taskIndex - 1] = tempGrade;
            });
            
            saveAllCourses();
            renderTable();
            showTemporaryMessage('✅ Tarea movida hacia la izquierda', 'success');
        }

        // Mover tarea hacia abajo (solo admin)
        function moveTaskDown(taskIndex) {
            const userRole = sessionStorage.getItem('userRole') || 'teacher';
            if (userRole !== 'admin') {
                alert('âš ï¸ Solo el administrador puede reordenar tareas');
                return;
            }
            
            if (taskIndex < 0 || taskIndex >= courseData.tasks.length - 1) {
                return;
            }
            
            // Intercambiar tareas
            const temp = courseData.tasks[taskIndex];
            courseData.tasks[taskIndex] = courseData.tasks[taskIndex + 1];
            courseData.tasks[taskIndex + 1] = temp;
            
            // Intercambiar notas de todos los estudiantes
            courseData.students.forEach(student => {
                const tempGrade = student.grades[taskIndex];
                student.grades[taskIndex] = student.grades[taskIndex + 1];
                student.grades[taskIndex + 1] = tempGrade;
            });
            
            saveAllCourses();
            renderTable();
            showTemporaryMessage('✅ Tarea movida hacia la derecha', 'success');
        }

        // Eliminar mÃºltiples tareas (solo admin)
        function deleteMultipleTasks() {
            const userRole = sessionStorage.getItem('userRole') || 'teacher';
            if (userRole !== 'admin') {
                alert('âš ï¸ Solo el administrador puede eliminar tareas');
                return;
            }
            
            if (!courseData || !courseData.tasks || courseData.tasks.length === 0) {
                alert('âš ï¸ No hay tareas para eliminar');
                return;
            }
            
            // Crear modal de selección
            const modal = document.createElement('div');
            modal.id = 'deleteMultipleTasksModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.style.display = 'flex';
            
            let tasksList = '';
            courseData.tasks.forEach((task, index) => {
                tasksList += `
                    <div class="flex items-center p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" id="deleteTask${index}" value="${index}" 
                               class="w-4 h-4 text-red-600 rounded mr-3">
                        <label for="deleteTask${index}" class="flex-1 cursor-pointer">
                            <span class="font-medium">${task.name}</span>
                            <span class="text-xs text-gray-500 ml-2">${task.date || ''}</span>
                        </label>
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-trash-alt text-red-500 mr-2"></i>Eliminar MÃºltiples Tareas
                    </h3>
                    
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-4">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>Advertencia:</strong> Esta acción eliminará las tareas seleccionadas 
                            y todas sus notas asociadas. No se puede deshacer.
                        </p>
                    </div>
                    
                    <div class="mb-4">
                        <button onclick="selectAllTasks()" 
                                class="text-sm text-blue-600 hover:text-blue-800 mr-4">
                            <i class="fas fa-check-square mr-1"></i>Seleccionar Todas
                        </button>
                        <button onclick="deselectAllTasks()" 
                                class="text-sm text-gray-600 hover:text-gray-800">
                            <i class="fas fa-square mr-1"></i>Deseleccionar Todas
                        </button>
                    </div>
                    
                    <div class="border border-gray-200 rounded-lg p-4 mb-4 max-h-96 overflow-y-auto">
                        ${tasksList}
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="closeDeleteMultipleTasksModal()" 
                                class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg font-medium transition-colors">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                        <button onclick="confirmDeleteMultipleTasks()" 
                                class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-colors">
                            <i class="fas fa-trash mr-2"></i>Eliminar Seleccionadas
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function selectAllTasks() {
            const checkboxes = document.querySelectorAll('[id^="deleteTask"]');
            checkboxes.forEach(cb => cb.checked = true);
        }
        
        function deselectAllTasks() {
            const checkboxes = document.querySelectorAll('[id^="deleteTask"]');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        function closeDeleteMultipleTasksModal() {
            const modal = document.getElementById('deleteMultipleTasksModal');
            if (modal) modal.remove();
        }
        
        function confirmDeleteMultipleTasks() {
            const checkboxes = document.querySelectorAll('[id^="deleteTask"]:checked');
            
            if (checkboxes.length === 0) {
                alert('âš ï¸ No has seleccionado ninguna tarea');
                return;
            }
            
            const selectedIndexes = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const taskNames = selectedIndexes.map(i => courseData.tasks[i].name).join(', ');
            
            const confirmDelete = confirm(
                `Â¿Estás seguro de eliminar ${checkboxes.length} tarea(s)?\n\n` +
                `Tareas: ${taskNames}\n\n` +
                `âš ï¸ Se eliminarán todas las notas de estas tareas para todos los estudiantes.\n` +
                `Esta acción NO se puede deshacer.`
            );
            
            if (!confirmDelete) return;
            
            // Ordenar índices de mayor a menor para eliminar sin problemas
            selectedIndexes.sort((a, b) => b - a);
            
            // Eliminar tareas y notas
            selectedIndexes.forEach(index => {
                courseData.tasks.splice(index, 1);
                courseData.students.forEach(student => {
                    student.grades.splice(index, 1);
                });
            });
            
            closeDeleteMultipleTasksModal();
            saveAllCourses();
            renderTable();
            
            showTemporaryMessage(`✅ ${checkboxes.length} tarea(s) eliminada(s) correctamente`, 'success');
        }

        // Cerrar modal de agregar tarea
        function closeAddTaskModal() {
            document.getElementById('addTaskModal').style.display = 'none';
        }

        // ============================================
        // FUNCIONES DE GESTIÃ“N AVANZADA
        // ============================================

        // Mostrar lista de estudiantes para editar
        function showEditStudentsList() {
            if (!courseData || !courseData.students || courseData.students.length === 0) {
                alert('âš ï¸ No hay estudiantes en el curso');
                return;
            }
            
            let html = '<div style="max-height: 500px; overflow-y: auto;">';
            html += '<h4 class="text-lg font-bold mb-4 text-gray-800">Lista de Estudiantes</h4>';
            html += '<div class="space-y-2">';
            
            courseData.students.forEach((student, index) => {
                const retiredBadge = student.retired ? '<span class="text-xs bg-gray-400 text-white px-2 py-1 rounded">Retirado</span>' : '';
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded hover:bg-gray-100">
                        <div>
                            <span class="font-medium">${student.number}. ${student.name} ${student.lastName1} ${student.lastName2}</span>
                            ${retiredBadge}
                        </div>
                        <button onclick="editStudent(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-edit mr-1"></i>Editar
                        </button>
                    </div>
                `;
            });
            
            html += '</div></div>';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg">
                        <h3 class="text-lg font-bold">
                            <i class="fas fa-users-cog mr-2"></i>Gestión de Estudiantes
                        </h3>
                    </div>
                    <div class="p-6">
                        ${html}
                        <button onclick="this.closest('.modal').remove()" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-times mr-2"></i>Cerrar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Mostrar lista de tareas
        function showTasksList() {
            if (!courseData || !courseData.tasks || courseData.tasks.length === 0) {
                alert('âš ï¸ No hay tareas en el curso');
                return;
            }
            
            let html = '<div style="max-height: 500px; overflow-y: auto;">';
            html += '<h4 class="text-lg font-bold mb-4 text-gray-800">Lista de Tareas</h4>';
            html += '<div class="space-y-2">';
            
            courseData.tasks.forEach((task, index) => {
                const oasText = task.oas && task.oas.length > 0 ? 
                    `<div class="text-xs text-blue-600 mt-1">OAs: ${task.oas.map(oa => oa.codigo).join(', ')}</div>` : '';
                html += `
                    <div class="p-3 bg-gray-50 rounded hover:bg-gray-100">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium">${index + 1}. ${task.name}</div>
                                <div class="text-sm text-gray-600">${task.date || 'Sin fecha'}</div>
                                ${oasText}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg">
                        <h3 class="text-lg font-bold">
                            <i class="fas fa-tasks mr-2"></i>Todas las Tareas
                        </h3>
                    </div>
                    <div class="p-6">
                        ${html}
                        <button onclick="this.closest('.modal').remove()" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-times mr-2"></i>Cerrar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Editar tareas modal
        function showEditTasksModal() {
            if (!courseData || !courseData.tasks || courseData.tasks.length === 0) {
                alert('âš ï¸ No hay tareas en el curso');
                return;
            }
            
            let html = '<div style="max-height: 500px; overflow-y: auto;">';
            html += '<h4 class="text-lg font-bold mb-4 text-gray-800">Editar Tareas</h4>';
            html += '<div class="space-y-2">';
            
            courseData.tasks.forEach((task, index) => {
                html += `
                    <div class="p-3 bg-gray-50 rounded">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                            <input type="text" id="taskName_${index}" value="${task.name}" 
                                   class="px-2 py-1 border rounded" placeholder="Nombre">
                            <input type="date" id="taskDate_${index}" value="${task.date || ''}" 
                                   class="px-2 py-1 border rounded">
                            <button onclick="updateTask(${index})" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">
                                <i class="fas fa-save mr-1"></i>Guardar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="bg-purple-600 text-white px-6 py-4 rounded-t-lg">
                        <h3 class="text-lg font-bold">
                            <i class="fas fa-edit mr-2"></i>Editar Tareas
                        </h3>
                    </div>
                    <div class="p-6">
                        ${html}
                        <button onclick="this.closest('.modal').remove()" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-times mr-2"></i>Cerrar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Actualizar tarea
        function updateTask(taskIndex) {
            const newName = document.getElementById(`taskName_${taskIndex}`).value.trim();
            const newDate = document.getElementById(`taskDate_${taskIndex}`).value;
            
            if (!newName) {
                alert('âš ï¸ El nombre de la tarea no puede estar vacío');
                return;
            }
            
            courseData.tasks[taskIndex].name = newName;
            courseData.tasks[taskIndex].date = newDate;
            
            saveAllCourses();
            renderTable();
            showTemporaryMessage('✅ Tarea actualizada correctamente', 'success');
        }

        // Llenar todas las notas
        function fillAllGrades(value) {
            if (!courseData || !courseData.students) return;
            
            const confirm = window.confirm(
                value ? 
                'Â¿Marcar TODAS las notas como completadas?' : 
                'Â¿Desmarcar TODAS las notas?'
            );
            
            if (!confirm) return;
            
            const timestamp = new Date().toISOString();
            courseData.students.forEach(student => {
                if (!student.retired) {
                    student.grades = student.grades.map(() => ({
                        value: value,
                        updatedAt: timestamp
                    }));
                }
            });
            
            renderTable();
            saveAllCourses();
            showTemporaryMessage(
                value ? '✅ Todas las notas marcadas' : '✅ Todas las notas desmarcadas', 
                'success'
            );
        }

        // Llenar columna de tarea
        function fillTaskColumn() {
            if (!courseData || !courseData.tasks || courseData.tasks.length === 0) {
                alert('âš ï¸ No hay tareas en el curso');
                return;
            }
            
            const taskIndex = prompt(`Ingrese el nÃºmero de tarea (1-${courseData.tasks.length}):`);
            if (!taskIndex) return;
            
            const index = parseInt(taskIndex) - 1;
            if (index < 0 || index >= courseData.tasks.length) {
                alert('âŒ NÃºmero de tarea inválido');
                return;
            }
            
            const value = confirm('Â¿Marcar como completada (Aceptar) o pendiente (Cancelar)?');
            
            const timestamp = new Date().toISOString();
            courseData.students.forEach(student => {
                if (!student.retired) {
                    student.grades[index] = {
                        value: value,
                        updatedAt: timestamp
                    };
                }
            });
            
            renderTable();
            saveAllCourses();
            showTemporaryMessage(`✅ Columna "${courseData.tasks[index].name}" actualizada`, 'success');
        }

        // â­ NUEVA: Marcar/Desmarcar UNA tarea específica con 1 click
        function quickMarkTask(value) {
            if (!courseData || !courseData.tasks || courseData.tasks.length === 0) {
                alert('âš ï¸ No hay tareas en el curso');
                return;
            }
            
            // Crear lista de tareas para seleccionar
            let taskList = 'ðŸ“‹ Selecciona la tarea:\n\n';
            courseData.tasks.forEach((task, index) => {
                taskList += `${index + 1}. ${task.name}${task.date ? ` (${task.date})` : ''}\n`;
            });
            
            const taskIndex = prompt(taskList + '\nIngrese el nÃºmero:');
            if (!taskIndex) return;
            
            const index = parseInt(taskIndex) - 1;
            if (index < 0 || index >= courseData.tasks.length) {
                alert('âŒ NÃºmero de tarea inválido');
                return;
            }
            
            // Marcar/Desmarcar para todos los estudiantes activos
            const timestamp = new Date().toISOString();
            courseData.students.forEach(student => {
                if (!student.retired) {
                    student.grades[index] = {
                        value: value,
                        updatedAt: timestamp
                    };
                }
            });
            
            renderTable();
            saveAllCourses();
            
            const action = value ? 'marcada âœ“' : 'desmarcada âœ—';
            showTemporaryMessage(`✅ Tarea "${courseData.tasks[index].name}" ${action} para todos`, 'success');
        }

        // â­ NUEVA: Agregar mÃºltiples tareas de una vez
        function addMultipleTasks() {
            if (!courseData) return;
            
            const input = prompt(
                'ðŸ“ Ingresa los nombres de las tareas (una por línea):\n\n' +
                'Ejemplo:\n' +
                'Tarea 1\n' +
                'Tarea 2\n' +
                'Tarea 3'
            );
            
            if (!input || !input.trim()) return;
            
            const lines = input.trim().split('\n');
            let added = 0;
            
            lines.forEach(line => {
                const taskName = line.trim();
                if (taskName) {
                    const newTask = {
                        id: Date.now() + added,
                        name: taskName,
                        date: '',
                        nivel: null,
                        unidad: null,
                        oas: []
                    };
                    
                    courseData.tasks.push(newTask);
                    
                    // Agregar columna vacía para cada estudiante
                    courseData.students.forEach(student => {
                        student.grades.push({ value: null, updatedAt: new Date().toISOString() });
                    });
                    
                    added++;
                }
            });
            
            if (added > 0) {
                renderTable();
                saveAllCourses();
                showTemporaryMessage(`✅ ${added} tarea(s) agregada(s) correctamente`, 'success');
            } else {
                alert('âŒ No se agregó ninguna tarea');
            }
        }

        // Edición masiva de notas
        function showBulkGradeEdit() {
            alert('ðŸš§ Función en desarrollo\n\nPermitirá editar mÃºltiples notas a la vez mediante una interfaz avanzada.');
        }

        // Editar info del curso (redirige a la tab principal)
        function editCourseInfo() {
            showTab('curso');
            document.getElementById('courseName').focus();
            showTemporaryMessage('âœï¸ Edita la información en los campos superiores', 'info');
        }

        // Duplicar curso
        function duplicateCourse() {
            if (!courseData) return;
            
            const newName = prompt('Nombre del nuevo curso:', courseData.name + ' (Copia)');
            if (!newName) return;
            
            const newCourse = JSON.parse(JSON.stringify(courseData));
            newCourse.id = Date.now();
            newCourse.name = newName;
            
            allCourses.push(newCourse);
            saveAllCourses();
            updateCourseSelector();
            
            showTemporaryMessage(`✅ Curso "${newName}" creado correctamente`, 'success');
        }
        // Exportar datos del curso
        function exportCourseData() {
            if (!courseData) return;
            
            const data = JSON.stringify(courseData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${courseData.name}_export.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showTemporaryMessage('✅ Datos exportados correctamente', 'success');
        }

        // Exportar a JSON
        function exportToJSON() {
            exportCourseData();
        }

        // Importar desde JSON
        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    imported.id = Date.now();
                    imported.name = imported.name + ' (Importado)';
                    
                    allCourses.push(imported);
                    saveAllCourses();
                    updateCourseSelector();
                    
                    showTemporaryMessage('✅ Curso importado correctamente', 'success');
                } catch (error) {
                    alert('âŒ Error al importar el archivo:\n' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Imprimir curso
        function printCourse() {
            window.print();
        }

        // Renderizar celda de evaluación segÃºn tipo
        function renderGradeCell(studentIndex, gradeIndex, grade, task, isRetired) {
            const evaluationType = task.evaluationType || 'binary'; // Por defecto binario para retrocompatibilidad
            const gradeValue = getGradeValue(grade);
            const disabled = isRetired ? 'disabled' : '';

            switch (evaluationType) {
                case EVALUATION_TYPES.BINARY:
                    const isChecked = gradeValue === true || gradeValue === 1;
                    return `
                        <input type="checkbox" ${isChecked ? 'checked' : ''} 
                               onchange="updateGrade(${studentIndex}, ${gradeIndex}, this.checked)"
                               class="w-4 h-4 text-indigo-600 rounded" ${disabled}>
                    `;

                case EVALUATION_TYPES.LOGRO:
                    const logroValue = gradeValue || '';
                    return `
                        <select onchange="updateGrade(${studentIndex}, ${gradeIndex}, this.value)"
                                class="w-full text-xs px-1 py-1 border rounded" ${disabled}>
                            <option value="">-</option>
                            <option value="NL" ${logroValue === 'NL' ? 'selected' : ''}>ðŸ”´ NL</option>
                            <option value="ML" ${logroValue === 'ML' ? 'selected' : ''}>ðŸŸ¡ ML</option>
                            <option value="L" ${logroValue === 'L' ? 'selected' : ''}>ðŸŸ¢ L</option>
                            <option value="D" ${logroValue === 'D' ? 'selected' : ''}>ðŸ”µ D</option>
                        </select>
                    `;

                case EVALUATION_TYPES.CONCEPTUAL:
                    const conceptualValue = gradeValue || '';
                    return `
                        <select onchange="updateGrade(${studentIndex}, ${gradeIndex}, this.value)"
                                class="w-full text-xs px-1 py-1 border rounded" ${disabled}>
                            <option value="">-</option>
                            <option value="I" ${conceptualValue === 'I' ? 'selected' : ''}>I</option>
                            <option value="S" ${conceptualValue === 'S' ? 'selected' : ''}>S</option>
                            <option value="B" ${conceptualValue === 'B' ? 'selected' : ''}>B</option>
                            <option value="MB" ${conceptualValue === 'MB' ? 'selected' : ''}>MB</option>
                        </select>
                    `;

                case EVALUATION_TYPES.NUMERIC:
                    const numericValue = gradeValue || '';
                    return `
                        <input type="number" 
                               value="${numericValue}" 
                               min="1.0" 
                               max="7.0" 
                               step="0.1"
                               onchange="updateGrade(${studentIndex}, ${gradeIndex}, parseFloat(this.value))"
                               class="w-full text-xs px-1 py-1 border rounded text-center" 
                               placeholder="-" ${disabled}>
                    `;

                case EVALUATION_TYPES.PERCENTAGE:
                    const pctValue = gradeValue || '';
                    return `
                        <input type="number" 
                               value="${pctValue}" 
                               min="0" 
                               max="100" 
                               step="1"
                               onchange="updateGrade(${studentIndex}, ${gradeIndex}, parseInt(this.value))"
                               class="w-full text-xs px-1 py-1 border rounded text-center" 
                               placeholder="-" ${disabled}>
                    `;

                case EVALUATION_TYPES.RUBRICA:
                    const rubricaLabel = grade && grade.rubricaScores ? 'ðŸ“' : '-';
                    return `
                        <button onclick="openRubricaModal(${studentIndex}, ${gradeIndex})"
                                class="w-full px-1 py-1 text-xs bg-blue-100 hover:bg-blue-200 rounded border border-blue-300"
                                ${disabled}>
                            ${rubricaLabel}
                        </button>
                    `;

                default:
                    return `<span class="text-gray-400">-</span>`;
            }
        }

        // Helper: Extraer el valor de una nota (compatible con formato antiguo y nuevo)
        function getGradeValue(grade) {
            // Formato nuevo: { value: boolean, updatedAt: string }
            if (grade && typeof grade === 'object' && 'value' in grade) {
                return grade.value;
            }
            // Formato antiguo: boolean o null directo
            return grade;
        }

        // Helper: Extraer timestamp de una nota (si existe)
        function getGradeTimestamp(grade) {
            if (grade && typeof grade === 'object' && 'updatedAt' in grade) {
                return grade.updatedAt;
            }
            return null;
        }

        // Helper: Verificar si una tarea está completada (tiene calificación válida)
        function isTaskCompleted(grade, task) {
            if (!grade) return false;
            
            const gradeValue = getGradeValue(grade);
            
            // Si el valor es null o undefined, no está completada
            if (gradeValue === null || gradeValue === undefined) {
                return false;
            }
            
            const evaluationType = task?.evaluationType || 'binary';
            
            // Para evaluaciones binarias: true = completada
            if (evaluationType === EVALUATION_TYPES.BINARY) {
                return gradeValue === true;
            }
            
            // Para otros tipos: cualquier valor no-null es completada
            // (porque ya pasó la validación anterior)
            return true;
        }

        // Renderizar tabla
        function renderTable() {
            if (!courseData) {
                console.warn('No hay courseData para renderizar');
                return;
            }
            
            const thead = document.querySelector('#gradesTable thead tr');
            const tbody = document.getElementById('studentsTableBody');
            
            if (!thead || !tbody) {
                console.error('No se encontraron elementos de la tabla');
                return;
            }
            
            // Limpiar y regenerar encabezados de tareas
            while (thead.children.length > 5) {
                thead.removeChild(thead.lastChild);
            }
            
            courseData.tasks.forEach((task, index) => {
                const th = document.createElement('th');
                th.className = 'px-2 py-3 text-center text-xs font-medium uppercase';
                
                let oasInfo = '';
                if (task.oas && task.oas.length > 0) {
                    const oasList = task.oas.map(oa => oa.codigo).join(', ');
                    oasInfo = `
                        <div class="text-[10px] font-normal text-blue-300" title="${oasList}">
                            <i class="fas fa-bullseye"></i> ${oasList}
                        </div>
                    `;
                }
                
                // Botones de gestión solo para admin
                const userRole = sessionStorage.getItem('userRole') || 'teacher';
                const adminButtons = userRole === 'admin' ? `
                    <div class="flex items-center justify-center gap-1 mt-1">
                        ${index > 0 ? `
                            <button onclick="moveTaskUp(${index})" 
                                    class="text-blue-400 hover:text-blue-200 text-xs transition-colors"
                                    title="Mover arriba">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        ` : '<span class="w-4"></span>'}
                        
                        <button onclick="editTask(${index})" 
                                class="text-yellow-400 hover:text-yellow-200 text-xs transition-colors"
                                title="Editar tarea">
                            <i class="fas fa-edit"></i>
                        </button>
                        
                        <button onclick="deleteTask(${index})" 
                                class="text-red-400 hover:text-red-200 text-xs transition-colors"
                                title="Eliminar tarea">
                            <i class="fas fa-trash"></i>
                        </button>
                        
                        ${index < courseData.tasks.length - 1 ? `
                            <button onclick="moveTaskDown(${index})" 
                                    class="text-blue-400 hover:text-blue-200 text-xs transition-colors"
                                    title="Mover abajo">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        ` : '<span class="w-4"></span>'}
                    </div>
                ` : '';
                
                th.innerHTML = `
                    <div class="font-semibold">${task.name}</div>
                    <div class="text-[10px] font-normal">${task.date}</div>
                    ${oasInfo}
                    ${adminButtons}
                `;
                thead.insertBefore(th, thead.children[thead.children.length - 1]);
            });
            
            // Agregar columnas de Puntos y Nota
            const thPoints = document.createElement('th');
            thPoints.className = 'px-2 py-3 text-center text-xs font-medium uppercase bg-indigo-600';
            thPoints.textContent = 'PUNTOS';
            thead.insertBefore(thPoints, thead.children[thead.children.length - 1]);
            
            const thGrade = document.createElement('th');
            thGrade.className = 'px-2 py-3 text-center text-xs font-medium uppercase bg-purple-600';
            thGrade.textContent = 'NOTA';
            thead.insertBefore(thGrade, thead.children[thead.children.length - 1]);
            
            // Renderizar estudiantes
            tbody.innerHTML = '';
            courseData.students.forEach((student, studentIndex) => {
                const tr = document.createElement('tr');
                tr.className = 'student-row';
                
                // Agregar clase si está retirado
                if (student.retired) {
                    tr.classList.add('retired');
                }
                
                let totalPoints = 0;
                let html = `
                    <td class="px-4 py-3 text-sm">${student.number}</td>
                    <td class="px-4 py-3 text-sm font-medium">${student.lastName1}</td>
                    <td class="px-4 py-3 text-sm">${student.lastName2}</td>
                    <td class="px-4 py-3 text-sm">${student.name}</td>
                `;
                
                // Columnas de tareas - ITERAR SOBRE TASKS (fuente de verdad)
                const gradesConverted = [];
                courseData.tasks.forEach((task, gradeIndex) => {
                    // Obtener la nota correspondiente (puede ser undefined si falta)
                    const grade = student.grades[gradeIndex] || { value: null, updatedAt: new Date().toISOString(), evaluationType: task.evaluationType };
                    
                    // Si falta la nota, agregarla automáticamente (corrección de inconsistencias)
                    if (!student.grades[gradeIndex]) {
                        student.grades[gradeIndex] = grade;
                        console.warn(`âš ï¸ Nota faltante para estudiante ${student.name} en tarea ${gradeIndex}, agregada automáticamente`);
                    }

                    const cellHtml = renderGradeCell(studentIndex, gradeIndex, grade, task, student.retired);
                    html += `<td class="px-2 py-3 text-center">${cellHtml}</td>`;

                    // Convertir a escala comÃºn para el promedio
                    const converted = convertToCommonScale(grade, task.evaluationType, task);
                    if (converted !== null) {
                        gradesConverted.push(converted);
                    }
                });
                
                // Calcular nota promedio
                const finalGrade = gradesConverted.length > 0
                    ? gradesConverted.reduce((a, b) => a + b, 0) / gradesConverted.length
                    : null;
                
                const gradeDisplay = finalGrade !== null ? finalGrade.toFixed(1) : '-';
                const gradeColor = finalGrade !== null ? getGradeColor(finalGrade) : 'text-gray-400';
                
                html += `
                    <td class="px-2 py-3 text-center font-bold text-indigo-600">${gradesConverted.length}</td>
                    <td class="px-2 py-3 text-center font-bold text-lg ${gradeColor}">${gradeDisplay}</td>
                    <td class="px-4 py-3 text-center no-print space-x-2">
                        <button onclick="showEditStudentModal(${studentIndex})" class="text-blue-600 hover:text-blue-800" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteStudent(${studentIndex})" class="text-red-600 hover:text-red-800" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }

        // Calcular nota basada en porcentaje de exigencia
        function calculateGrade(points, maxPoints) {
            if (maxPoints === 0) return 1.0;
            
            const percentage = (points / maxPoints) * 100;
            const passingPercentage = courseData.config?.passingPercentage || 60;
            
            if (percentage >= passingPercentage) {
                // De passingPercentage% a 100% â†’ de 4.0 a 7.0
                const factor = (percentage - passingPercentage) / (100 - passingPercentage);
                return 4.0 + (factor * 3.0);
            } else {
                // De 0% a passingPercentage% â†’ de 1.0 a 3.9
                const factor = percentage / passingPercentage;
                return 1.0 + (factor * 2.9);
            }
        }

        // Actualizar nota (sin mensaje de confirmación)
        function updateGrade(studentIndex, gradeIndex, value) {
            const student = courseData.students[studentIndex];
            const task = courseData.tasks[gradeIndex];
            
            if (!task) {
                console.error('Tarea no encontrada');
                return;
            }

            const evaluationType = task.evaluationType || 'binary';
            
            // Validar valor segÃºn tipo
            let validatedValue = value;
            
            switch (evaluationType) {
                case EVALUATION_TYPES.BINARY:
                    validatedValue = Boolean(value);
                    break;
                    
                case EVALUATION_TYPES.LOGRO:
                case EVALUATION_TYPES.CONCEPTUAL:
                    validatedValue = value || null;
                    break;
                    
                case EVALUATION_TYPES.NUMERIC:
                    const num = parseFloat(value);
                    validatedValue = (num >= 1.0 && num <= 7.0) ? num : null;
                    break;
                    
                case EVALUATION_TYPES.PERCENTAGE:
                    const pct = parseInt(value);
                    validatedValue = (pct >= 0 && pct <= 100) ? pct : null;
                    break;
                    
                case EVALUATION_TYPES.RUBRICA:
                    // Para rÃºbrica, el valor viene del modal
                    validatedValue = value;
                    break;
            }

            // Actualizar con nuevo formato
            student.grades[gradeIndex] = {
                value: validatedValue,
                updatedAt: new Date().toISOString(),
                evaluationType: evaluationType
            };

            // Si es rÃºbrica y tiene scores, agregar
            if (evaluationType === EVALUATION_TYPES.RUBRICA && value && typeof value === 'object') {
                student.grades[gradeIndex].rubricaScores = value.rubricaScores || null;
            }
            
            console.log(`ðŸ“ Nota actualizada: Estudiante ${studentIndex}, Tarea ${gradeIndex} (${evaluationType}), Valor:`, validatedValue);
            
            renderTable();
            saveAllCourses();
        }

        // Mostrar modal de edición de estudiante
        function showEditStudentModal(index) {
            const student = courseData.students[index];
            document.getElementById('editStudentIndex').value = index;
            document.getElementById('editStudentNumber').value = student.number;
            document.getElementById('editStudentLastName1').value = student.lastName1;
            document.getElementById('editStudentLastName2').value = student.lastName2;
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentRetired').checked = student.retired || false;
            document.getElementById('editStudentModal').style.display = 'block';
        }

        // Guardar edición de estudiante
        function saveStudentEdit() {
            const index = parseInt(document.getElementById('editStudentIndex').value);
            const student = courseData.students[index];
            
            student.number = parseInt(document.getElementById('editStudentNumber').value);
            student.lastName1 = document.getElementById('editStudentLastName1').value.toUpperCase();
            student.lastName2 = document.getElementById('editStudentLastName2').value.toUpperCase();
            student.name = document.getElementById('editStudentName').value.toUpperCase();
            student.retired = document.getElementById('editStudentRetired').checked;
            
            closeEditStudentModal();
            renderTable();
            saveAllCourses();
        }

        // Cerrar modal de edición
        function closeEditStudentModal() {
            document.getElementById('editStudentModal').style.display = 'none';
        }

        // Eliminar estudiante
        function deleteStudent(index) {
            if (confirm('Â¿Está seguro de eliminar este estudiante?')) {
                courseData.students.splice(index, 1);
                renderTable();
                saveAllCourses();
            }
        }

        // ContinÃºa en la parte 2...
        
    </script>

    <script>
        // Parte 2 del JavaScript - Importación y Exportación
        
        // Importar desde CSV
        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                
                if (lines.length < 1) {
                    alert('âŒ El archivo CSV está vacío');
                    return;
                }
                
                // ðŸ” DETECTAR AUTOMÃTICAMENTE DÃ“NDE EMPIEZAN LOS DATOS
                let dataStartLine = -1;
                let numTasksInCSV = 0;
                
                // Buscar la primera línea que empiece con un nÃºmero (lista de estudiantes)
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const columns = line.split(/[,;\t]/); // Soportar , ; o TAB
                    const firstCol = columns[0]?.trim();
                    
                    // Si la primera columna es un nÃºmero, encontramos el inicio de datos
                    if (firstCol && !isNaN(parseInt(firstCol)) && parseInt(firstCol) > 0) {
                        dataStartLine = i;
                        
                        // MEJORADO: Contar solo columnas con valores TRUE/FALSE/1/0
                        // Estas son las tareas reales, no las columnas de resumen
                        for (let j = 4; j < columns.length; j++) {
                            const val = columns[j]?.trim().toUpperCase();
                            
                            // Si es un valor de tarea (TRUE/FALSE/1/0/vacío), contarlo
                            if (val === 'TRUE' || val === 'FALSE' || val === '1' || 
                                val === '0' || val === '' || val === 'VERDADERO' || 
                                val === 'FALSO') {
                                numTasksInCSV++;
                            } else {
                                // Si encontramos algo diferente (nÃºmero, texto), detenemos
                                // Son columnas de resumen (PUNTOS, NOTA, etc.)
                                console.log(`â¹ï¸ Detención en columna ${j}: valor "${val}" no es TRUE/FALSE`);
                                break;
                            }
                        }
                        
                        console.log(`ðŸŽ¯ Datos encontrados en línea ${i + 1}`);
                        console.log(`ðŸ“Š CSV detectado con ${numTasksInCSV} TAREAS (columnas TRUE/FALSE)`);
                        console.log(`ðŸ“‹ Columnas totales en línea: ${columns.length}`);
                        console.log(`ðŸ”¢ Primera línea de datos:`, columns.slice(0, 15).join(' | '));
                        break;
                    }
                }
                
                if (dataStartLine === -1) {
                    alert('âŒ No se encontraron datos válidos en el CSV.\n\nAsegÃºrate que el archivo tenga:\n- NÃºmero de lista en la primera columna\n- Apellidos y nombres en columnas siguientes');
                    return;
                }
                
                console.log(`ðŸ“Š Curso actual tiene ${courseData.tasks.length} tareas`);
                
                // Si el CSV tiene más tareas que el curso actual, crear las faltantes
                let tasksAdded = 0;
                if (numTasksInCSV > courseData.tasks.length) {
                    const tasksToAdd = numTasksInCSV - courseData.tasks.length;
                    console.log(`âž• Creando ${tasksToAdd} tareas adicionales...`);
                    
                    for (let i = 0; i < tasksToAdd; i++) {
                        const taskNumber = courseData.tasks.length + 1;
                        const newTask = {
                            id: Date.now() + i,
                            name: `Tarea ${taskNumber}`,
                            date: '',
                            nivel: null,
                            unidad: null,
                            oas: []
                        };
                        courseData.tasks.push(newTask);
                        
                        // Agregar columna vacía a estudiantes existentes
                        courseData.students.forEach(student => {
                            student.grades.push({ value: null, updatedAt: new Date().toISOString() });
                        });
                        
                        tasksAdded++;
                    }
                }
                
                // Limpiar lista de estudiantes
                courseData.students = [];
                
                // Procesar estudiantes desde donde detectamos los datos
                let studentsImported = 0;
                for (let i = dataStartLine; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const columns = line.split(/[,;\t]/); // Soportar , ; o TAB
                    if (columns.length < 4) continue;
                    
                    const number = parseInt(columns[0]?.trim());
                    if (isNaN(number) || number <= 0) continue;
                    
                    const student = {
                        id: Date.now() + Math.random() * 10000,
                        number: number,
                        lastName1: columns[1]?.trim().toUpperCase() || '',
                        lastName2: columns[2]?.trim().toUpperCase() || '',
                        name: columns[3]?.trim().toUpperCase() || '',
                        grades: [],
                        notes: '',
                        retired: false
                    };
                    
                    // Procesar todas las notas disponibles en el CSV
                    const timestamp = new Date().toISOString();
                    for (let j = 4; j < 4 + numTasksInCSV; j++) {
                        const value = columns[j]?.trim().toUpperCase();
                        const isChecked = value === 'VERDADERO' || value === 'TRUE' || 
                                         value === '1' || value === 'X' || value === 'âœ“';
                        student.grades.push({ value: isChecked, updatedAt: timestamp });
                    }
                    
                    // Completar con null si faltan notas
                    while (student.grades.length < courseData.tasks.length) {
                        student.grades.push({ value: null, updatedAt: timestamp });
                    }
                    
                    courseData.students.push(student);
                    studentsImported++;
                }
                
                // Mensaje de confirmación detallado
                let message = `✅ Importación exitosa:\n`;
                message += `\n• ${studentsImported} estudiante(s) importado(s)`;
                message += `\n• ${courseData.tasks.length} tarea(s) en total`;
                if (tasksAdded > 0) {
                    message += `\n• ${tasksAdded} tarea(s) nueva(s) creada(s) automáticamente`;
                }
                
                alert(message);
                renderTable();
                saveAllCourses();
                
                console.log('✅ Importación completada:', {
                    estudiantes: studentsImported,
                    tareas: courseData.tasks.length,
                    tareasCreadas: tasksAdded
                });
            };
            reader.readAsText(file, 'UTF-8'); // Especificar encoding UTF-8
        }

        // Exportar a Excel
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Preparar datos
            const data = [
                ['Curso:', courseData.courseName],
                ['Asignatura:', courseData.subject],
                ['Período:', courseData.period],
                [],
                ['N°', 'Apellido Paterno', 'Apellido Materno', 'Nombre', ...courseData.tasks.map(t => t.name), 'Puntos', 'Nota']
            ];
            
            courseData.students.forEach(student => {
                // Validar y normalizar grades
                const studentGrades = student.grades && Array.isArray(student.grades) ? student.grades : [];
                const normalizedGrades = Array.from({ length: courseData.tasks.length }, (_, i) => 
                    i < studentGrades.length ? getGradeValue(studentGrades[i]) : null
                );
                
                const totalPoints = normalizedGrades.filter(g => g).length;
                const finalGrade = calculateGrade(totalPoints, courseData.tasks.length);
                
                data.push([
                    student.number,
                    student.lastName1,
                    student.lastName2,
                    student.name,
                    ...normalizedGrades.map(g => g ? 'âœ“' : ''),
                    totalPoints,
                    finalGrade.toFixed(1)
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Notas');
            
            const filename = `Notas_${courseData.courseName}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // Renderizar estadísticas
        function renderStatistics() {
            const statsDiv = document.getElementById('generalStats');
            const students = courseData.students;
            
            // Filtrar estudiantes activos (no retirados)
            const activeStudents = students.filter(s => !s.retired);
            
            if (activeStudents.length === 0) {
                statsDiv.innerHTML = '<p class="text-gray-500">No hay datos disponibles</p>';
                return;
            }
            
            // Calcular estadísticas solo con estudiantes activos
            const grades = activeStudents.map(s => {
                // Validar y normalizar grades
                const studentGrades = s.grades && Array.isArray(s.grades) ? s.grades : [];
                const points = studentGrades.filter(g => getGradeValue(g)).length;
                return calculateGrade(points, courseData.tasks.length);
            });
            
            const avgGrade = grades.reduce((a, b) => a + b, 0) / grades.length;
            const maxGrade = Math.max(...grades);
            const minGrade = Math.min(...grades);
            const passing = grades.filter(g => g >= 4.0).length;
            const failing = grades.filter(g => g < 4.0).length;
            const retiredCount = students.length - activeStudents.length;
            
            statsDiv.innerHTML = `
                <div class="stat-item">
                    <div class="text-sm text-gray-600">Total Estudiantes</div>
                    <div class="text-2xl font-bold text-indigo-600">${students.length}</div>
                    ${retiredCount > 0 ? `<div class="text-xs text-gray-500">(${retiredCount} retirado${retiredCount > 1 ? 's' : ''})</div>` : ''}
                </div>
                <div class="stat-item">
                    <div class="text-sm text-gray-600">Estudiantes Activos</div>
                    <div class="text-2xl font-bold text-purple-600">${activeStudents.length}</div>
                </div>
                <div class="stat-item">
                    <div class="text-sm text-gray-600">Promedio del Curso</div>
                    <div class="text-2xl font-bold text-blue-600">${avgGrade.toFixed(2)}</div>
                </div>
                <div class="stat-item">
                    <div class="text-sm text-gray-600">Nota Máxima</div>
                    <div class="text-2xl font-bold text-green-600">${maxGrade.toFixed(1)}</div>
                </div>
                <div class="stat-item">
                    <div class="text-sm text-gray-600">Nota Mínima</div>
                    <div class="text-2xl font-bold text-red-600">${minGrade.toFixed(1)}</div>
                </div>
                <div class="stat-item">
                    <div class="text-sm text-gray-600">Aprobados</div>
                    <div class="text-2xl font-bold text-green-600">${passing} (${(passing/activeStudents.length*100).toFixed(0)}%)</div>
                </div>
                <div class="stat-item">
                    <div class="text-sm text-gray-600">Reprobados</div>
                    <div class="text-2xl font-bold text-red-600">${failing} (${(failing/activeStudents.length*100).toFixed(0)}%)</div>
                </div>
            `;
            
            renderCharts(grades);
        }

        // Renderizar gráficos
        function renderCharts(grades) {
            // Distribución de notas
            const ctx1 = document.getElementById('gradeDistributionChart');
            if (ctx1.chart) ctx1.chart.destroy();
            
            const distribution = {
                '1.0-2.9': grades.filter(g => g < 3.0).length,
                '3.0-3.9': grades.filter(g => g >= 3.0 && g < 4.0).length,
                '4.0-4.9': grades.filter(g => g >= 4.0 && g < 5.0).length,
                '5.0-5.9': grades.filter(g => g >= 5.0 && g < 6.0).length,
                '6.0-7.0': grades.filter(g => g >= 6.0).length
            };
            
            ctx1.chart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(distribution),
                    datasets: [{
                        label: 'Cantidad de Estudiantes',
                        data: Object.values(distribution),
                        backgroundColor: [
                            '#ef4444',
                            '#f59e0b',
                            '#3b82f6',
                            '#10b981',
                            '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // Progreso por tarea (solo estudiantes activos) - Gráfico de barras horizontal compacto
            const ctx2 = document.getElementById('taskProgressChart');
            if (ctx2.chart) ctx2.chart.destroy();
            
            const activeStudents = courseData.students.filter(s => !s.retired);
            const taskCompletion = courseData.tasks.map((task, index) => {
                const completed = activeStudents.filter(s => {
                    const grades = s.grades && Array.isArray(s.grades) ? s.grades : [];
                    return grades[index];
                }).length;
                const percentage = activeStudents.length > 0 ? (completed / activeStudents.length * 100) : 0;
                return {
                    percentage: parseFloat(percentage.toFixed(1)),
                    completed: completed,
                    total: activeStudents.length
                };
            });
            
            // Colores segÃºn porcentaje (verde >= 80%, amarillo >= 60%, rojo < 60%)
            const backgroundColors = taskCompletion.map(t => 
                t.percentage >= 80 ? 'rgba(34, 197, 94, 0.8)' : 
                t.percentage >= 60 ? 'rgba(234, 179, 8, 0.8)' : 
                'rgba(239, 68, 68, 0.8)'
            );
            
            ctx2.chart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: courseData.tasks.map((t, i) => `T${i + 1}: ${t.name.substring(0, 25)}${t.name.length > 25 ? '...' : ''}`),
                    datasets: [{
                        label: '% Cumplimiento',
                        data: taskCompletion.map(t => t.percentage),
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Barras horizontales
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2, // Más compacto
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dataIndex = context.dataIndex;
                                    const data = taskCompletion[dataIndex];
                                    return [
                                        `Cumplimiento: ${data.percentage}%`,
                                        `Completaron: ${data.completed}/${data.total} estudiantes`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== INFORME PROFESIONAL DEL CURSO ====================
        async function generateCourseReport() {
            const reportDiv = document.getElementById('courseReportContent');
            const downloadBtn = document.getElementById('downloadCourseReportBtn');
            
            try {
                reportDiv.innerHTML = '<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i><p class="mt-2">Generando informe profesional...</p></div>';
                downloadBtn.style.display = 'none';
                
                // VALIDACIONES CRÃTICAS
                if (!courseData) {
                    throw new Error('No hay datos de curso cargados. Por favor, cree o importe un curso primero.');
                }
                
                if (!courseData.students || !Array.isArray(courseData.students)) {
                    throw new Error('No hay estudiantes en el curso. Agregue estudiantes antes de generar el informe.');
                }
                
                if (!courseData.tasks || !Array.isArray(courseData.tasks)) {
                    throw new Error('No hay tareas en el curso. Agregue tareas antes de generar el informe.');
                }
                
                if (courseData.tasks.length === 0) {
                    reportDiv.innerHTML = '<div class="text-center p-8 text-orange-500"><i class="fas fa-clipboard-list text-4xl mb-3"></i><p class="text-lg font-semibold mb-2">No hay tareas registradas</p><p class="text-sm text-gray-600">Agregue al menos una tarea para generar el informe del curso.</p></div>';
                    return;
                }
                
                console.log('ðŸ“Š Iniciando generación de informe...');
                console.log('Curso:', courseData.courseName);
                console.log('Total estudiantes:', courseData.students.length);
                console.log('Total tareas:', courseData.tasks.length);
                
                const students = courseData.students;
                const activeStudents = students.filter(s => !s.retired);
                const retiredCount = students.length - activeStudents.length;
                
                console.log('Estudiantes activos:', activeStudents.length);
                
                if (activeStudents.length === 0) {
                    reportDiv.innerHTML = '<div class="text-center p-8 text-gray-500"><i class="fas fa-exclamation-triangle text-4xl mb-3"></i><p>No hay estudiantes activos para generar el informe.</p></div>';
                    return;
                }
                
                // Calcular estadísticas avanzadas
                console.log('ðŸ“ˆ Calculando calificaciones...');
                const grades = activeStudents.map(s => {
                    const points = s.grades && Array.isArray(s.grades) ? s.grades.filter(g => getGradeValue(g)).length : 0;
                    return calculateGrade(points, courseData.tasks.length);
                });
                console.log('Calificaciones calculadas:', grades.length);
                
                console.log('ðŸ“Š Calculando estadísticas avanzadas...');
                const stats = calculateAdvancedStats(grades, activeStudents);
                console.log('Estadísticas:', stats);
                
                console.log('ðŸ“ Analizando tareas...');
                const taskAnalysis = analyzeTasksPerformance(activeStudents);
                console.log('Tareas analizadas:', taskAnalysis ? taskAnalysis.length : 0);
                
                console.log('ðŸŽ¯ Analizando OAs...');
                const oasAnalysis = await analyzeCourseOAs(activeStudents);
                console.log('OAs analizados:', oasAnalysis);
                
                console.log('ðŸ’¡ Generando recomendaciones...');
                const recommendations = await generateCourseRecommendations(stats, taskAnalysis, oasAnalysis);
                console.log('Recomendaciones generadas:', recommendations ? recommendations.length : 0);
                
                console.log('ðŸ—ï¸ Construyendo HTML del informe...');
                
                // Generar cada sección con try-catch individual
                let htmlSections = [];
                
                try {
                    console.log('  â†’ Header...');
                    htmlSections.push(buildReportHeader());
                } catch (e) {
                    console.error('âŒ Error en Header:', e);
                    throw new Error(`Error en Header: ${e.message}`);
                }
                
                try {
                    console.log('  â†’ Executive Summary...');
                    htmlSections.push(buildExecutiveSummary(stats, activeStudents.length, retiredCount));
                } catch (e) {
                    console.error('âŒ Error en Executive Summary:', e);
                    throw new Error(`Error en Executive Summary: ${e.message}`);
                }
                
                try {
                    console.log('  â†’ Distribution Chart...');
                    htmlSections.push(buildDistributionChart(grades));
                } catch (e) {
                    console.error('âŒ Error en Distribution Chart:', e);
                    throw new Error(`Error en Distribution Chart: ${e.message}`);
                }
                
                try {
                    console.log('  â†’ Detailed Stats Table...');
                    htmlSections.push(buildDetailedStatsTable(stats));
                } catch (e) {
                    console.error('âŒ Error en Detailed Stats Table:', e);
                    throw new Error(`Error en Detailed Stats Table: ${e.message}`);
                }
                
                try {
                    console.log('  â†’ Tasks Analysis Table...');
                    htmlSections.push(buildTasksAnalysisTable(taskAnalysis));
                } catch (e) {
                    console.error('âŒ Error en Tasks Analysis Table:', e);
                    throw new Error(`Error en Tasks Analysis Table: ${e.message}`);
                }
                
                try {
                    console.log('  â†’ OAs Analysis Section...');
                    htmlSections.push(buildCourseOAsAnalysisSection(oasAnalysis));
                } catch (e) {
                    console.error('âŒ Error en OAs Analysis Section:', e);
                    throw new Error(`Error en OAs Analysis Section: ${e.message}`);
                }
                
                try {
                    console.log('  â†’ Students Performance Table...');
                    htmlSections.push(buildStudentsPerformanceTable(activeStudents));
                } catch (e) {
                    console.error('âŒ Error en Students Performance Table:', e);
                    throw new Error(`Error en Students Performance Table: ${e.message}`);
                }
                
                try {
                    console.log('  â†’ Recommendations Section...');
                    htmlSections.push(buildRecommendationsSection(recommendations));
                } catch (e) {
                    console.error('âŒ Error en Recommendations Section:', e);
                    throw new Error(`Error en Recommendations Section: ${e.message}`);
                }
                
                // Ensamblar HTML completo
                reportDiv.innerHTML = `
                    <div class="space-y-6 print:space-y-4">
                        ${htmlSections.join('\n')}
                    </div>
                `;
                
                console.log('✅ Informe generado exitosamente');
                // Mostrar botón de descarga después de generar
                downloadBtn.style.display = 'inline-flex';
                
            } catch (error) {
                console.error('âŒ ERROR GENERANDO INFORME:', error);
                console.error('Stack completo:', error.stack);
                reportDiv.innerHTML = `
                    <div class="bg-red-50 border-2 border-red-300 rounded-lg p-6 text-center">
                        <i class="fas fa-exclamation-circle text-5xl text-red-500 mb-4"></i>
                        <h4 class="text-xl font-bold text-red-800 mb-2">Error al generar el informe</h4>
                        <p class="text-red-700 mb-4">${error.message}</p>
                        <p class="text-sm text-gray-600 mb-4">Detalles técnicos: ${error.stack ? error.stack.split('\n')[0] : 'No disponible'}</p>
                        <details class="text-left mb-4 bg-white p-4 rounded">
                            <summary class="cursor-pointer font-semibold mb-2">Ver stack trace completo</summary>
                            <pre class="text-xs text-gray-700 overflow-x-auto">${error.stack || 'No disponible'}</pre>
                        </details>
                        <button onclick="generateCourseReport()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold">
                            <i class="fas fa-redo mr-2"></i>Reintentar
                        </button>
                    </div>
                `;
            }
        }
        
        // Descargar informe de curso como PDF
        async function downloadCourseReportPDF() {
            const fileName = `Informe_Curso_${courseData.courseName.replace(/\s+/g, '_')}_${courseData.period.replace(/\s+/g, '_')}.pdf`;
            const reportContent = document.getElementById('courseReportContent');
            
            if (!reportContent || reportContent.children.length === 0) {
                alert('âš ï¸ No hay informe generado. Por favor, genera el informe primero.');
                return;
            }
            
            // Mostrar mensaje de carga
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'pdf-loading';
            loadingMsg.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingMsg.innerHTML = `
                <div class="bg-white rounded-lg p-8 text-center shadow-2xl">
                    <i class="fas fa-file-pdf text-6xl text-red-500 mb-4 animate-pulse"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Generando PDF...</h3>
                    <p class="text-gray-600">Por favor espera, esto puede tomar unos segundos</p>
                    <div class="mt-4">
                        <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-indigo-600 border-r-transparent"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingMsg);
            
            try {
                // Esperar un momento para que se renderice el mensaje
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Usar html2canvas para capturar el contenido con ALTA CALIDAD
                const canvas = await html2canvas(reportContent, {
                    scale: 3, // MAYOR calidad (3x para texto sÃºper nítido)
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    imageTimeout: 0,
                    removeContainer: true,
                    letterRendering: true, // Mejor renderizado de texto
                    windowWidth: 1400, // Ancho consistente
                    onclone: (clonedDoc) => {
                        // Mejorar contraste y claridad en el documento clonado
                        const clonedContent = clonedDoc.getElementById('courseReportContent');
                        if (clonedContent) {
                            clonedContent.style.fontSmoothing = 'antialiased';
                            clonedContent.style.webkitFontSmoothing = 'antialiased';
                            // Convertir textarea a texto estático para mejor calidad
                            const textareas = clonedContent.querySelectorAll('textarea');
                            textareas.forEach(textarea => {
                                const div = clonedDoc.createElement('div');
                                div.className = textarea.className;
                                div.style.cssText = 'white-space: pre-wrap; word-wrap: break-word; padding: 12px; line-height: 1.7;';
                                div.textContent = textarea.value;
                                textarea.parentNode.replaceChild(div, textarea);
                            });
                        }
                    }
                });
                
                // Obtener dimensiones
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Crear PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Agregar imagen al PDF
                const imgData = canvas.toDataURL('image/png');
                
                // Si el contenido es más alto que una página, dividir en mÃºltiples páginas
                let heightLeft = imgHeight;
                let position = 0;
                
                // Primera página
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= 297; // altura de A4
                
                // Páginas adicionales si es necesario
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= 297;
                }
                
                // Descargar el PDF
                pdf.save(fileName);
                
                // Remover mensaje de carga
                document.body.removeChild(loadingMsg);
                
                // Mostrar mensaje de éxito
                showNotification('✅ PDF generado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                document.body.removeChild(loadingMsg);
                alert('âŒ Error al generar el PDF. Por favor, intenta de nuevo o usa la opción de imprimir (Ctrl+P).');
            }
        }
        
        // Función auxiliar para mostrar notificaciones
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => document.body.removeChild(notification), 500);
            }, 3000);
        }
        
        // Calcular estadísticas avanzadas
        function calculateAdvancedStats(grades, students) {
            if (grades.length === 0) return null;
            
            const sorted = [...grades].sort((a, b) => a - b);
            const total = grades.length;
            const sum = grades.reduce((a, b) => a + b, 0);
            const avg = sum / total;
            
            // Desviación estándar
            const variance = grades.reduce((acc, g) => acc + Math.pow(g - avg, 2), 0) / total;
            const stdDev = Math.sqrt(variance);
            
            // Cuartiles
            const q1Index = Math.floor(total * 0.25);
            const q2Index = Math.floor(total * 0.50);
            const q3Index = Math.floor(total * 0.75);
            
            return {
                total: students.length,
                avg: avg,
                median: sorted[q2Index],
                min: Math.min(...grades),
                max: Math.max(...grades),
                stdDev: stdDev,
                q1: sorted[q1Index],
                q3: sorted[q3Index],
                passing: grades.filter(g => g >= 4.0).length,
                passingRate: (grades.filter(g => g >= 4.0).length / total * 100),
                distribution: {
                    excelente: grades.filter(g => g >= 6.0).length,
                    bueno: grades.filter(g => g >= 5.0 && g < 6.0).length,
                    suficiente: grades.filter(g => g >= 4.0 && g < 5.0).length,
                    insuficiente: grades.filter(g => g < 4.0).length
                }
            };
        }
        
        // Analizar rendimiento por tarea
        function analyzeTasksPerformance(students) {
            if (!courseData || !courseData.tasks || !Array.isArray(courseData.tasks)) {
                console.warn('No hay tareas para analizar');
                return [];
            }
            
            // Validar que students sea un array
            if (!students || !Array.isArray(students) || students.length === 0) {
                console.warn('No hay estudiantes para analizar tareas');
                return [];
            }
            
            return courseData.tasks.map((task, index) => {
                try {
                    // Validar que task existe
                    if (!task) {
                        console.warn(`Tarea en índice ${index} es null/undefined`);
                        return {
                            name: `Tarea ${index + 1}`,
                            date: 'Sin fecha',
                            completed: 0,
                            pending: students.length,
                            total: students.length,
                            percentage: 0,
                            difficulty: 'Media',
                            oas: []
                        };
                    }
                    
                    // Contar completadas con validación robusta
                    const completed = students.filter(s => {
                        // Verificar que el estudiante y sus grades existen
                        if (!s || !s.grades || !Array.isArray(s.grades)) return false;
                        // Verificar que el índice existe en el array
                        if (index >= s.grades.length) return false;
                        // Verificar que la calificación es truthy (compatible con formato antiguo y nuevo)
                        return getGradeValue(s.grades[index]);
                    }).length;
                    
                    const pending = students.length - completed;
                    const percentage = students.length > 0 ? (completed / students.length * 100) : 0;
                    
                    let difficulty = 'Media';
                    if (percentage >= 80) difficulty = 'Fácil';
                    else if (percentage < 50) difficulty = 'Difícil';
                    
                    // Asegurar que oas sea un array
                    const taskOas = task.oas && Array.isArray(task.oas) ? task.oas : [];
                    
                    return {
                        name: task.name || `Tarea ${index + 1}`,
                        date: task.date || 'Sin fecha',
                        completed: completed,
                        pending: pending,
                        total: students.length,
                        percentage: percentage,
                        difficulty: difficulty,
                        oas: taskOas
                    };
                } catch (taskError) {
                    console.error(`Error analizando tarea ${index}:`, taskError);
                    return {
                        name: `Tarea ${index + 1}`,
                        date: 'Sin fecha',
                        completed: 0,
                        pending: students.length,
                        total: students.length,
                        percentage: 0,
                        difficulty: 'Media',
                        oas: []
                    };
                }
            });
        }
        
        // Analizar OAs del curso completo
        async function analyzeCourseOAs(students) {
            try {
                const oasMap = new Map();
                const oasData = await loadOAsData();
                
                // Si no hay datos de OAs o no hay tareas con OAs, retornar vacío
                if (!oasData) {
                    console.log('No hay datos de OAs disponibles');
                    return {
                        total: 0,
                        oas: [],
                        critical: [],
                        good: []
                    };
                }
                
                // Verificar si hay tareas con OAs asignados
                const tasksWithOAs = courseData.tasks.filter(t => t.oas && t.oas.length > 0);
                if (tasksWithOAs.length === 0) {
                    console.log('No hay tareas con OAs asignados');
                    return {
                        total: 0,
                        oas: [],
                        critical: [],
                        good: []
                    };
                }
                
                for (const student of students) {
                    try {
                        const studentOAs = await analyzeStudentOAs(student);
                        
                        if (!studentOAs) continue;
                        
                        // Contar OAs cumplidos
                        if (studentOAs.cumplidos && Array.isArray(studentOAs.cumplidos)) {
                            studentOAs.cumplidos.forEach(oa => {
                                const key = oa.codigo;
                                if (!oasMap.has(key)) {
                                    oasMap.set(key, {
                                        codigo: oa.codigo,
                                        texto: oa.texto,
                                        unidad: oa.unidad,
                                        nivel: oa.nivel,
                                        cumplidos: 0,
                                        noCumplidos: 0
                                    });
                                }
                                oasMap.get(key).cumplidos++;
                            });
                        }
                        
                        // Contar OAs no cumplidos
                        if (studentOAs.noCumplidos && Array.isArray(studentOAs.noCumplidos)) {
                            studentOAs.noCumplidos.forEach(oa => {
                                const key = oa.codigo;
                                if (!oasMap.has(key)) {
                                    oasMap.set(key, {
                                        codigo: oa.codigo,
                                        texto: oa.texto,
                                        unidad: oa.unidad,
                                        nivel: oa.nivel,
                                        cumplidos: 0,
                                        noCumplidos: 0
                                    });
                                }
                                oasMap.get(key).noCumplidos++;
                            });
                        }
                    } catch (studentError) {
                        console.error(`Error analizando OAs del estudiante ${student.name}:`, studentError);
                        // Continuar con el siguiente estudiante
                    }
                }
                
                const oasArray = Array.from(oasMap.values()).map(oa => ({
                    ...oa,
                    totalStudents: students.length,
                    percentage: students.length > 0 ? (oa.cumplidos / students.length * 100).toFixed(1) : '0.0'
                }));
                
                // Ordenar por menor cumplimiento (OAs más descendidos primero)
                oasArray.sort((a, b) => parseFloat(a.percentage) - parseFloat(b.percentage));
                
                return {
                    total: oasArray.length,
                    oas: oasArray,
                    critical: oasArray.filter(oa => parseFloat(oa.percentage) < 50),
                    good: oasArray.filter(oa => parseFloat(oa.percentage) >= 80)
                };
            } catch (error) {
                console.error('Error en analyzeCourseOAs:', error);
                // Retornar estructura vacía en caso de error
                return {
                    total: 0,
                    oas: [],
                    critical: [],
                    good: []
                };
            }
        }
        
        // Generar recomendaciones con IA
        async function generateCourseRecommendations(stats, taskAnalysis, oasAnalysis) {
            const recommendations = [];
            
            // ============ INTENTAR GENERAR RECOMENDACIONES CON IA ============
            try {
                console.log('🤖 Intentando generar recomendaciones con IA...');
                
                // Preparar datos del curso para la IA
                const courseContext = {
                    curso: courseData.courseName,
                    asignatura: courseData.subject,
                    periodo: courseData.period,
                    totalEstudiantes: courseData.students.filter(s => !s.retired).length,
                    promedioGeneral: stats.avg.toFixed(2),
                    tasaAprobacion: stats.passingRate.toFixed(1) + '%',
                    desviacionEstandar: stats.stdDev.toFixed(2),
                    tareasProblematicas: taskAnalysis.filter(t => t.percentage < 50).map(t => `${t.name} (${t.percentage}%)`),
                    oasCriticos: oasAnalysis.critical.map(oa => `${oa.codigo} - ${oa.unidad} (${oa.percentage}%)`).slice(0, 3)
                };
                
                const prompt = `Eres un asesor pedagógico experto en educación chilena. Analiza estos datos del curso y genera 3-4 recomendaciones pedagógicas específicas y accionables:

CONTEXTO DEL CURSO:
- Curso: ${courseContext.curso}
- Asignatura: ${courseContext.asignatura}  
- Período: ${courseContext.periodo}
- Total estudiantes: ${courseContext.totalEstudiantes}

MÉTRICAS DE RENDIMIENTO:
- Promedio general: ${courseContext.promedioGeneral}
- Tasa de aprobación: ${courseContext.tasaAprobacion}
- Desviación estándar: ${courseContext.desviacionEstandar}

TAREAS CON BAJO CUMPLIMIENTO (<50%):
${courseContext.tareasProblematicas.length > 0 ? courseContext.tareasProblematicas.join('\n') : 'Ninguna'}

OBJETIVOS DE APRENDIZAJE CRÃTICOS (<50%):
${courseContext.oasCriticos.length > 0 ? courseContext.oasCriticos.join('\n') : 'Ninguno'}

INSTRUCCIONES:
1. Genera 3-4 recomendaciones pedagógicas concretas y aplicables
2. Cada recomendación debe tener: título corto, tipo (critical/warning/success/info), y descripción de 2-3 líneas
3. Usa lenguaje técnico-pedagógico apropiado para docentes
4. Responde SOLO en formato JSON así:
[
  {"type": "critical", "icon": "ðŸš¨", "title": "Título", "text": "Descripción detallada"},
  {"type": "warning", "icon": "âš ï¸", "title": "Título", "text": "Descripción detallada"}
]

RESPONDE SOLO CON EL JSON, SIN TEXTO ADICIONAL.`;

                const apiKey = getStorageItem('geminiApiKey') || DEFAULT_GEMINI_API_KEY;
                
                // Intentar Gemini primero
                let aiResponse = null;
                try {
                    console.log('ðŸ”· Intentando con Gemini API...');
                    aiResponse = await callGeminiAPI(apiKey, prompt);
                    console.log('✅ Gemini respondió:', aiResponse);
                } catch (geminiError) {
                    console.warn('âŒ Gemini falló, intentando con HuggingFace...', geminiError);
                    try {
                        aiResponse = await callHuggingFaceAPI(prompt);
                        console.log('✅ HuggingFace respondió:', aiResponse);
                    } catch (hfError) {
                        console.warn('âŒ HuggingFace también falló', hfError);
                    }
                }
                
                // Parsear respuesta de IA
                if (aiResponse) {
                    // Extraer JSON de la respuesta (puede venir con texto extra)
                    const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        const aiRecommendations = JSON.parse(jsonMatch[0]);
                        console.log('✅ Recomendaciones de IA parseadas:', aiRecommendations);
                        return aiRecommendations;
                    }
                }
                
                console.warn('âš ï¸ No se pudieron generar recomendaciones con IA, usando reglas básicas...');
            } catch (error) {
                console.error('âŒ Error al generar recomendaciones con IA:', error);
                console.log('ðŸ“ Usando recomendaciones basadas en reglas...');
            }
            
            // ============ RECOMENDACIONES BASADAS EN REGLAS (FALLBACK) ============
            
            // Recomendaciones por promedio
            if (stats.avg < 4.0) {
                recommendations.push({
                    type: 'critical',
                    icon: 'ðŸš¨',
                    title: 'Promedio crítico del curso',
                    text: `El promedio del curso (${stats.avg.toFixed(2)}) está bajo el nivel de aprobación. Se requiere intervención pedagógica inmediata con plan remedial.`
                });
            } else if (stats.avg < 4.5) {
                recommendations.push({
                    type: 'warning',
                    icon: 'âš ï¸',
                    title: 'Promedio descendido',
                    text: `El promedio del curso (${stats.avg.toFixed(2)}) está cercano al límite. Implementar estrategias de reforzamiento y evaluación formativa continua.`
                });
            } else if (stats.avg >= 5.5) {
                recommendations.push({
                    type: 'success',
                    icon: '✅',
                    title: 'Excelente rendimiento general',
                    text: `El promedio del curso (${stats.avg.toFixed(2)}) refleja un muy buen nivel. Continuar con estrategias efectivas y desafiar con actividades de mayor complejidad.`
                });
            }
            
            // Recomendaciones por tasa de aprobación
            if (stats.passingRate < 60) {
                recommendations.push({
                    type: 'critical',
                    icon: 'ðŸ“Š',
                    title: 'Tasa de aprobación crítica',
                    text: `Solo el ${stats.passingRate.toFixed(1)}% aprueba. Revisar metodologías, criterios de evaluación y proporcionar apoyo diferenciado urgente.`
                });
            }
            
            // Recomendaciones por tareas descendidas
            const difficultTasks = taskAnalysis.filter(t => t.percentage < 50);
            if (difficultTasks.length > 0) {
                const taskNames = difficultTasks.map(t => t.name).join(', ');
                recommendations.push({
                    type: 'warning',
                    icon: 'ðŸ“',
                    title: 'Tareas con bajo cumplimiento',
                    text: `Las tareas "${taskNames}" tienen menos del 50% de cumplimiento. Considerar: extender plazos, proporcionar andamiaje adicional o evaluar pertinencia de la actividad.`
                });
            }
            
            // Recomendaciones por OAs descendidos
            if (oasAnalysis.critical.length > 0) {
                const criticalOAs = oasAnalysis.critical.slice(0, 3).map(oa => `${oa.codigo} (${oa.unidad})`).join(', ');
                recommendations.push({
                    type: 'critical',
                    icon: 'ðŸŽ¯',
                    title: 'Objetivos de Aprendizaje críticos',
                    text: `Los OAs ${criticalOAs} tienen menos del 50% de logro. Priorizar reforzamiento de estos objetivos con estrategias didácticas focalizadas y evaluación diferenciada.`
                });
            }
            
            // Recomendación por dispersión
            if (stats.stdDev > 1.5) {
                recommendations.push({
                    type: 'info',
                    icon: 'ðŸ“ˆ',
                    title: 'Alta dispersión en rendimientos',
                    text: `La desviación estándar (${stats.stdDev.toFixed(2)}) indica heterogeneidad significativa. Implementar diferenciación pedagógica, grupos colaborativos y tutorías entre pares.`
                });
            }
            
            // Si no hay problemas críticos, agregar recomendaciones positivas
            if (recommendations.length === 0 || recommendations.filter(r => r.type === 'success').length > 0) {
                recommendations.push({
                    type: 'info',
                    icon: 'ðŸŒŸ',
                    title: 'Mantener buenas prácticas',
                    text: `El curso muestra un rendimiento sólido. Continuar con retroalimentación formativa, evaluación continua y desafíos graduados segÃºn capacidades individuales.`
                });
            }
            
            return recommendations;
        }
        
        // ==================== CONSTRUCCIÃ“N DE SECCIONES DEL INFORME ====================
        
        // Header del informe
        function buildReportHeader() {
            const today = new Date().toLocaleDateString('es-CL', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            return `
                <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-6 rounded-lg shadow-lg print:bg-blue-900">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-2xl font-bold mb-2">ðŸ“Š Informe de Rendimiento Académico</h3>
                            <p class="text-lg font-semibold">${courseData.courseName}</p>
                            <p class="text-sm opacity-90">Asignatura: ${courseData.subject} | Período: ${courseData.period}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm opacity-90">${today}</p>
                            <p class="text-xs opacity-75">Generado automáticamente</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Resumen ejecutivo
        function buildExecutiveSummary(stats, activeCount, retiredCount) {
            if (!stats) return '<p>No hay datos suficientes.</p>';
            
            const gradeColor = stats.avg >= 5.5 ? 'green' : stats.avg >= 4.5 ? 'blue' : stats.avg >= 4.0 ? 'orange' : 'red';
            const approvalColor = stats.passingRate >= 80 ? 'green' : stats.passingRate >= 60 ? 'blue' : 'red';
            
            return `
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                    <h4 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                        Resumen Ejecutivo
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-gray-50 p-4 rounded text-center">
                            <i class="fas fa-users text-2xl text-gray-600 mb-2"></i>
                            <p class="text-3xl font-bold text-gray-800">${stats.total}</p>
                            <p class="text-sm text-gray-600">Estudiantes</p>
                            ${retiredCount > 0 ? `<p class="text-xs text-red-600 mt-1">${retiredCount} retirado${retiredCount > 1 ? 's' : ''}</p>` : ''}
                        </div>
                        <div class="bg-${gradeColor}-50 p-4 rounded text-center">
                            <i class="fas fa-calculator text-2xl text-${gradeColor}-600 mb-2"></i>
                            <p class="text-3xl font-bold text-${gradeColor}-800">${stats.avg.toFixed(2)}</p>
                            <p class="text-sm text-${gradeColor}-600">Promedio Curso</p>
                            <p class="text-xs text-gray-600 mt-1">Mediana: ${stats.median.toFixed(2)}</p>
                        </div>
                        <div class="bg-${approvalColor}-50 p-4 rounded text-center">
                            <i class="fas fa-check-circle text-2xl text-${approvalColor}-600 mb-2"></i>
                            <p class="text-3xl font-bold text-${approvalColor}-800">${stats.passingRate.toFixed(1)}%</p>
                            <p class="text-sm text-${approvalColor}-600">Aprobación</p>
                            <p class="text-xs text-gray-600 mt-1">${stats.passing}/${stats.total} aprobados</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded text-center">
                            <i class="fas fa-tasks text-2xl text-purple-600 mb-2"></i>
                            <p class="text-3xl font-bold text-purple-800">${courseData.tasks.length}</p>
                            <p class="text-sm text-purple-600">Tareas</p>
                            <p class="text-xs text-gray-600 mt-1">Evaluadas</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Gráfico de distribución de notas
        function buildDistributionChart(grades) {
            const chartId = 'distributionChart_' + Date.now();
            
            setTimeout(() => {
                const ctx = document.getElementById(chartId);
                if (!ctx) return;
                
                const distribution = {
                    '1.0-1.9': grades.filter(g => g >= 1.0 && g < 2.0).length,
                    '2.0-2.9': grades.filter(g => g >= 2.0 && g < 3.0).length,
                    '3.0-3.9': grades.filter(g => g >= 3.0 && g < 4.0).length,
                    '4.0-4.9': grades.filter(g => g >= 4.0 && g < 5.0).length,
                    '5.0-5.9': grades.filter(g => g >= 5.0 && g < 6.0).length,
                    '6.0-7.0': grades.filter(g => g >= 6.0 && g <= 7.0).length
                };
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(distribution),
                        datasets: [{
                            label: 'NÃºmero de Estudiantes',
                            data: Object.values(distribution),
                            backgroundColor: [
                                'rgba(220, 38, 38, 0.7)',
                                'rgba(251, 146, 60, 0.7)',
                                'rgba(251, 191, 36, 0.7)',
                                'rgba(59, 130, 246, 0.7)',
                                'rgba(34, 197, 94, 0.7)',
                                'rgba(16, 185, 129, 0.7)'
                            ],
                            borderColor: [
                                'rgb(220, 38, 38)',
                                'rgb(251, 146, 60)',
                                'rgb(251, 191, 36)',
                                'rgb(59, 130, 246)',
                                'rgb(34, 197, 94)',
                                'rgb(16, 185, 129)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: { size: 14, weight: 'bold' },
                                    padding: 15
                                }
                            },
                            title: {
                                display: true,
                                text: 'Distribución de Calificaciones del Curso',
                                font: { size: 16, weight: 'bold' },
                                padding: { bottom: 20 }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        const percentage = ((context.parsed.y / grades.length) * 100).toFixed(1);
                                        return `Estudiantes: ${context.parsed.y} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    font: { size: 12, weight: 'bold' }
                                },
                                title: {
                                    display: true,
                                    text: 'Cantidad de Estudiantes',
                                    font: { size: 13, weight: 'bold' }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    font: { size: 12, weight: 'bold' }
                                },
                                title: {
                                    display: true,
                                    text: 'Rango de Calificaciones',
                                    font: { size: 13, weight: 'bold' }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }, 100);
            
            return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <canvas id="${chartId}" class="w-full" style="max-height: 400px;"></canvas>
                    <p class="text-xs text-gray-500 text-center mt-3">
                        <i class="fas fa-info-circle"></i> 
                        Este gráfico muestra cómo se distribuyen las calificaciones finales del curso
                    </p>
                </div>
            `;
        }
        
        // Tabla de estadísticas detalladas
        function buildDetailedStatsTable(stats) {
            if (!stats) return '';
            
            return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-table mr-2 text-indigo-600"></i>
                        Estadísticas Detalladas
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Métrica</th>
                                    <th class="px-6 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Valor</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Interpretación</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap font-semibold text-gray-900">Promedio</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center text-lg font-bold ${stats.avg >= 5.0 ? 'text-green-600' : stats.avg >= 4.0 ? 'text-blue-600' : 'text-red-600'}">${stats.avg.toFixed(2)}</td>
                                    <td class="px-6 py-4 text-sm text-gray-600">${getGradeInterpretation(stats.avg)}</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap font-semibold text-gray-900">Mediana</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center text-lg font-bold text-gray-800">${stats.median.toFixed(2)}</td>
                                    <td class="px-6 py-4 text-sm text-gray-600">Calificación central del curso</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap font-semibold text-gray-900">Nota Mínima</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center text-lg font-bold text-red-600">${stats.min.toFixed(2)}</td>
                                    <td class="px-6 py-4 text-sm text-gray-600">Estudiante con menor rendimiento</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap font-semibold text-gray-900">Nota Máxima</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center text-lg font-bold text-green-600">${stats.max.toFixed(2)}</td>
                                    <td class="px-6 py-4 text-sm text-gray-600">Estudiante con mayor rendimiento</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap font-semibold text-gray-900">Desviación Estándar</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center text-lg font-bold text-purple-600">${stats.stdDev.toFixed(2)}</td>
                                    <td class="px-6 py-4 text-sm text-gray-600">${stats.stdDev > 1.5 ? 'Alta variabilidad entre estudiantes' : stats.stdDev > 1.0 ? 'Variabilidad moderada' : 'Grupo homogéneo'}</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap font-semibold text-gray-900">Cuartil 1 (Q1)</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center text-lg font-bold text-gray-700">${stats.q1.toFixed(2)}</td>
                                    <td class="px-6 py-4 text-sm text-gray-600">25% de estudiantes bajo este valor</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap font-semibold text-gray-900">Cuartil 3 (Q3)</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center text-lg font-bold text-gray-700">${stats.q3.toFixed(2)}</td>
                                    <td class="px-6 py-4 text-sm text-gray-600">75% de estudiantes bajo este valor</td>
                                </tr>
                                <tr class="bg-blue-50 hover:bg-blue-100">
                                    <td class="px-6 py-4 whitespace-nowrap font-bold text-blue-900">Tasa de Aprobación</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center text-xl font-bold ${stats.passingRate >= 70 ? 'text-green-600' : stats.passingRate >= 50 ? 'text-orange-600' : 'text-red-600'}">${stats.passingRate.toFixed(1)}%</td>
                                    <td class="px-6 py-4 text-sm font-semibold text-blue-900">${stats.passing} de ${stats.total} estudiantes aprobados</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-green-100 p-3 rounded text-center">
                            <p class="text-2xl font-bold text-green-800">${stats.distribution.excelente}</p>
                            <p class="text-xs font-semibold text-green-700">Excelente (6.0-7.0)</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded text-center">
                            <p class="text-2xl font-bold text-blue-800">${stats.distribution.bueno}</p>
                            <p class="text-xs font-semibold text-blue-700">Bueno (5.0-5.9)</p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded text-center">
                            <p class="text-2xl font-bold text-yellow-800">${stats.distribution.suficiente}</p>
                            <p class="text-xs font-semibold text-yellow-700">Suficiente (4.0-4.9)</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded text-center">
                            <p class="text-2xl font-bold text-red-800">${stats.distribution.insuficiente}</p>
                            <p class="text-xs font-semibold text-red-700">Insuficiente (< 4.0)</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getGradeInterpretation(avg) {
            if (avg >= 6.5) return 'Rendimiento sobresaliente';
            if (avg >= 6.0) return 'Rendimiento excelente';
            if (avg >= 5.5) return 'Rendimiento muy bueno';
            if (avg >= 5.0) return 'Rendimiento bueno';
            if (avg >= 4.5) return 'Rendimiento suficiente';
            if (avg >= 4.0) return 'Rendimiento mínimo aceptable';
            if (avg >= 3.0) return 'Rendimiento insuficiente';
            return 'Rendimiento crítico';
        }
        
        // Tabla de análisis por tareas
        function buildTasksAnalysisTable(taskAnalysis) {
            // Validar que taskAnalysis sea un array
            if (!taskAnalysis || !Array.isArray(taskAnalysis) || taskAnalysis.length === 0) {
                return `
                    <div class="bg-yellow-50 p-6 rounded-lg border-l-4 border-yellow-400">
                        <p class="text-yellow-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            No hay tareas para analizar en este curso.
                        </p>
                    </div>
                `;
            }
            
            return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-clipboard-list mr-2 text-green-600"></i>
                        Análisis de Tareas
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">#</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Tarea</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase">Fecha</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase">Completado</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase">Pendiente</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase">% Logro</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase">Dificultad</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">OAs</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${taskAnalysis.map((task, index) => {
                                    const percentageColor = task.percentage >= 80 ? 'green' : task.percentage >= 60 ? 'blue' : task.percentage >= 40 ? 'orange' : 'red';
                                    const difficultyColor = task.difficulty === 'Fácil' ? 'green' : task.difficulty === 'Media' ? 'blue' : 'red';
                                    
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 text-center font-bold text-gray-600">${index + 1}</td>
                                            <td class="px-4 py-3 font-semibold text-gray-900">${task.name}</td>
                                            <td class="px-4 py-3 text-center text-sm text-gray-600">${task.date}</td>
                                            <td class="px-4 py-3 text-center">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-bold bg-green-100 text-green-800">
                                                    ${task.completed}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-bold ${task.pending > 0 ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                                                    ${task.pending}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <div class="flex items-center justify-center">
                                                    <div class="w-full bg-gray-200 rounded-full h-2.5 mr-2" style="max-width: 80px;">
                                                        <div class="bg-${percentageColor}-600 h-2.5 rounded-full" style="width: ${task.percentage}%"></div>
                                                    </div>
                                                    <span class="text-sm font-bold text-${percentageColor}-700">${task.percentage.toFixed(1)}%</span>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-${difficultyColor}-100 text-${difficultyColor}-800">
                                                    ${task.difficulty}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-sm text-gray-700">
                                                ${task.oas && Array.isArray(task.oas) && task.oas.length > 0 ? task.oas.join(', ') : '<span class="text-gray-400 italic">Sin OAs</span>'}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">
                        <i class="fas fa-lightbulb text-yellow-500"></i> 
                        <strong>Dificultad calculada:</strong> Fácil (â‰¥80% logro), Media (50-79%), Difícil (<50%)
                    </p>
                </div>
            `;
        }
        
        // Sección de análisis de OAs del CURSO COMPLETO
        function buildCourseOAsAnalysisSection(oasAnalysis) {
            if (!oasAnalysis || oasAnalysis.total === 0) {
                return `
                    <div class="bg-yellow-50 p-6 rounded-lg border-l-4 border-yellow-400">
                        <p class="text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            No hay Objetivos de Aprendizaje asignados a las tareas de este curso.
                        </p>
                    </div>
                `;
            }
            
            // Validar que critical y good sean arrays
            const criticalOAs = oasAnalysis.critical && Array.isArray(oasAnalysis.critical) ? oasAnalysis.critical : [];
            const goodOAs = oasAnalysis.good && Array.isArray(oasAnalysis.good) ? oasAnalysis.good : [];
            const allOAs = oasAnalysis.oas && Array.isArray(oasAnalysis.oas) ? oasAnalysis.oas : [];
            
            return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-bullseye mr-2 text-red-600"></i>
                        Análisis de Objetivos de Aprendizaje (OAs)
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-purple-50 p-4 rounded-lg text-center border-l-4 border-purple-500">
                            <i class="fas fa-list-ol text-2xl text-purple-600 mb-2"></i>
                            <p class="text-3xl font-bold text-purple-800">${oasAnalysis.total}</p>
                            <p class="text-sm font-semibold text-purple-700">OAs Totales Evaluados</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center border-l-4 border-red-500">
                            <i class="fas fa-exclamation-circle text-2xl text-red-600 mb-2"></i>
                            <p class="text-3xl font-bold text-red-800">${criticalOAs.length}</p>
                            <p class="text-sm font-semibold text-red-700">OAs Críticos (<50%)</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center border-l-4 border-green-500">
                            <i class="fas fa-check-double text-2xl text-green-600 mb-2"></i>
                            <p class="text-3xl font-bold text-green-800">${goodOAs.length}</p>
                            <p class="text-sm font-semibold text-green-700">OAs Consolidados (â‰¥80%)</p>
                        </div>
                    </div>
                    
                    ${criticalOAs.length > 0 ? `
                        <div class="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded">
                            <h5 class="font-bold text-red-800 mb-3 flex items-center">
                                <i class="fas fa-ambulance mr-2"></i>
                                OAs PRIORITARIOS A REFORZAR
                            </h5>
                            <div class="space-y-2">
                                ${criticalOAs.slice(0, 5).map(oa => `
                                    <div class="bg-white p-3 rounded shadow-sm">
                                        <div class="flex justify-between items-start mb-1">
                                            <span class="font-bold text-red-700">${oa.codigo}</span>
                                            <span class="text-sm font-bold px-2 py-1 rounded ${parseFloat(oa.percentage) < 30 ? 'bg-red-600 text-white' : 'bg-red-200 text-red-800'}">
                                                ${oa.percentage}% logro
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-700 mb-1">${oa.texto}</p>
                                        <p class="text-xs text-gray-500">
                                            <i class="fas fa-layer-group mr-1"></i>${oa.unidad} | 
                                            <i class="fas fa-graduation-cap ml-2 mr-1"></i>${oa.nivel} |
                                            <i class="fas fa-users ml-2 mr-1"></i>${oa.cumplidos}/${oa.totalStudents} cumplidos
                                        </p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="overflow-x-auto">
                        <h5 class="font-bold text-gray-800 mb-3">Detalle Completo de OAs</h5>
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Código</th>
                                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Objetivo de Aprendizaje</th>
                                    <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase">Unidad</th>
                                    <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase">Nivel</th>
                                    <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase">Cumplidos</th>
                                    <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase">% Logro</th>
                                    <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase">Estado</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${allOAs.map(oa => {
                                    const percentage = parseFloat(oa.percentage);
                                    let statusColor, statusText, statusIcon;
                                    
                                    if (percentage >= 80) {
                                        statusColor = 'green';
                                        statusText = 'Consolidado';
                                        statusIcon = 'check-circle';
                                    } else if (percentage >= 60) {
                                        statusColor = 'blue';
                                        statusText = 'En desarrollo';
                                        statusIcon = 'spinner';
                                    } else if (percentage >= 40) {
                                        statusColor = 'orange';
                                        statusText = 'En riesgo';
                                        statusIcon = 'exclamation-triangle';
                                    } else {
                                        statusColor = 'red';
                                        statusText = 'Crítico';
                                        statusIcon = 'times-circle';
                                    }
                                    
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-3 py-2 font-bold text-${statusColor}-700">${oa.codigo}</td>
                                            <td class="px-3 py-2 text-gray-900">${oa.texto}</td>
                                            <td class="px-3 py-2 text-center text-xs text-gray-600">${oa.unidad}</td>
                                            <td class="px-3 py-2 text-center">
                                                <span class="inline-flex px-2 py-0.5 text-xs font-semibold rounded bg-indigo-100 text-indigo-800">
                                                    ${oa.nivel}
                                                </span>
                                            </td>
                                            <td class="px-3 py-2 text-center font-semibold text-gray-700">
                                                ${oa.cumplidos}/${oa.totalStudents}
                                            </td>
                                            <td class="px-3 py-2 text-center">
                                                <div class="flex items-center justify-center">
                                                    <div class="w-full bg-gray-200 rounded-full h-2 mr-2" style="max-width: 60px;">
                                                        <div class="bg-${statusColor}-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                                    </div>
                                                    <span class="text-xs font-bold text-${statusColor}-700">${percentage}%</span>
                                                </div>
                                            </td>
                                            <td class="px-3 py-2 text-center">
                                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-bold rounded bg-${statusColor}-100 text-${statusColor}-800">
                                                    <i class="fas fa-${statusIcon} mr-1"></i>
                                                    ${statusText}
                                                </span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-4">
                        <i class="fas fa-info-circle text-blue-500"></i> 
                        <strong>Interpretación:</strong> Consolidado (â‰¥80%), En desarrollo (60-79%), En riesgo (40-59%), Crítico (<40%)
                    </p>
                </div>
            `;
        }
        
        // Tabla de rendimiento individual de estudiantes
        function buildStudentsPerformanceTable(students) {
            if (!courseData || !courseData.tasks || !Array.isArray(courseData.tasks)) {
                return '<div class="bg-yellow-50 p-6 rounded-lg"><p class="text-yellow-800">No hay tareas para mostrar el rendimiento.</p></div>';
            }
            
            return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-user-graduate mr-2 text-blue-600"></i>
                        Rendimiento Individual por Estudiante
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase sticky left-0 bg-gray-50">#</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase sticky left-8 bg-gray-50">Estudiante</th>
                                    ${courseData.tasks.map((task, index) => `
                                        <th class="px-3 py-3 text-center text-xs font-bold text-gray-700 uppercase" title="${task.name}">
                                            T${index + 1}
                                        </th>
                                    `).join('')}
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase bg-blue-50">Completadas</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase bg-green-50">Promedio</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase bg-purple-50">Estado</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${students.map((student, index) => {
                                    // Validar que student existe
                                    if (!student) {
                                        console.warn(`Estudiante en índice ${index} es null/undefined`);
                                        return '';
                                    }
                                    
                                    // Asegurar que grades existe y es un array
                                    const studentGrades = student.grades && Array.isArray(student.grades) ? student.grades : [];
                                    
                                    // Normalizar grades para que coincida con el nÃºmero de tareas
                                    const normalizedGrades = Array.from({ length: courseData.tasks.length }, (_, i) => 
                                        i < studentGrades.length ? studentGrades[i] : null
                                    );
                                    
                                    // Calcular puntos con grades normalizadas
                                    const points = normalizedGrades.filter(g => g).length;
                                    const grade = calculateGrade(points, courseData.tasks.length);
                                    const gradeColor = grade >= 5.5 ? 'green' : grade >= 4.5 ? 'blue' : grade >= 4.0 ? 'orange' : 'red';
                                    const status = grade >= 4.0 ? 'Aprobado' : 'Reprobado';
                                    const statusIcon = grade >= 4.0 ? 'check-circle' : 'times-circle';
                                    
                                    // Construir nombre completo del estudiante
                                    const fullName = student.name || 
                                                   `${student.lastName1 || ''} ${student.lastName2 || ''} ${student.name || ''}`.trim() ||
                                                   'Sin nombre';
                                    
                                    return `
                                        <tr class="hover:bg-gray-50 ${student.retired ? 'opacity-50' : ''}">
                                            <td class="px-4 py-3 text-center font-bold text-gray-600 sticky left-0 bg-white">${index + 1}</td>
                                            <td class="px-4 py-3 font-semibold text-gray-900 sticky left-8 bg-white">
                                                ${fullName}
                                                ${student.retired ? '<span class="ml-2 text-xs text-red-600">(Retirado)</span>' : ''}
                                            </td>
                                            ${normalizedGrades.map(g => `
                                                <td class="px-3 py-3 text-center">
                                                    ${g ? '<i class="fas fa-check text-green-600 font-bold"></i>' : '<i class="fas fa-times text-red-400"></i>'}
                                                </td>
                                            `).join('')}
                                            <td class="px-4 py-3 text-center font-bold bg-blue-50">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-bold bg-blue-200 text-blue-900">
                                                    ${points}/${courseData.tasks.length}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-center font-bold bg-green-50">
                                                <span class="text-lg font-bold text-${gradeColor}-700">
                                                    ${grade.toFixed(2)}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-center bg-purple-50">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-${gradeColor}-100 text-${gradeColor}-800">
                                                    <i class="fas fa-${statusIcon} mr-1"></i>
                                                    ${status}
                                                </span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">
                        <i class="fas fa-info-circle text-blue-500"></i> 
                        T1, T2, T3... = Tareas numeradas. âœ” = Completada, âœ– = Pendiente
                    </p>
                </div>
            `;
        }
        
        // Sección de recomendaciones
        function buildRecommendationsSection(recommendations) {
            if (!recommendations || recommendations.length === 0) {
                return '<p class="text-gray-500">No hay recomendaciones disponibles.</p>';
            }
            
            const typeStyles = {
                'critical': { bg: 'red', icon: 'exclamation-circle', border: 'red-500' },
                'warning': { bg: 'orange', icon: 'exclamation-triangle', border: 'orange-500' },
                'success': { bg: 'green', icon: 'check-circle', border: 'green-500' },
                'info': { bg: 'blue', icon: 'info-circle', border: 'blue-500' }
            };
            
            return `
                <div class="bg-gradient-to-br from-purple-50 to-indigo-50 p-6 rounded-lg shadow-md border-2 border-purple-300">
                    <h4 class="text-xl font-bold mb-4 flex items-center text-purple-900">
                        <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                        Recomendaciones Pedagógicas
                    </h4>
                    <p class="text-sm text-purple-800 mb-4 italic">
                        <i class="fas fa-robot mr-1"></i>
                        Análisis generado automáticamente basado en rendimiento del curso y cumplimiento de Objetivos de Aprendizaje
                    </p>
                    <div class="space-y-4">
                        ${recommendations.map((rec, index) => {
                            const style = typeStyles[rec.type] || typeStyles['info'];
                            return `
                                <div class="bg-white p-4 rounded-lg border-l-4 border-${style.border} shadow-sm hover:shadow-md transition-shadow">
                                    <div class="flex items-start">
                                        <div class="text-3xl mr-3">${rec.icon}</div>
                                        <div class="flex-1">
                                            <h5 class="font-bold text-${style.bg}-800 text-lg mb-2">${rec.title}</h5>
                                            <p class="text-gray-700 leading-relaxed">${rec.text}</p>
                                        </div>
                                        <div class="ml-3">
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-${style.bg}-100 text-${style.bg}-800">
                                                <i class="fas fa-${style.icon} mr-1"></i>
                                                ${rec.type.toUpperCase()}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="mt-6 bg-white p-4 rounded-lg border border-purple-200">
                        <p class="text-xs text-gray-600 leading-relaxed">
                            <i class="fas fa-book-reader text-purple-600 mr-1"></i>
                            <strong>Nota:</strong> Estas recomendaciones se basan en el Marco para la Buena Enseñanza (MBE 2021), 
                            las Bases Curriculares de Lenguaje MINEDUC y análisis estadístico del rendimiento del curso. 
                            Se sugiere complementar con observación directa del contexto áulico y entrevistas con estudiantes.
                        </p>
                    </div>
                </div>
            `;
        }

        // Poblar selector de estudiantes
        function populateStudentSelect() {
            if (!courseData) {
                console.warn('No hay courseData para poblar selector');
                return;
            }
            
            const select = document.getElementById('studentSelect');
            if (!select) {
                console.warn('No se encontró el selector de estudiantes');
                return;
            }
            
            select.innerHTML = '<option value="">-- Seleccione un estudiante --</option>';
            
            courseData.students.forEach((student, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${student.lastName1} ${student.lastName2}, ${student.name}`;
                select.appendChild(option);
            });
        }

        // Generar informe individual
        function generateIndividualReport() {
            const select = document.getElementById('studentSelect');
            const index = select.value;
            
            if (index === '') {
                document.getElementById('individualReportContent').classList.add('hidden');
                return;
            }
            
            const student = courseData.students[index];
            
            // Validar y normalizar grades
            const studentGrades = student.grades && Array.isArray(student.grades) ? student.grades : [];
            const normalizedGrades = Array.from({ length: courseData.tasks.length }, (_, i) => 
                i < studentGrades.length ? studentGrades[i] : null
            );
            
            // CORREGIDO: Usar isTaskCompleted() para contar puntos correctamente
            const points = normalizedGrades.filter((grade, i) => 
                isTaskCompleted(grade, courseData.tasks[i])
            ).length;
            const finalGrade = calculateGrade(points, courseData.tasks.length);
            
            const reportDiv = document.getElementById('individualReportContent');
            reportDiv.classList.remove('hidden');
            
            const completedTasks = [];
            const pendingTasks = [];
            
            // CORREGIDO: Usar isTaskCompleted() para determinar estado
            normalizedGrades.forEach((grade, i) => {
                const task = courseData.tasks[i];
                if (isTaskCompleted(grade, task)) {
                    completedTasks.push({ name: task.name, index: i + 1 });
                } else {
                    pendingTasks.push({ name: task.name, index: i + 1 });
                }
            });
            
            reportDiv.innerHTML = `
                <div class="space-y-6">
                    <div class="border-b pb-4">
                        <h3 class="text-2xl font-bold text-gray-800">${student.name} ${student.lastName1} ${student.lastName2}</h3>
                        <p class="text-gray-600">Curso: ${courseData.courseName} - ${courseData.subject}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <div class="text-sm text-gray-600">Nota Final</div>
                            <div class="text-3xl font-bold ${finalGrade >= 4.0 ? 'text-green-600' : 'text-red-600'}">${finalGrade.toFixed(1)}</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-sm text-gray-600">Tareas Completadas</div>
                            <div class="text-3xl font-bold text-blue-600">${points}/${courseData.tasks.length}</div>
                        </div>
                    </div>
                    
                    <!-- Tareas Completadas - Diseño Visual Mejorado -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-4 text-green-800 flex items-center">
                            <i class="fas fa-check-circle text-2xl mr-2"></i>
                            Tareas Completadas (${completedTasks.length})
                        </h4>
                        ${completedTasks.length > 0 ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                ${completedTasks.map((task) => `
                                    <div class="bg-white rounded-lg p-3 shadow-sm border-l-4 border-green-500 hover:shadow-md transition-all">
                                        <div class="flex items-center">
                                            <div class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">
                                                ${task.index}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-semibold text-gray-800 truncate" title="${task.name}">${task.name}</p>
                                                <p class="text-xs text-green-600">âœ“ Completada</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500 italic">No hay tareas completadas aÃºn</p>'}
                    </div>
                    
                    <!-- Tareas Pendientes - Diseño Visual Mejorado -->
                    ${pendingTasks.length > 0 ? `
                    <div class="bg-gradient-to-br from-orange-50 to-amber-50 border-2 border-orange-200 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-4 text-orange-800 flex items-center">
                            <i class="fas fa-hourglass-half text-2xl mr-2"></i>
                            Tareas Pendientes (${pendingTasks.length})
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${pendingTasks.map((task) => `
                                <div class="bg-white rounded-lg p-3 shadow-sm border-l-4 border-orange-500 hover:shadow-md transition-all">
                                    <div class="flex items-center">
                                        <div class="bg-orange-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">
                                            ${task.index}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-semibold text-gray-800 truncate" title="${task.name}">${task.name}</p>
                                            <p class="text-xs text-orange-600">â³ Por completar</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : '<div class="bg-gradient-to-r from-green-100 to-emerald-100 border-2 border-green-300 p-6 rounded-lg text-center"><div class="text-4xl mb-2">ðŸŽ‰</div><p class="text-green-800 font-bold text-lg">Â¡Felicitaciones!</p><p class="text-green-700">Todas las tareas están completadas</p></div>'}
                    
                    <!-- Retroalimentación Profesional - Expandible Automáticamente -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-5 print:break-inside-avoid">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-xl text-blue-900 flex items-center">
                                <i class="fas fa-comment-dots text-2xl mr-2"></i>
                                Retroalimentación Pedagógica
                            </h4>
                            <button onclick="openFeedbackBank(${index}, ${finalGrade}, ${points}, ${courseData.tasks.length})" 
                                    class="text-sm bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-4 py-2 rounded-lg hover:from-purple-600 hover:to-indigo-600 transition-all shadow-md hover:shadow-lg no-print">
                                <i class="fas fa-lightbulb mr-2"></i>Banco de Retroalimentaciones
                            </button>
                        </div>
                        <div class="bg-white rounded-lg border border-blue-200 p-4 print:border-gray-300">
                            <textarea id="studentNotes_${index}" 
                                      class="w-full p-4 border-2 border-blue-200 rounded-lg focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all resize-none overflow-hidden print:border-none print:p-2" 
                                      style="min-height: 250px; height: auto;"
                                      placeholder="Escriba aquí la retroalimentación personalizada para el estudiante...&#10;&#10;âœï¸ Consejos:&#10;• Mencione logros específicos&#10;• Identifique áreas de mejora&#10;• Sugiera estrategias concretas&#10;• Use lenguaje motivador y constructivo"
                                      oninput="autoResizeTextarea(this)"
                                      onchange="saveStudentNotes(${index}, this.value)">${student.notes || ''}</textarea>
                            ${student.notes ? `
                                <div class="mt-3 pt-3 border-t border-blue-200 text-xs text-gray-600 flex items-center justify-between">
                                    <span><i class="fas fa-save mr-1"></i>Retroalimentación guardada automáticamente</span>
                                    <span>${(student.notes || '').split(/\s+/).length} palabras</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Botones de Acción -->
                    <div class="flex gap-3 no-print">
                        <button onclick="downloadIndividualReportPDF(${index})" class="flex-1 btn-action bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 shadow-lg hover:shadow-xl transition-all">
                            <i class="fas fa-file-pdf mr-2"></i>Descargar PDF
                        </button>
                        <button onclick="printIndividualReport()" class="flex-1 btn-action bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 shadow-lg hover:shadow-xl transition-all">
                            <i class="fas fa-print mr-2"></i>Imprimir
                        </button>
                    </div>
                </div>
            `;
            
            // Auto-ajustar el textarea después de cargar el contenido
            setTimeout(() => {
                const textarea = document.getElementById(`studentNotes_${index}`);
                if (textarea) {
                    autoResizeTextarea(textarea);
                }
            }, 100);
        }

        // Guardar notas del estudiante
        function saveStudentNotes(index, notes) {
            courseData.students[index].notes = notes;
            saveAllCourses();
        }
        
        // Auto-resize textarea para mostrar todo el contenido sin scroll
        function autoResizeTextarea(textarea) {
            // Reset height to get the correct scrollHeight
            textarea.style.height = 'auto';
            // Set new height based on content
            const newHeight = Math.max(250, textarea.scrollHeight);
            textarea.style.height = newHeight + 'px';
        }
        
        // Inicializar auto-resize en textareas al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Observar cambios en el DOM para aplicar auto-resize a nuevos textareas
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            const textareas = node.querySelectorAll ? node.querySelectorAll('textarea[id^="studentNotes_"]') : [];
                            textareas.forEach(function(textarea) {
                                autoResizeTextarea(textarea);
                            });
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });

        // Descargar informe individual como PDF
        async function downloadIndividualReportPDF(index) {
            const student = courseData.students[index];
            const fileName = `Informe_${student.name}_${student.lastName1}_${courseData.courseName.replace(/\s+/g, '_')}.pdf`;
            
            // Buscar el contenedor del informe individual (ID correcto)
            const reportElement = document.getElementById('individualReportContent');
            
            if (!reportElement || reportElement.classList.contains('hidden') || !reportElement.innerHTML.trim()) {
                alert('âš ï¸ No se encontró el informe. Por favor, genera el informe primero seleccionando un estudiante.');
                return;
            }
            
            // Mostrar mensaje de carga
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'pdf-loading';
            loadingMsg.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingMsg.innerHTML = `
                <div class="bg-white rounded-lg p-8 text-center shadow-2xl max-w-md">
                    <i class="fas fa-file-pdf text-6xl text-red-500 mb-4 animate-pulse"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Generando PDF de ${student.name}</h3>
                    <p class="text-gray-600 mb-3">Procesando informe individual...</p>
                    <div class="mt-4">
                        <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-indigo-600 border-r-transparent"></div>
                    </div>
                    <p class="text-sm text-gray-500 mt-4">â±ï¸ Esto puede tomar 10-15 segundos</p>
                </div>
            `;
            document.body.appendChild(loadingMsg);
            
            try {
                // Ocultar temporalmente los botones "no-print"
                const noPrintElements = reportElement.querySelectorAll('.no-print');
                noPrintElements.forEach(el => el.style.display = 'none');
                
                // Esperar un momento para que se renderice
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Capturar con html2canvas con configuración ULTRA OPTIMIZADA para PDF
                const canvas = await html2canvas(reportElement, {
                    scale: 3, // MÃXIMA calidad (3x para texto sÃºper nítido y sin marca de agua)
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    imageTimeout: 0,
                    removeContainer: true,
                    letterRendering: true, // Renderizado perfecto de texto
                    windowWidth: 1400, // Ancho fijo mayor para más calidad
                    onclone: (clonedDoc) => {
                        // Ajustar estilos en el documento clonado para MÃXIMA calidad de impresión
                        const clonedElement = clonedDoc.getElementById('individualReportContent');
                        if (clonedElement) {
                            clonedElement.style.maxWidth = '1400px';
                            clonedElement.style.padding = '20px';
                            clonedElement.style.fontSmoothing = 'antialiased';
                            clonedElement.style.webkitFontSmoothing = 'antialiased';
                            
                            // Ajustar textarea para que se vea como texto estático NÃTIDO
                            const textareas = clonedElement.querySelectorAll('textarea');
                            textareas.forEach(textarea => {
                                const div = clonedDoc.createElement('div');
                                div.className = 'whitespace-pre-wrap text-gray-800 text-sm leading-relaxed';
                                div.style.cssText = 'white-space: pre-wrap; word-wrap: break-word; padding: 12px; line-height: 1.7; font-family: system-ui; color: #1f2937;';
                                div.textContent = textarea.value;
                                textarea.parentNode.replaceChild(div, textarea);
                            });
                        }
                    }
                });
                
                // Calcular dimensiones para PDF A4
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Crear PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgData = canvas.toDataURL('image/png', 1.0);
                
                // Si el contenido es más alto que una página, dividir en mÃºltiples páginas
                let heightLeft = imgHeight;
                let position = 0;
                const margin = 10; // margen superior/inferior
                
                // Primera página
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Páginas adicionales si es necesario
                while (heightLeft > margin) {
                    position = -(pageHeight - margin) * (Math.ceil((imgHeight - heightLeft) / pageHeight));
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Descargar el PDF
                pdf.save(fileName);
                
                // Restaurar elementos ocultos
                noPrintElements.forEach(el => el.style.display = '');
                
                // Remover mensaje de carga
                document.body.removeChild(loadingMsg);
                
                // Mostrar mensaje de éxito
                showNotification(`✅ PDF de ${student.name} generado exitosamente`, 'success');
                
            } catch (error) {
                console.error('Error generando PDF individual:', error);
                document.body.removeChild(loadingMsg);
                
                // Restaurar elementos ocultos
                const noPrintElements = reportElement.querySelectorAll('.no-print');
                noPrintElements.forEach(el => el.style.display = '');
                
                alert(`âŒ Error al generar el PDF de ${student.name}. Puedes intentar con la opción de imprimir (Ctrl+P).`);
            }
        }
        
        // Imprimir informe individual
        function printIndividualReport() {
            // Abrir diálogo de impresión directamente
            window.print();
        }

        // Guardar configuración
        function saveConfig() {
            courseData.config = {
                minGrade: parseFloat(document.getElementById('minGrade').value),
                maxGrade: parseFloat(document.getElementById('maxGrade').value),
                passingGrade: parseFloat(document.getElementById('passingGrade').value),
                passingPercentage: parseInt(document.getElementById('passingPercentage').value)
            };
            renderTable(); // Recalcular notas con nuevo porcentaje
            saveAllCourses();
            alert('✅ Configuración guardada. Las notas se han recalculado.');
        }

        // Resetear datos
        function resetData() {
            if (confirm('âš ï¸ Â¿Está COMPLETAMENTE SEGURO de borrar TODOS los datos del curso actual? Esta acción NO se puede deshacer.')) {
                if (confirm('Esta es su Ãºltima oportunidad. Â¿Confirma que desea borrar todo?')) {
                    courseData.students = [];
                    courseData.tasks = [];
                    renderTable();
                    saveAllCourses();
                    location.reload();
                }
            }
        }

        // Estilos adicionales
        const style = document.createElement('style');
        style.textContent = `
            .stat-item {
                padding: 1rem;
                background-color: #f9fafb;
                border-radius: 0.5rem;
                border-left: 4px solid #6366f1;
            }
        `;
        document.head.appendChild(style);

        // Cerrar modales al hacer click fuera
        window.onclick = function(event) {
            const editModal = document.getElementById('editStudentModal');
            const taskModal = document.getElementById('addTaskModal');
            const feedbackModal = document.getElementById('feedbackBankModal');
            
            if (event.target == editModal) {
                editModal.style.display = 'none';
            }
            if (event.target == taskModal) {
                taskModal.style.display = 'none';
            }
            if (event.target == feedbackModal) {
                feedbackModal.style.display = 'none';
            }
        }

        // --- BANCO DE RETROALIMENTACIONES ---
        let feedbackData = null;
        let currentStudentIndexForFeedback = null;

        // Cargar banco de retroalimentaciones
        async function loadFeedbackBank() {
            if (feedbackData) return feedbackData;
            
            try {
                const response = await fetch('banco-retroalimentaciones.json');
                feedbackData = await response.json();
                return feedbackData;
            } catch (error) {
                console.error('Error cargando banco de retroalimentaciones:', error);
                alert('Error al cargar el banco de retroalimentaciones');
                return null;
            }
        }

        // --- OBJETIVOS DE APRENDIZAJE ---
        let oasData = null;

        // Cargar OAs del currículum
        async function loadOAsData() {
            if (oasData) return oasData;
            
            try {
                const response = await fetch('objetivos-aprendizaje-lenguaje-NUEVO.json');
                oasData = await response.json();
                return oasData;
            } catch (error) {
                console.error('Error cargando objetivos de aprendizaje:', error);
                return null;
            }
        }

        // Cargar unidades al seleccionar nivel
        async function loadUnitsForTask() {
            const level = document.getElementById('taskLevel').value;
            const unitContainer = document.getElementById('taskUnitContainer');
            const unitSelect = document.getElementById('taskUnit');
            const oasContainer = document.getElementById('taskOAsContainer');
            
            if (!level) {
                unitContainer.style.display = 'none';
                oasContainer.style.display = 'none';
                return;
            }
            
            const data = await loadOAsData();
            if (!data) return;
            
            const levelData = data.niveles[level];
            if (!levelData) return;
            
            // Limpiar y poblar selector de unidades
            unitSelect.innerHTML = '<option value="">Seleccione una unidad</option>';
            levelData.unidades.forEach((unidad, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Unidad ${unidad.numero}: ${unidad.nombre}`;
                unitSelect.appendChild(option);
            });
            
            unitContainer.style.display = 'block';
            oasContainer.style.display = 'none';
        }

        // Cargar OAs al seleccionar unidad
        async function loadOAsForTask() {
            const level = document.getElementById('taskLevel').value;
            const unitIndex = document.getElementById('taskUnit').value;
            const oasContainer = document.getElementById('taskOAsContainer');
            const oasList = document.getElementById('taskOAsList');
            
            if (!level || unitIndex === '') {
                oasContainer.style.display = 'none';
                return;
            }
            
            const data = await loadOAsData();
            if (!data) return;
            
            const unidad = data.niveles[level].unidades[parseInt(unitIndex)];
            if (!unidad) return;
            
            // Limpiar y poblar lista de OAs
            oasList.innerHTML = '';
            unidad.oas.forEach((oa) => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-300 rounded-lg p-3 hover:border-blue-400 transition-all';
                div.innerHTML = `
                    <label class="flex items-start cursor-pointer">
                        <input type="checkbox" 
                               class="mt-1 mr-3" 
                               value="${oa.codigo}" 
                               data-nivel="${level}"
                               data-unidad="${unitIndex}"
                               name="taskOA">
                        <div class="flex-1">
                            <div class="font-semibold text-blue-600 mb-1">${oa.codigo}</div>
                            <div class="text-sm text-gray-700">${oa.texto.substring(0, 150)}...</div>
                        </div>
                    </label>
                `;
                oasList.appendChild(div);
            });
            
            oasContainer.style.display = 'block';
        }

        // Determinar nivel de rendimiento segÃºn porcentaje
        function determinePerformanceLevel(percentage) {
            if (percentage >= 90) return 'excelente';
            if (percentage >= 80) return 'muy_bueno';
            if (percentage >= 70) return 'bueno';
            if (percentage >= 60) return 'suficiente';
            if (percentage >= 40) return 'insuficiente';
            return 'deficiente';
        }

        // Abrir modal del banco de retroalimentaciones
        async function openFeedbackBank(studentIndex, finalGrade, points, totalTasks) {
            currentStudentIndexForFeedback = studentIndex;
            const student = courseData.students[studentIndex];
            const percentage = (points / totalTasks * 100).toFixed(0);
            const level = determinePerformanceLevel(percentage);
            
            const bank = await loadFeedbackBank();
            if (!bank) return;
            
            // Analizar OAs del estudiante
            const oasAnalysis = await analyzeStudentOAs(student);
            
            const modal = document.getElementById('feedbackBankModal');
            const content = document.getElementById('feedbackBankContent');
            
            // Obtener retroalimentaciones del nivel correspondiente
            const feedbacks = bank.retroalimentaciones[level];
            const levelInfo = bank.rangos_rendimiento[level];
            
            // Color segÃºn nivel
            const levelColors = {
                'excelente': 'green',
                'muy_bueno': 'blue',
                'bueno': 'indigo',
                'suficiente': 'yellow',
                'insuficiente': 'orange',
                'deficiente': 'red'
            };
            const color = levelColors[level];
            
            content.innerHTML = buildFeedbackModalContent(student, finalGrade, percentage, level, levelInfo, feedbacks, color, points, totalTasks, oasAnalysis);
            modal.style.display = 'block';
        }

        // Analizar OAs cumplidos y no cumplidos del estudiante
        async function analyzeStudentOAs(student) {
            try {
                const oasCumplidos = new Map();
                const oasNoCumplidos = new Map();
                const oasData = await loadOAsData();
                
                if (!oasData || !oasData.niveles) {
                    console.log('No hay datos de OAs disponibles para analizar');
                    return {
                        cumplidos: [],
                        noCumplidos: []
                    };
                }
                
                if (!courseData || !courseData.tasks) {
                    return {
                        cumplidos: [],
                        noCumplidos: []
                    };
                }
                
                courseData.tasks.forEach((task, taskIndex) => {
                    try {
                        if (task.oas && Array.isArray(task.oas) && task.oas.oas.length > 0) {
                            // Validar grades antes de acceder
                            const studentGrades = student.grades && Array.isArray(student.grades) ? student.grades : [];
                            const cumplida = studentGrades[taskIndex];
                            
                            task.oas.forEach(oaRef => {
                                try {
                                    const key = `${oaRef.nivel}_${oaRef.unidad}_${oaRef.codigo}`;
                                    
                                    // Obtener detalles del OA
                                    if (oasData.niveles[oaRef.nivel]) {
                                        const unidades = oasData.niveles[oaRef.nivel].unidades;
                                        const unidad = unidades[parseInt(oaRef.unidad)];
                                        
                                        if (unidad && unidad.oas) {
                                            const oaDetalle = unidad.oas.find(oa => oa.codigo === oaRef.codigo);
                                            if (oaDetalle) {
                                                const oaInfo = {
                                                    codigo: oaRef.codigo,
                                                    texto: oaDetalle.texto,
                                                    nivel: oasData.niveles[oaRef.nivel].nombre || oaRef.nivel,
                                                    unidad: unidad.nombre || `Unidad ${oaRef.unidad}`
                                                };
                                                
                                                if (cumplida) {
                                                    if (!oasCumplidos.has(key)) {
                                                        oasCumplidos.set(key, { ...oaInfo, tareas: [] });
                                                    }
                                                    oasCumplidos.get(key).tareas.push(task.name);
                                                } else {
                                                    if (!oasNoCumplidos.has(key)) {
                                                        oasNoCumplidos.set(key, { ...oaInfo, tareas: [] });
                                                    }
                                                    oasNoCumplidos.get(key).tareas.push(task.name);
                                                }
                                            }
                                        }
                                    }
                                } catch (oaError) {
                                    console.error(`Error procesando OA ${oaRef.codigo}:`, oaError);
                                }
                            });
                        }
                    } catch (taskError) {
                        console.error(`Error procesando tarea ${task.name}:`, taskError);
                    }
                });
                
                return {
                    cumplidos: Array.from(oasCumplidos.values()),
                    noCumplidos: Array.from(oasNoCumplidos.values())
                };
            } catch (error) {
                console.error('Error en analyzeStudentOAs:', error);
                return {
                    cumplidos: [],
                    noCumplidos: []
                };
            }
        }
        
        function buildFeedbackModalContent(student, finalGrade, percentage, level, levelInfo, feedbacks, color, points, totalTasks, oasAnalysis) {
            let html = `<div class="bg-white rounded-lg shadow-xl max-w-5xl mx-auto my-8">`;
            html += buildModalHeader(student, finalGrade, percentage, levelInfo, color);
            html += `<div class="p-6 max-h-[70vh] overflow-y-auto">`;
            
            // Sección de análisis de OAs
            const cumplidos = oasAnalysis && oasAnalysis.cumplidos && Array.isArray(oasAnalysis.cumplidos) ? oasAnalysis.cumplidos : [];
            const noCumplidos = oasAnalysis && oasAnalysis.noCumplidos && Array.isArray(oasAnalysis.noCumplidos) ? oasAnalysis.noCumplidos : [];
            if (cumplidos.length > 0 || noCumplidos.length > 0) {
                html += buildStudentOAsAnalysisSection(oasAnalysis, color);
            }
            
            html += buildGeneralFeedbackSection(feedbacks.generales, student.name, color);
            html += buildSpecificFeedbackSection(feedbacks.especificas, color);
            html += buildSuggestionsSection(feedbacks.sugerencias);
            html += buildStrategiesSection(feedbacks.estrategias);
            html += buildImprovementPlanSection(feedbacks.plan_mejora);
            html += buildRecoveryPlanSection(feedbacks.plan_recuperacion);
            html += buildChallengesSection(feedbacks.desafios, color);
            html += buildQuickGeneratorSection(level, student.name, percentage, points, totalTasks);
            html += `</div>`;
            html += buildModalFooter();
            html += `</div>`;
            return html;
        }

        // Construir sección de análisis de OAs
        // Sección de análisis de OAs para INFORME INDIVIDUAL de estudiante
        function buildStudentOAsAnalysisSection(oasAnalysis, color) {
            // Validar que oasAnalysis existe y tiene las propiedades necesarias
            if (!oasAnalysis) {
                return `
                    <div class="mb-6 bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                        <p class="text-yellow-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            No hay análisis de OAs disponible.
                        </p>
                    </div>
                `;
            }
            
            // Asegurar que cumplidos y noCumplidos sean arrays
            const cumplidos = oasAnalysis.cumplidos && Array.isArray(oasAnalysis.cumplidos) ? oasAnalysis.cumplidos : [];
            const noCumplidos = oasAnalysis.noCumplidos && Array.isArray(oasAnalysis.noCumplidos) ? oasAnalysis.noCumplidos : [];
            
            let html = `
                <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-gray-800 mb-3">
                        <i class="fas fa-bullseye text-blue-500 mr-2"></i>
                        Análisis de Objetivos de Aprendizaje (OAs)
                    </h4>
            `;
            
            // OAs Cumplidos
            if (cumplidos.length > 0) {
                html += `
                    <div class="mb-4">
                        <h5 class="font-semibold text-green-700 mb-2 flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            OAs Logrados (${cumplidos.length})
                        </h5>
                        <div class="space-y-2">
                `;
                
                cumplidos.forEach(oa => {
                    const tareasTexto = oa.tareas.join(', ');
                    html += `
                        <div class="bg-white border-l-4 border-green-500 p-3 rounded shadow-sm">
                            <div class="flex items-start">
                                <span class="bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded mr-2">${oa.codigo}</span>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-700 font-medium">${oa.texto.substring(0, 120)}...</p>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <i class="fas fa-book mr-1"></i>${oa.nivel} - ${oa.unidad}
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        <i class="fas fa-tasks mr-1"></i>Tareas: ${tareasTexto}
                                    </div>
                                </div>
                                <button onclick="insertOAFeedback('${oa.codigo}', true, '${oa.texto.replace(/'/g, "\\'")}', '${tareasTexto}')" 
                                        class="text-xs bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">
                                    <i class="fas fa-plus-circle mr-1"></i>Insertar
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            // OAs No Cumplidos
            if (noCumplidos.length > 0) {
                html += `
                    <div>
                        <h5 class="font-semibold text-red-700 mb-2 flex items-center">
                            <i class="fas fa-times-circle mr-2"></i>
                            OAs Por Lograr (${noCumplidos.length})
                        </h5>
                        <div class="space-y-2">
                `;
                
                noCumplidos.forEach(oa => {
                    const tareasTexto = oa.tareas.join(', ');
                    html += `
                        <div class="bg-white border-l-4 border-red-500 p-3 rounded shadow-sm">
                            <div class="flex items-start">
                                <span class="bg-red-100 text-red-800 text-xs font-semibold px-2 py-1 rounded mr-2">${oa.codigo}</span>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-700 font-medium">${oa.texto.substring(0, 120)}...</p>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <i class="fas fa-book mr-1"></i>${oa.nivel} - ${oa.unidad}
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        <i class="fas fa-tasks mr-1"></i>Tareas pendientes: ${tareasTexto}
                                    </div>
                                </div>
                                <button onclick="insertOAFeedback('${oa.codigo}', false, '${oa.texto.replace(/'/g, "\\'")}', '${tareasTexto}')" 
                                        class="text-xs bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">
                                    <i class="fas fa-plus-circle mr-1"></i>Insertar
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            html += `</div>`;
            return html;
        }

        // Insertar retroalimentación específica de OA
        function insertOAFeedback(codigo, cumplido, texto, tareas) {
            let feedback = '';
            
            if (cumplido) {
                feedback = `✅ ${codigo}: Has logrado exitosamente este objetivo de aprendizaje en las siguientes tareas: ${tareas}. `;
                feedback += `Tu desempeño refleja comprensión y dominio de: "${texto.substring(0, 100)}..."`;
            } else {
                feedback = `âš ï¸ ${codigo}: Es necesario reforzar este objetivo de aprendizaje. Tareas pendientes: ${tareas}. `;
                feedback += `Debes trabajar en: "${texto.substring(0, 100)}..." Te sugiero revisar los contenidos y solicitar apoyo si es necesario.`;
            }
            
            insertFeedback(feedback);
        }
        
        function buildModalHeader(student, finalGrade, percentage, levelInfo, color) {
            return `
                <div class="bg-gradient-to-r from-${color}-500 to-${color}-600 text-white px-6 py-4 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold">
                            <i class="fas fa-lightbulb mr-2"></i>Banco de Retroalimentaciones
                        </h3>
                        <button onclick="closeFeedbackBank()" class="text-white hover:text-gray-200">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <p class="mt-2 text-${color}-50">
                        ${student.name} ${student.lastName1} - Nota: ${finalGrade.toFixed(1)} (${percentage}%) - 
                        Nivel: <strong>${levelInfo.nivel}</strong>
                    </p>
                </div>
            `;
        }
        
        function buildGeneralFeedbackSection(generales, studentName, color) {
            if (!generales || generales.length === 0) return '';
            return `
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">
                        <i class="fas fa-comment-dots text-${color}-500 mr-2"></i>
                        Retroalimentaciones Generales
                    </h4>
                    <div class="grid gap-3">
                        ${generales.map(fb => buildFeedbackCard(fb, studentName, color)).join('')}
                    </div>
                </div>
            `;
        }
        
        function buildFeedbackCard(text, studentName, color) {
            const displayText = text.replace('{nombre}', `<strong>${studentName}</strong>`);
            const insertText = text.replace('{nombre}', studentName);
            return `
                <div class="bg-${color}-50 border-l-4 border-${color}-500 p-4 rounded hover:bg-${color}-100 cursor-pointer transition-all"
                     onclick='insertFeedback(\`${insertText.replace(/'/g, "\\'")}\`)'>
                    <p class="text-gray-700">${displayText}</p>
                    <button class="mt-2 text-sm text-${color}-600 hover:text-${color}-800">
                        <i class="fas fa-plus-circle mr-1"></i>Insertar
                    </button>
                </div>
            `;
        }
        
        function buildSpecificFeedbackSection(especificas, color) {
            if (!especificas) return '';
            let html = `
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">
                        <i class="fas fa-book-open text-${color}-500 mr-2"></i>
                        Retroalimentaciones por Ãrea
                    </h4>
            `;
            
            if (especificas.lectura) {
                html += buildAreaSection('ðŸ“– Lectura y Comprensión', especificas.lectura, 'blue');
            }
            if (especificas.escritura) {
                html += buildAreaSection('âœï¸ Escritura y Producción de Textos', especificas.escritura, 'purple');
            }
            if (especificas.comunicacion_oral) {
                html += buildAreaSection('ðŸ—£ï¸ Comunicación Oral', especificas.comunicacion_oral, 'green');
            }
            
            html += `</div>`;
            return html;
        }
        
        function buildAreaSection(title, items, color) {
            return `
                <div class="mb-4">
                    <h5 class="font-semibold text-gray-700 mb-2">${title}</h5>
                    <div class="grid gap-2">
                        ${items.map(fb => `
                            <div class="bg-${color}-50 border-l-4 border-${color}-400 p-3 rounded hover:bg-${color}-100 cursor-pointer transition-all"
                                 onclick='insertFeedback(\`${fb.replace(/'/g, "\\'")}\`)'>
                                <p class="text-sm text-gray-700">${fb}</p>
                                <button class="mt-2 text-xs text-${color}-600 hover:text-${color}-800">
                                    <i class="fas fa-plus-circle mr-1"></i>Insertar
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function buildSuggestionsSection(sugerencias) {
            if (!sugerencias || sugerencias.length === 0) return '';
            return `
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">
                        <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                        Sugerencias de Mejora
                    </h4>
                    <div class="grid gap-2">
                        ${sugerencias.map(fb => buildSimpleFeedbackCard(fb, 'yellow')).join('')}
                    </div>
                </div>
            `;
        }
        
        function buildStrategiesSection(estrategias) {
            if (!estrategias || estrategias.length === 0) return '';
            return `
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">
                        <i class="fas fa-chalkboard-teacher text-indigo-500 mr-2"></i>
                        Estrategias de Apoyo
                    </h4>
                    <div class="grid gap-2">
                        ${estrategias.map(fb => buildSimpleFeedbackCard(fb, 'indigo')).join('')}
                    </div>
                </div>
            `;
        }
        
        function buildImprovementPlanSection(planMejora) {
            if (!planMejora || planMejora.length === 0) return '';
            return `
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">
                        <i class="fas fa-tasks text-orange-500 mr-2"></i>
                        Plan de Mejora
                    </h4>
                    <div class="grid gap-2">
                        ${planMejora.map(fb => buildSimpleFeedbackCard(fb, 'orange')).join('')}
                    </div>
                </div>
            `;
        }
        
        function buildRecoveryPlanSection(planRecuperacion) {
            if (!planRecuperacion || planRecuperacion.length === 0) return '';
            return `
                <div class="mb-6 bg-red-50 border-2 border-red-300 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-red-800 mb-3">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Plan de Recuperación Urgente
                    </h4>
                    <div class="grid gap-2">
                        ${planRecuperacion.map(fb => `
                            <div class="bg-white border-l-4 border-red-500 p-3 rounded hover:bg-red-50 cursor-pointer transition-all"
                                 onclick='insertFeedback(\`${fb.replace(/'/g, "\\'")}\`)'>
                                <p class="text-sm text-gray-700 font-medium">${fb}</p>
                                <button class="mt-2 text-xs text-red-600 hover:text-red-800">
                                    <i class="fas fa-plus-circle mr-1"></i>Insertar
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function buildChallengesSection(desafios, color) {
            if (!desafios || desafios.length === 0) return '';
            return `
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">
                        <i class="fas fa-trophy text-${color}-500 mr-2"></i>
                        Desafíos y Proyecciones
                    </h4>
                    <div class="grid gap-2">
                        ${desafios.map(fb => buildSimpleFeedbackCard(fb, color)).join('')}
                    </div>
                </div>
            `;
        }
        
        function buildSimpleFeedbackCard(text, color) {
            return `
                <div class="bg-${color}-50 border-l-4 border-${color}-400 p-3 rounded hover:bg-${color}-100 cursor-pointer transition-all"
                     onclick='insertFeedback(\`${text.replace(/'/g, "\\'")}\`)'>
                    <p class="text-sm text-gray-700">${text}</p>
                    <button class="mt-2 text-xs text-${color}-600 hover:text-${color}-800">
                        <i class="fas fa-plus-circle mr-1"></i>Insertar
                    </button>
                </div>
            `;
        }
        
        function buildQuickGeneratorSection(level, studentName, percentage, points, totalTasks) {
            return `
                <div class="bg-gradient-to-r from-purple-100 to-indigo-100 border-2 border-purple-300 rounded-lg p-4 mb-4">
                    <h4 class="text-lg font-bold text-gray-800 mb-3">
                        <i class="fas fa-magic text-purple-500 mr-2"></i>
                        Generador Rápido de Retroalimentación
                    </h4>
                    <button onclick="generateCompleteFeedback('${level}', '${studentName}', ${percentage}, ${points}, ${totalTasks})"
                            class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-6 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-600 transition-all shadow-lg mb-2">
                        <i class="fas fa-wand-magic-sparkles mr-2"></i>
                        Generar Retroalimentación Automática (Plantillas)
                    </button>
                    <p class="text-xs text-gray-600 mt-1 mb-3 italic">
                        Genera una retroalimentación usando plantillas predefinidas del banco.
                    </p>
                </div>
                
                <div class="bg-gradient-to-r from-cyan-50 to-blue-50 border-2 border-cyan-300 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-gray-800 mb-3">
                        <i class="fas fa-robot text-cyan-500 mr-2"></i>
                        Generador con Inteligencia Artificial
                    </h4>
                    <p class="text-sm text-gray-700 mb-3">
                        Genera retroalimentación personalizada usando IA que analiza el rendimiento del estudiante, 
                        los OAs trabajados y el contexto curricular.
                    </p>
                    
                    <!-- Información del sistema Multi-IA -->
                    <div class="mb-4">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-300 rounded-lg p-4">
                            <h4 class="text-sm font-bold text-gray-800 mb-2">
                                <i class="fas fa-robot text-blue-500 mr-2"></i>
                                Sistema Multi-IA con Triple Respaldo
                            </h4>
                            <div class="text-xs text-gray-700 space-y-1">
                                <p><strong>✅ Siempre funciona</strong> - 3 métodos de generación:</p>
                                <p>1ï¸âƒ£ <strong>Gemini Pro</strong> (Google - si tienes API Key)</p>
                                <p>2ï¸âƒ£ <strong>HuggingFace</strong> (Gratis, sin API Key necesaria)</p>
                                <p>3ï¸âƒ£ <strong>Generador Inteligente</strong> (Siempre disponible)</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- API Key opcional -->
                    <details class="mb-3">
                        <summary class="cursor-pointer text-sm font-medium text-gray-700 hover:text-gray-900 mb-2">
                            <i class="fas fa-key mr-1"></i>Configurar API Key de Gemini (Opcional)
                        </summary>
                        <div class="mt-2 p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-600 mb-2">
                                Si tienes una API Key de Google Gemini, el sistema la usará primero. Si no, usará alternativas gratuitas.
                            </p>
                            <div class="flex gap-2">
                                <input type="password" 
                                       id="geminiApiKey" 
                                       placeholder="Pega tu API Key aquí (opcional)" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                       value="${getStorageItem('geminiApiKey') || DEFAULT_GEMINI_API_KEY}">
                                <button onclick="saveGeminiApiKey()" 
                                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">
                                    <i class="fas fa-external-link-alt mr-1"></i>Obtener API Key gratis en Google AI Studio
                                </a>
                            </p>
                        </div>
                    </details>
                    
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Enfoque de la retroalimentación:</label>
                        <select id="aiFeedbackFocus" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="general">General - Visión completa del desempeño</option>
                            <option value="oas">OAs - Enfocado en objetivos de aprendizaje</option>
                            <option value="motivacional">Motivacional - Enfatizar logros y potencial</option>
                            <option value="estrategias">Estrategias - Acciones concretas de mejora</option>
                            <option value="formativa">Formativa - Descriptiva y orientadora</option>
                        </select>
                    </div>
                    
                    <button onclick="generateAIFeedback('${level}', '${studentName}', ${percentage}, ${points}, ${totalTasks})" 
                            id="btnGenerateAI"
                            class="w-full bg-gradient-to-r from-purple-500 via-blue-500 to-cyan-500 text-white px-6 py-3 rounded-lg hover:from-purple-600 hover:via-blue-600 hover:to-cyan-600 transition-all shadow-lg font-medium">
                        <i class="fas fa-magic mr-2"></i>
                        Generar Retroalimentación con IA
                    </button>
                    <p class="text-xs text-center text-gray-500 mt-2">
                        âš¡ Sistema inteligente - Siempre funciona sin importar el método
                    </p>
                    
                    <div id="aiLoadingIndicator" style="display:none;" class="mt-3 text-center text-blue-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        <span id="aiLoadingText">Generando retroalimentación inteligente...</span>
                    </div>
                    
                    <p class="text-xs text-gray-600 mt-2 italic">
                        ðŸ’¡ La IA analiza todo el contexto: rendimiento, OAs, nivel, y genera una retroalimentación 
                        pedagógicamente fundamentada y personalizada.
                    </p>
                </div>
            `;
        }
        
        function buildModalFooter() {
            return `
                <div class="bg-gray-50 px-6 py-4 rounded-b-lg border-t">
                    <button onclick="closeFeedbackBank()" 
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-times mr-2"></i>Cerrar
                    </button>
                </div>
            `;
        }

        // Insertar retroalimentación en el textarea
        // Formatear texto de IA con estructura y negritas
        function formatAIText(text) {
            if (!text) return text;
            
            // Convertir markdown **TEXTO** a formato legible con líneas separadoras
            let formatted = text;
            
            // Reemplazar **TITULO:** con formato mejorado
            formatted = formatted.replace(/\*\*([A-ZÃÉÃÃ“Ãš\s]+):\*\*/g, '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ–¶ $1:\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
            
            // Reemplazar **Subtítulo** (sin dos puntos) con formato
            formatted = formatted.replace(/\*\*([A-Z][^:*]+)\*\*/g, '\nâ–¸ $1\n');
            
            // Limpiar dobles saltos de línea excesivos
            formatted = formatted.replace(/\n{3,}/g, '\n\n');
            
            // Agregar espaciado después de listas numeradas
            formatted = formatted.replace(/\((\d+)\)/g, '\n  ($1)');
            
            // Agregar espaciado en puntos principales
            formatted = formatted.replace(/\n•\s/g, '\n  • ');
            
            return formatted.trim();
        }
        
        function insertFeedback(text) {
            const textarea = document.getElementById(`studentNotes_${currentStudentIndexForFeedback}`);
            const currentText = textarea.value;
            
            // Formatear el texto antes de insertar
            const formattedText = formatAIText(text);
            
            // Agregar con salto de línea si ya hay texto
            if (currentText.trim()) {
                textarea.value = currentText + '\n\n' + formattedText;
            } else {
                textarea.value = formattedText;
            }
            
            // Auto-ajustar altura del textarea
            autoResizeTextarea(textarea);
            
            // Guardar automáticamente
            saveStudentNotes(currentStudentIndexForFeedback, textarea.value);
            
            // Feedback visual
            const originalText = text.substring(0, 50) + '...';
            showTemporaryMessage(`✅ Retroalimentación insertada y formateada: "${originalText}"`);
        }

        // Generar retroalimentación completa automática
        function generateCompleteFeedback(level, studentName, percentage, points, totalTasks) {
            const bank = feedbackData;
            const feedbacks = bank.retroalimentaciones[level];
            const levelInfo = bank.rangos_rendimiento[level];
            
            // Seleccionar aleatoriamente una de cada categoría
            const general = feedbacks.generales[Math.floor(Math.random() * feedbacks.generales.length)];
            
            let completeFeedback = general.replace('{nombre}', studentName) + '\n\n';
            
            // Agregar específica si existe
            if (feedbacks.especificas) {
                const areas = Object.keys(feedbacks.especificas);
                const randomArea = areas[Math.floor(Math.random() * areas.length)];
                const especifica = feedbacks.especificas[randomArea][0];
                completeFeedback += especifica + '\n\n';
            }
            
            // Agregar sugerencia/estrategia/plan segÃºn nivel
            if (feedbacks.desafios) {
                completeFeedback += feedbacks.desafios[0];
            } else if (feedbacks.sugerencias) {
                completeFeedback += feedbacks.sugerencias[0];
            } else if (feedbacks.estrategias) {
                completeFeedback += feedbacks.estrategias[0];
            } else if (feedbacks.plan_mejora) {
                completeFeedback += feedbacks.plan_mejora[0];
            }
            
            // Agregar contexto del rendimiento
            completeFeedback += `\n\nðŸ“Š Resumen: Has completado ${points} de ${totalTasks} tareas (${percentage}%), alcanzando un nivel ${levelInfo.nivel}.`;
            
            insertFeedback(completeFeedback);
            closeFeedbackBank();
        }

        // Cerrar modal del banco
        function closeFeedbackBank() {
            document.getElementById('feedbackBankModal').style.display = 'none';
        }

        // Mostrar mensaje temporal
        function showTemporaryMessage(message) {
            const div = document.createElement('div');
            div.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
            div.innerHTML = message;
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transition = 'opacity 0.5s';
                setTimeout(() => div.remove(), 500);
            }, 3000);
        }

        // --- INTEGRACIÃ“N CON IA (GEMINI) ---

        // ðŸ”‘ API Key predeterminada (hardcodeada) - tu key personal siempre disponible
        const DEFAULT_GEMINI_API_KEY = 'AIzaSyDl3Gp320sAbpEeOPf217ryya-4E0QT984';

        // Guardar API Key de Gemini (opcional, solo si quieres usar otra diferente)
        function saveGeminiApiKey() {
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            if (apiKey) {
                setStorageItem('geminiApiKey', apiKey);
                showTemporaryMessage('✅ API Key guardada correctamente');
            } else {
                alert('Por favor ingresa una API Key válida');
            }
        }

        // Generar retroalimentación con IA (SISTEMA MULTI-IA CON FALLBACK)
        async function generateAIFeedback(level, studentName, percentage, points, totalTasks) {
            // Obtener API Key (opcional - el sistema funciona sin ella)
            const apiKey = getStorageItem('geminiApiKey') || DEFAULT_GEMINI_API_KEY;
            
            const focus = document.getElementById('aiFeedbackFocus').value;
            const loadingIndicator = document.getElementById('aiLoadingIndicator');
            const btnGenerate = document.getElementById('btnGenerateAI');
            
            // Mostrar indicador de carga
            loadingIndicator.style.display = 'block';
            btnGenerate.disabled = true;
            btnGenerate.classList.add('opacity-50', 'cursor-not-allowed');
            
            try {
                // Obtener contexto del estudiante
                const student = courseData.students[currentStudentIndexForFeedback];
                const oasAnalysis = await analyzeStudentOAs(student);
                const bank = feedbackData;
                const levelInfo = bank.rangos_rendimiento[level];
                
                // Construir el prompt para la IA
                const prompt = buildAIPrompt(
                    studentName, 
                    level, 
                    levelInfo, 
                    percentage, 
                    points, 
                    totalTasks, 
                    oasAnalysis, 
                    focus,
                    courseData
                );
                
                // Llamar al sistema multi-IA con fallback (SIEMPRE funciona)
                const feedback = await callAIwithFallback(
                    apiKey, 
                    prompt, 
                    level, 
                    studentName, 
                    percentage, 
                    oasAnalysis, 
                    focus
                );
                
                // Insertar la retroalimentación generada
                if (feedback) {
                    insertFeedback(feedback);
                    showTemporaryMessage('✅ Retroalimentación generada exitosamente');
                    closeFeedbackBank();
                }
                
            } catch (error) {
                console.error('Error generando retroalimentación:', error);
                // Ãšltimo fallback: usar generador simple
                const simpleFeedback = generateSmartFeedback(
                    level, 
                    studentName, 
                    percentage, 
                    await analyzeStudentOAs(courseData.students[currentStudentIndexForFeedback]), 
                    focus
                );
                insertFeedback(simpleFeedback);
                showTemporaryMessage('✅ Retroalimentación generada (modo offline)');
                closeFeedbackBank();
            } finally {
                // Ocultar indicador de carga
                loadingIndicator.style.display = 'none';
                btnGenerate.disabled = false;
                btnGenerate.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Construir prompt MEJORADO Y DETALLADO para la IA
        function buildAIPrompt(studentName, level, levelInfo, percentage, points, totalTasks, oasAnalysis, focus, courseData) {
            let prompt = `Eres un profesor experto de Lenguaje y Comunicación de Chile con 15 años de experiencia en Educación Media. Debes escribir una retroalimentación pedagógica profesional, específica y fundamentada curricularmente.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“Š CONTEXTO DEL ESTUDIANTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Nombre: ${studentName}
Curso: ${courseData.courseName}
Nivel de desempeño: ${levelInfo.nivel.toUpperCase()}
Porcentaje de logro: ${percentage}% (${points} de ${totalTasks} tareas completadas)
Rango de calificación: ${levelInfo.nota}

`;

            // Agregar análisis detallado de OAs
            if (oasAnalysis && (oasAnalysis.cumplidos.length > 0 || oasAnalysis.noCumplidos.length > 0)) {
                prompt += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸŽ¯ ANÃLISIS CURRICULAR (BASES CURRICULARES MINEDUC)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
                
                if (oasAnalysis.cumplidos.length > 0) {
                    prompt += `✅ OBJETIVOS DE APRENDIZAJE LOGRADOS (${oasAnalysis.cumplidos.length}):\n`;
                    oasAnalysis.cumplidos.forEach((oa, index) => {
                        if (index < 4) { // Máximo 4 para no saturar
                            prompt += `\n[${oa.codigo}] ${oa.unidad}:\n`;
                            prompt += `   Descriptor: ${oa.texto.substring(0, 180)}...\n`;
                            prompt += `   Evidencias: ${oa.tareas.join(', ')}\n`;
                        }
                    });
                    if (oasAnalysis.cumplidos.length > 4) {
                        prompt += `\n   + ${oasAnalysis.cumplidos.length - 4} OA(s) adicional(es) cumplido(s)\n`;
                    }
                    prompt += `\n`;
                }
                
                if (oasAnalysis.noCumplidos.length > 0) {
                    prompt += `âš ï¸ OBJETIVOS POR CONSOLIDAR (${oasAnalysis.noCumplidos.length}):\n`;
                    oasAnalysis.noCumplidos.forEach((oa, index) => {
                        if (index < 4) {
                            prompt += `\n[${oa.codigo}] ${oa.unidad}:\n`;
                            prompt += `   Descriptor: ${oa.texto.substring(0, 180)}...\n`;
                            prompt += `   Tareas descendidas: ${oa.tareas.join(', ')}\n`;
                        }
                    });
                    if (oasAnalysis.noCumplidos.length > 4) {
                        prompt += `\n   + ${oasAnalisis.noCumplidos.length - 4} OA(s) adicional(es) pendiente(s)\n`;
                    }
                    prompt += `\n`;
                }
            }

            // Enfoques pedagógicos detallados
            const enfoquesDetallados = {
                'general': `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“‹ ENFOQUE: RETROALIMENTACIÃ“N INTEGRAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Elabora una retroalimentación comprehensiva que:
• Reconozca logros específicos evidenciados en las tareas completadas
• Identifique áreas descendidas con precisión diagnóstica
• Establezca relaciones entre los OAs y las competencias comunicativas desarrolladas
• Proyecte próximos desafíos de aprendizaje basados en el perfil de egreso
• Incluya sugerencias pedagógicas concretas y contextualizadas`,

                'oas': `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸŽ¯ ENFOQUE: ANÃLISIS CURRICULAR POR OBJETIVOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Centra la retroalimentación en los Objetivos de Aprendizaje:
• Menciona explícitamente cada OA cumplido (usa los códigos: OA1, OA2, etc.)
• Explica cómo las tareas evidencian el logro de cada OA
• Detalla las brechas en los OAs no cumplidos
• Relaciona los OAs con habilidades del siglo XXI (pensamiento crítico, comunicación efectiva)
• Propone actividades remediales específicas para cada OA descendido`,

                'motivacional': `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ’ª ENFOQUE: RECONOCIMIENTO Y MOTIVACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Escribe con énfasis en el potencial y logros del estudiante:
• Inicia reconociendo fortalezas específicas demostradas en las tareas
• Usa lenguaje que empodere y genere autoconfianza académica
• Conecta los logros actuales con capacidades futuras
• Presenta las dificultades como oportunidades de crecimiento
• Proyecta expectativas positivas pero realistas sobre su trayectoria
• Termina con un desafío inspirador y alcanzable`,

                'estrategias': `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“– ENFOQUE: ESTRATEGIAS Y ACCIONES CONCRETAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Proporciona un plan de acción específico:
• Lista estrategias metacognitivas de comprensión lectora (inferencias, síntesis, evaluación)
• Sugiere técnicas de escritura recursiva (planificación-redacción-revisión)
• Recomienda organizadores gráficos específicos (mapas conceptuales, esquemas)
• Propone rutinas de estudio y gestión del tiempo
• Incluye recursos digitales o bibliográficos de apoyo
• Establece metas SMART (específicas, medibles, alcanzables, relevantes, temporales)`,

                'formativa': `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸŒ± ENFOQUE: EVALUACIÃ“N PARA EL APRENDIZAJE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Retroalimentación procesual y descriptiva:
• Usa lenguaje descriptivo en lugar de calificativo
• Enfócate en el proceso más que en el resultado final
• Identifica patrones de error para orientar la mejora
• Promueve la autorregulación y reflexión metacognitiva
• Sugiere estrategias de autoevaluación y coevaluación
• Establece próximos pasos claros en el continuo de aprendizaje
• Evita juicios absolutos, enfatiza el progreso incremental`
            };

            prompt += enfoquesDetallados[focus] || enfoquesDetallados['general'];

            prompt += `

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“ ESPECIFICACIONES DE REDACCIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ESTRUCTURA OBLIGATORIA:
1. Introducción contextualizada (2-3 oraciones sobre el desempeño general)
2. Análisis de OAs cumplidos con evidencias específicas de tareas
3. Identificación de OAs descendidos y diagnóstico de brechas
4. Orientaciones pedagógicas y/o estrategias concretas
5. Cierre proyectivo y motivacional

ESTILO Y TONO:
âœ“ Segunda persona (tÃº/tu) - Dirigirse directamente al estudiante
âœ“ Lenguaje técnico-pedagógico apropiado (Bases Curriculares, competencias, habilidades)
âœ“ Tono profesional pero cercano y empático
âœ“ Terminología MINEDUC: OAs, competencias comunicativas, perfil de egreso, evaluación formativa

CONTENIDO ESPECÃFICO:
âœ“ Citar códigos de OAs (ej: "Has demostrado logro del OA2 sobre...")
âœ“ Mencionar nombres exactos de tareas como evidencia
âœ“ Incluir vocabulario disciplinar: coherencia, cohesión, intertextualidad, análisis crítico, etc.
âœ“ Referenciar unidades curriculares trabajadas

EXTENSIÃ“N Y FORMATO:
âœ“ Entre 200-300 palabras (ni muy breve ni excesivamente extensa)
âœ“ Usar negrita para destacar conceptos clave: **OA1**, **comprensión lectora**, etc.
âœ“ Sin emojis (lenguaje profesional)
âœ“ Párrafos bien estructurados con conectores lógicos

PROHIBIDO:
âœ— Lenguaje informal o coloquial ("choro", "bacán", "está bien nomás")
âœ— Frases genéricas sin sustento ("sigue así", "esfuérzate más")
âœ— Errores ortográficos o gramaticales
âœ— Copiar literal fragmentos de OAs sin contextualizarlos
âœ— Usar más de 300 palabras

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸŽ¯ GENERA LA RETROALIMENTACIÃ“N PROFESIONAL AHORA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;

            return prompt;
        }

        // ============= SISTEMA MULTI-IA CON FALLBACK =============
        
        // Opción 1: Gemini Pro (Google - modelo correcto 2025)
        async function callGeminiAPI(apiKey, prompt) {
            try {
                // Modelo correcto: gemini-pro (no gemini-1.5-flash)
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;
                
                const requestBody = {
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.8,  // Mayor creatividad manteniendo coherencia
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 2048,  // Más tokens para retroalimentaciones detalladas
                        candidateCount: 1
                    }
                };
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error Gemini:', errorData);
                    throw new Error(errorData.error?.message || 'Error en Gemini API');
                }
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    return data.candidates[0].content.parts[0].text.trim();
                } else {
                    throw new Error('Respuesta inválida de Gemini');
                }
            } catch (error) {
                console.error('Gemini falló:', error);
                throw error;
            }
        }
        
        // Opción 2: HuggingFace (GRATIS - sin API Key necesaria)
        async function callHuggingFaceAPI(prompt) {
            try {
                const response = await fetch('https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inputs: prompt,
                        parameters: {
                            max_new_tokens: 800,  // Más tokens para retroalimentaciones completas
                            temperature: 0.85,  // Mayor creatividad
                            top_p: 0.95,
                            do_sample: true,
                            return_full_text: false,
                            repetition_penalty: 1.2  // Evitar repeticiones
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Error en HuggingFace API');
                }
                
                const data = await response.json();
                
                if (Array.isArray(data) && data[0]?.generated_text) {
                    return data[0].generated_text.trim();
                } else {
                    throw new Error('Respuesta inválida de HuggingFace');
                }
            } catch (error) {
                console.error('HuggingFace falló:', error);
                throw error;
            }
        }
        
        // Opción 3: Generador inteligente PROFESIONAL basado en plantillas pedagógicas avanzadas
        function generateSmartFeedback(level, studentName, percentage, oasAnalysis, focus) {
            const feedback = [];
            
            // ============ INTRODUCCIÃ“N CONTEXTUALIZADA ============
            const intros = {
                'excelente': [
                    `${studentName}, tu desempeño alcanza un nivel sobresaliente del ${percentage}%, lo cual evidencia un dominio excepcional de las competencias comunicativas desarrolladas en este período.`,
                    `Es destacable tu capacidad para integrar conocimientos disciplinares, aplicar estrategias de comprensión lectora avanzadas y producir textos coherentes y cohesionados.`,
                    `Tu trabajo demuestra autonomía intelectual y un pensamiento crítico desarrollado, características fundamentales para el perfil de egreso de la Educación Media.`
                ],
                'muy_bueno': [
                    `${studentName}, has alcanzado un muy buen nivel de desempeño con un ${percentage}%, lo que refleja una comprensión sólida de los objetivos de aprendizaje abordados.`,
                    `Tu trabajo demuestra capacidad de análisis, síntesis y aplicación de estrategias de lectura y escritura de manera efectiva, logrando cumplir con las expectativas curriculares establecidas.`,
                    `Se observa un compromiso constante con tu proceso formativo y una progresión favorable en el desarrollo de habilidades comunicativas complejas.`
                ],
                'bueno': [
                    `${studentName}, tu desempeño se sitÃºa en un nivel bueno con un ${percentage}%, alcanzando satisfactoriamente los aprendizajes esperados para este período.`,
                    `Has logrado desarrollar competencias comunicativas fundamentales, demostrando comprensión de textos literarios y no literarios, así como capacidad para producir textos coherentes.`,
                    `Tu trabajo evidencia esfuerzo y dedicación, y con mayor profundización en ciertos aspectos podrás alcanzar niveles superiores de desempeño.`
                ],
                'suficiente': [
                    `${studentName}, has alcanzado el nivel suficiente con un ${percentage}%, lo que indica que has logrado los aprendizajes mínimos establecidos en las Bases Curriculares.`,
                    `Si bien cumples con los objetivos básicos, existen oportunidades significativas para fortalecer tu comprensión lectora, producción textual y análisis crítico de discursos.`,
                    `Es fundamental que fortalezcamos juntos las bases conceptuales y procedimentales para asegurar un desarrollo progresivo y sostenido de tus competencias comunicativas.`
                ],
                'insuficiente': [
                    `${studentName}, tu desempeño actual del ${percentage}% indica que aÃºn no has alcanzado los aprendizajes mínimos esperados, lo cual requiere atención pedagógica inmediata.`,
                    `Es prioritario implementar un plan de acompañamiento personalizado que aborde las dificultades identificadas en comprensión lectora, producción textual y/o análisis crítico.`,
                    `Trabajaremos colaborativamente para cerrar estas brechas de aprendizaje mediante estrategias diferenciadas y apoyo focalizado en las áreas descendidas.`
                ],
                'deficiente': [
                    `${studentName}, tu desempeño del ${percentage}% refleja una situación crítica que demanda intervención pedagógica urgente y un compromiso renovado de tu parte.`,
                    `Las dificultades observadas impactan significativamente tu desarrollo académico y requieren un plan remedial intensivo con evaluación formativa continua.`,
                    `Es fundamental que asumas un rol activo en tu proceso de recuperación, solicitando apoyo oportuno y comprometiéndote con las actividades de nivelación propuestas.`
                ]
            };
            
            feedback.push((intros[level] || intros['suficiente']).join(' '));
            
            // ============ ANÃLISIS DETALLADO DE OAs ============
            if (oasAnalysis) {
                if (oasAnalysis.cumplidos.length > 0) {
                    feedback.push(`\n\n**OBJETIVOS DE APRENDIZAJE LOGRADOS:**\n`);
                    feedback.push(`Has demostrado competencia en ${oasAnalysis.cumplidos.length} objetivo(s) del currículum nacional, específicamente:`);
                    
                    oasAnalysis.cumplidos.forEach((oa, index) => {
                        if (index < 3) { // Máximo 3 OAs para no hacer muy largo
                            const oaDescripcion = oa.texto.substring(0, 120);
                            feedback.push(`\n• **${oa.codigo}** (${oa.unidad}): ${oaDescripcion}... | Evidencia: ${oa.tareas.slice(0, 2).join(', ')}`);
                        }
                    });
                    
                    if (oasAnalysis.cumplidos.length > 3) {
                        feedback.push(`\n• Y ${oasAnalysis.cumplidos.length - 3} objetivo(s) adicional(es) cumplido(s).`);
                    }
                }
                
                if (oasAnalysis.noCumplidos.length > 0) {
                    feedback.push(`\n\n**OBJETIVOS POR CONSOLIDAR:**\n`);
                    feedback.push(`Se identifican ${oasAnalysis.noCumplidos.length} objetivo(s) que requieren refuerzo pedagógico:`);
                    
                    oasAnalysis.noCumplidos.forEach((oa, index) => {
                        if (index < 3) {
                            const oaDescripcion = oa.texto.substring(0, 120);
                            feedback.push(`\n• **${oa.codigo}** (${oa.unidad}): ${oaDescripcion}... | Tareas descendidas: ${oa.tareas.slice(0, 2).join(', ')}`);
                        }
                    });
                    
                    if (oasAnalysis.noCumplidos.length > 3) {
                        feedback.push(`\n• Y ${oasAnalysis.noCumplidos.length - 3} objetivo(s) adicional(es) por trabajar.`);
                    }
                }
            }
            
            // ============ ESTRATEGIAS Y SUGERENCIAS SEGÃšN ENFOQUE ============
            const estrategias = {
                'general': `\n\n**ORIENTACIONES PEDAGÃ“GICAS:**\nPara continuar fortaleciendo tus competencias comunicativas, te sugiero: (1) Mantener una lectura sistemática y analítica de textos diversos, aplicando estrategias metacognitivas; (2) Practicar la escritura recursiva, revisando y editando tus producciones; (3) Participar activamente en instancias de diálogo argumentativo, fundamentando tus interpretaciones con evidencia textual; (4) Establecer conexiones intertextuales y contextuales en tus análisis literarios.`,
                
                'oas': `\n\n**PLAN DE TRABAJO POR OBJETIVOS:**\nSegÃºn las Bases Curriculares MINEDUC, los OAs descendidos requieren: (1) Revisión conceptual de los contenidos asociados mediante organizadores gráficos; (2) Aplicación guiada de estrategias de comprensión lectora (inferencias, síntesis, evaluación crítica); (3) Práctica de producción textual con retroalimentación formativa continua; (4) Evaluación procesual que permita monitorear tu progreso en cada competencia específica.`,
                
                'motivacional': `\n\n**RECONOCIMIENTO Y PROYECCIÃ“N:**\nTu trayectoria demuestra capacidad de superación y potencial para alcanzar niveles superiores de desempeño. Los logros alcanzados evidencian que cuando te comprometes con tu aprendizaje, los resultados son favorables. Te desafío a: (1) Reconocer tus fortalezas como punto de partida; (2) Establecer metas desafiantes pero alcanzables; (3) Perseverar ante las dificultades, entendiendo que el error es parte del proceso formativo; (4) Visualizarte como un lector y productor de textos competente y autónomo.`,
                
                'estrategias': `\n\n**ESTRATEGIAS CONCRETAS DE MEJORA:**\n1. **Comprensión lectora**: Aplica la estrategia SQA (Qué Sé, Qué quiero saber, Qué Aprendí) antes, durante y después de leer. Subraya ideas principales y elabora resÃºmenes progresivos.\n2. **Producción textual**: Utiliza el método de escritura recursiva (planificar-escribir-revisar-editar). Crea esquemas previos y revisa coherencia y cohesión.\n3. **Análisis crítico**: Cuestiona las intenciones del emisor, identifica sesgos ideológicos y contrasta mÃºltiples perspectivas.\n4. **Gestión del aprendizaje**: Establece rutinas de estudio, utiliza técnicas de memorización comprensiva y autoevalÃºa tu progreso semanalmente.`,
                
                'formativa': `\n\n**RETROALIMENTACIÃ“N PARA EL APRENDIZAJE:**\nTu proceso de aprendizaje es progresivo y requiere ajustes permanentes. Te invito a: (1) Reflexionar metacognitivamente sobre tus estrategias lectoras y escriturales, identificando qué te funciona y qué necesitas modificar; (2) Solicitar retroalimentación específica sobre tus producciones antes de entregarlas; (3) Revisar las rÃºbricas de evaluación para autoregular tu desempeño; (4) Participar en instancias de coevaluación con tus pares, enriqueciendo así tu perspectiva; (5) Mantener un portafolio de aprendizajes que documente tu evolución.`
            };
            
            feedback.push(estrategias[focus] || estrategias['general']);
            
            // ============ CIERRE MOTIVACIONAL Y PROYECTIVO ============
            const cierres = {
                'excelente': `\n\nTu compromiso con la excelencia académica es ejemplar. ContinÃºa desafiándote con lecturas complejas y producciones textuales que trasciendan lo escolar, proyectándote como un comunicador crítico y propositivo.`,
                'muy_bueno': `\n\nTu dedicación y progreso son evidentes. Mantén esta trayectoria ascendente, profundizando en los aspectos que aÃºn pueden perfeccionarse. El camino hacia la excelencia está al alcance de tu esfuerzo sostenido.`,
                'bueno': `\n\nHas construido bases sólidas. El siguiente paso es profundizar tu análisis crítico y diversificar tus estrategias lectoras y escriturales. Con mayor sistematicidad, alcanzarás niveles superiores de desempeño.`,
                'suficiente': `\n\nEstás en el umbral del desarrollo de competencias más complejas. Es el momento de intensificar tu compromiso y solicitar apoyo cuando lo necesites. Cada esfuerzo cuenta y te acerca a tus metas académicas.`,
                'insuficiente': `\n\nEste es un momento clave para revertir la situación. Cuenta con mi apoyo pedagógico y el de tus pares. Juntos trabajaremos para que recuperes la confianza y alcances los aprendizajes esperados.`,
                'deficiente': `\n\nLa recuperación es posible, pero requiere un compromiso inmediato y sostenido. No estás solo en este proceso: implementaremos un plan personalizado que respete tu ritmo pero exija tu máximo esfuerzo.`
            };
            
            feedback.push(cierres[level] || cierres['suficiente']);
            
            return feedback.join('');
        }
        
        // Función principal que intenta mÃºltiples métodos
        async function callAIwithFallback(apiKey, prompt, level, studentName, percentage, oasAnalysis, focus) {
            // Método 1: Intentar Gemini si hay API Key
            if (apiKey && apiKey.length > 20) {
                try {
                    showTemporaryMessage('🤖 Generando con Gemini Pro...');
                    const result = await callGeminiAPI(apiKey, prompt);
                    return result;
                } catch (error) {
                    console.warn('Gemini no disponible, probando HuggingFace...', error);
                }
            }
            
            // Método 2: Intentar HuggingFace (GRATIS, sin API Key)
            try {
                showTemporaryMessage('🤖 Generando con HuggingFace (gratis)...');
                const result = await callHuggingFaceAPI(prompt);
                return result;
            } catch (error) {
                console.warn('HuggingFace no disponible, usando generador inteligente...', error);
            }
            
            // Método 3: Generador inteligente (SIEMPRE funciona)
            showTemporaryMessage('✨ Generando retroalimentación personalizada...');
            return generateSmartFeedback(level, studentName, percentage, oasAnalysis, focus);
        }
    </script>

    <!-- Modal del Banco de Retroalimentaciones -->
    <div id="feedbackBankModal" class="modal">
        <div id="feedbackBankContent"></div>
    </div>

    </div> <!-- Cierre de #app-container para iOS fix -->
</body>
</html>

